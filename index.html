<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>MySparkList</title>

<style>
/* ========== Base Theme Variables ========== */
*{box-sizing:border-box}
:root{
  /* Theme surface + type */
  --bg: #f0f2f5;
  --card: #ffffff;
  --text: #1a1a1a;
  --muted: #6b7280;
  --accent: #2563eb;
  --ok: #16a34a; 
  --ok-strong: #22c55e;
  --danger: #ef4444;
  --danger-strong: #f87171;
  --border: #dcdfe3;
  --shadow: 0 6px 16px rgba(0,0,0,.08);
  --font-family: system-ui, sans-serif;
  --font-size: 16px;

  /* Glass system */
  --glass-tint: 255,255,255;
  --glass-alpha: 0.75;
  --glass-stroke: rgba(0,0,0,.08);
  --glass-shadow: 0 8px 28px rgba(0,0,0,.12);
  --glass-backdrop-sat: 150%;
  --glass-backdrop-blur: 8px;

  /* Sticky title chip backdrop */
  --header-backdrop: rgba(255,255,255,.75);
  --header-border: rgba(0,0,0,.08);

  /* Natural slide */
  --slide-duration: 800ms; /* default, adjustable */
  --slide-ease: cubic-bezier(.22,.61,.36,1); /* iOS-like */

  /* Completion Effects (Customizable) */
  --completion-duration: 900ms;
  --completion-ok-color: #16a34a;
  --completion-ok-strong-color: #22c55e;
  --completion-danger-color: #ef4444;
  --completion-danger-strong-color: #f87171;
  --completion-progress-color: #2563eb;
  --completion-progress-strong-color: #3b82f6;
  --completion-glow-spread: 6px;
  --scan-line-angle: 180deg; /* Default scan angle */
}

.dark{
  --bg:#0b0d10;
  --card:#0f1418;
  --text:#e6eef6;
  --muted:#9aa4b2;
  --accent:#0078d7;
  --ok:#22c55e;
  --ok-strong:#4ade80;
  --danger:#f87171;
  --danger-strong:#fecaca;
  --border:#1b2430;
  --shadow: 0 14px 36px rgba(0,0,0,.45);

  --glass-tint: 15,20,24;
  --glass-alpha: 0.55;
  --glass-stroke: rgba(255,255,255,.08);
  --glass-shadow: 0 18px 56px rgba(0,0,0,.55);
  --glass-backdrop-sat: 160%;
  --glass-backdrop-blur: 10px;

  --header-backdrop: rgba(10,14,18,.55);
  --header-border: rgba(255,255,255,.08);

  --completion-ok-color: #22c55e;
  --completion-ok-strong-color: #4ade80;
  --completion-danger-color: #f87171;
  --completion-danger-strong-color: #fecaca;
  --completion-progress-color: #3b82f6;
  --completion-progress-strong-color: #60a5fa;
}

/* ========== Global Layout ========== */
html,body{
  margin:0; height:100%;
  font-family:var(--font-family);
  font-size:var(--font-size);
  color:var(--text);
  background:var(--bg);
  line-height:1.4;
  position: relative;
  overflow: hidden;
}
body{
  display:flex; justify-content:center; align-items:center;
  padding:20px;
  transition:background .25s ease, color .25s ease;
  background-position:center center;
  background-repeat:no-repeat;
  background-size:auto;
  background-attachment:fixed;
  padding-bottom: 80px; 
}

/* ========== Glass Utility ========== */
.glass{
  background: rgba(var(--glass-tint), var(--glass-alpha));
  backdrop-filter: saturate(var(--glass-backdrop-sat)) blur(var(--glass-backdrop-blur));
  -webkit-backdrop-filter: saturate(var(--glass-backdrop-sat)) blur(var(--glass-backdrop-blur));
  border: 1px solid var(--glass-stroke);
  box-shadow: var(--glass-shadow);
  position: relative;
  overflow: hidden;
}
.glass, .glass *{ -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

/* ========== App Regions ========== */
.app{ width:100%; max-width:980px; display:flex; flex-direction:column; align-items:center; text-align:center; gap:20px; padding:20px; position:relative; z-index: 10; }

/* Sticky heading chip — behind bubbles & menu */
.title-wrap{ 
  position:sticky; top:10px; z-index:950; 
  padding:10px 16px; border-radius:14px; 
  transition: background .3s, border .3s, box-shadow .3s, backdrop-filter .3s;
}
.title-wrap.no-glass{
  background: transparent;
  backdrop-filter: none;
  -webkit-backdrop-filter: none;
  border: none;
  box-shadow: none;
}
.title-wrap h1{ 
  margin:0; font-size:28px; line-height:1.2; font-weight: 700; 
  transition: all .3s ease; 
  display: flex; align-items: center; justify-content: center; gap: 2px; 
}
.title-wrap.custom-logo h1 {
  font-size: 82px;
  margin-bottom: 12px;
}

/* Styling for specific logo themes */
#appTitle.logo-google span{ display:inline-block; }
#appTitle.logo-microsoft .ms-quad{ display:inline-block; font-size: 62px; width:62px; height:62px; margin-right:4px; }
#appTitle.logo-microsoft .ms-text{ margin-left: 10px; }

/* Primary card (task list) */
.card{ border-radius:16px; width:100%; overflow:hidden; display:flex; flex-direction:column; padding-bottom:10px; }

/* Add bar */
.addbar{ display:flex; gap:10px; padding:16px; border-bottom:1px solid var(--border); }
.addbar input[type="text"]{ flex:1; padding:12px 14px; border:1px solid var(--border); border-radius:10px; background:var(--bg); color:var(--text); outline:none; box-shadow:inset 0 1px 2px rgba(0,0,0,.05); }
.addbar button{ padding:12px 16px; border:1px solid var(--border); background:var(--accent); color:white; border-radius:10px; cursor:pointer; transition:all .15s; }
.addbar button:active{ transform:scale(0.96); filter:brightness(0.9); }

/* Task list */
ul#list{ margin:0; padding:0; list-style:none; text-align:left; width:100%; }
.item{ position:relative; display:grid; grid-template-columns:auto 1fr auto; align-items:baseline; gap:12px; padding:14px 16px; border-bottom:1px dashed var(--border); border-radius:12px; transition:box-shadow .2s, filter .2s, background .2s; background:transparent; overflow: hidden; }
.item:last-child{ border-bottom:none; }
.item[draggable="true"]{ cursor:grab; }
.item.dragging{ opacity:.6; }
.item input[type="checkbox"]{ 
  width:20px; height:20px; accent-color:var(--completion-ok-color); 
  touch-action:none; 
  -webkit-touch-callout: none; user-select: none;
}
.label{ display:flex; align-items:center; gap:10px; }
.text{ transition:.2s; }
.item.done .text{ color:var(--completion-ok-color); text-decoration:line-through; }
.badge{ font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid var(--border); color:var(--muted); }
.item.done .badge{ border-color:var(--completion-ok-color); color:var(--completion-ok-color); }

.item.in-progress {
    box-shadow: inset 0 0 0 2px var(--completion-progress-color);
}
.item.in-progress .badge {
    border-color: var(--completion-progress-color);
    color: var(--completion-progress-color);
}
.item.in-progress input[type="checkbox"] {
    accent-color: var(--completion-progress-color);
}

.remove{ background:transparent; border:1px solid var(--border); color:var(--danger); padding:6px 10px; border-radius:8px; cursor:pointer; transition:all .15s; }
.remove:active{ transform:scale(0.95); background:var(--border); }

/* Completion inset ring */
.item.done{ box-shadow: inset 0 0 0 2px var(--completion-ok-color), inset 0 0 0 var(--completion-glow-spread) color-mix(in srgb, var(--completion-ok-color) 10%, transparent); }
.item.done.pulse{ animation:innerRingPulse var(--completion-duration) ease-out; }
@keyframes innerRingPulse{ 0%{box-shadow:inset 0 0 0 10px color-mix(in srgb, var(--completion-ok-strong-color) 38%, transparent), inset 0 0 0 2px var(--completion-ok-color);} 45%{box-shadow:inset 0 0 0 var(--completion-glow-spread) color-mix(in srgb, var(--completion-ok-strong-color) 22%, transparent), inset 0 0 0 2px var(--completion-ok-color);} 100%{box-shadow:inset 0 0 0 var(--completion-glow-spread) color-mix(in srgb, var(--completion-ok-color) 10%, transparent), inset 0 0 0 2px var(--completion-ok-color);} }

.item.warn{ box-shadow: inset 0 0 0 2px var(--completion-danger-color), inset 0 0 0 var(--completion-glow-spread) color-mix(in srgb, var(--completion-danger-color) 10%, transparent); animation:innerWarnPulse var(--completion-duration) ease-out; }
@keyframes innerWarnPulse{ 0%{box-shadow:inset 0 0 0 10px color-mix(in srgb, var(--completion-danger-strong-color) 42%, transparent), inset 0 0 0 2px var(--completion-danger-color);} 55%{box-shadow:inset 0 0 0 var(--completion-glow-spread) color-mix(in srgb, var(--completion-danger-strong-color) 18%, transparent), inset 0 0 0 2px var(--completion-danger-color);} 100%{box-shadow: none;} }


/* Scan Line Effect Styles */
.item::after {
    content: '';
    position: absolute;
    inset: 0;
    z-index: 1; /* Position it above the item's background but below content */
    pointer-events: none;
    transform: translateY(-101%); /* Start off-screen */
    background: transparent;
}
.item.scan-effect-done::after {
    animation: scanLine var(--completion-duration) forwards cubic-bezier(.16,1,.3,1);
    background: linear-gradient(var(--scan-line-angle), transparent 0%, var(--completion-ok-strong-color) 50%, transparent 100%);
}
@keyframes scanLine {
    0% { transform: translateY(-100%) scaleY(1); }
    100% { transform: translateY(100%) scaleY(2.5); opacity: 0; }
}
.item.scan-effect-warn::after {
    animation: scanLineWarn var(--completion-duration) forwards ease-out;
    background: linear-gradient(var(--scan-line-angle), transparent 0%, var(--completion-danger-strong-color) 50%, transparent 100%);
}
@keyframes scanLineWarn {
    0% { transform: translateY(-100%) scaleY(1.5); }
    100% { transform: translateY(100%) scaleY(0); opacity: 0; }
}
.item.scan-effect-progress::after {
    animation: scanLine var(--completion-duration) forwards cubic-bezier(.16,1,.3,1);
    background: linear-gradient(var(--scan-line-angle), transparent 0%, var(--completion-progress-strong-color) 50%, transparent 100%);
}


/* Control bar */
.controls {
  width: 100%;
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  align-items: center;
  margin-top: 8px;
  gap: 10px;
  padding: 8px 10px;
  border-radius: 14px;
}
button.ctrl{ border:none; border-radius:12px; padding:10px 14px; cursor:pointer; transition:all .15s; display: flex; align-items: center; justify-content: center; }
.clear-btn{ background:#111827; color:#f3f4f6; box-shadow:var(--shadow); }
.dark-toggle{ background:var(--card); color:var(--text); border:1px solid var(--border); box-shadow:var(--shadow); justify-self: center; }
.menu-btn{ background:var(--accent); color:#fff; box-shadow:var(--shadow); justify-self: end; }
.menu-btn svg { width: 20px; height: 20px; fill: currentColor; }


/* New Control Button Styles */
.clear-controls-container { display: flex; gap: 8px; justify-self: start; }
button.ctrl.clear-checks-btn { background: var(--accent); color: #fff; box-shadow:var(--shadow); }
button.ctrl.clear-list-btn-red { 
  background: var(--danger); color: #fff; box-shadow:var(--shadow); 
  font-size: 20px; line-height: 1; padding: 10px 12px;
}

/* Canvases */
#bubblesCanvas, #ambianceCanvas{ position:fixed; inset:0; pointer-events:none; }
#bubblesCanvas { z-index:1001; }
#ambianceCanvas { z-index: 5; }

/* ========== Settings Menu ========== */
.menu-panel{ position:fixed; top:78px; right:20px; border-radius:12px; padding:14px; width:540px; display:none; z-index:1100; max-height:calc(100vh - 100px); overflow:auto; -webkit-overflow-scrolling:touch; }
.menu-panel .section{ border:1px solid var(--border); border-radius:10px; overflow:hidden; margin-bottom:10px; }
.menu-panel details{ background:transparent; }
.menu-panel summary{ 
  list-style:none; cursor:pointer; padding:12px 14px; 
  outline:none; display:flex; align-items:center; justify-content:space-between; 
  gap:12px; font-weight:700; background:rgba(128,128,128,0.08);
  border-radius: 8px; transition: background .2s;
}
.menu-panel summary:hover{ background:rgba(128,128,128,0.12); }
.menu-panel details[open] > summary {
  border-bottom-left-radius: 0;
  border-bottom-right-radius: 0;
}
.menu-panel summary::-webkit-details-marker{ display:none; }
.menu-panel summary .hint{ font-weight:400; color:var(--muted); font-size:12px; }
.menu-panel .content{ padding:10px 12px 14px; border-top:1px solid var(--border); display:flex; flex-direction:column; gap:10px; }
.menu-panel label{ text-align:left; font-size:14px; }
.slider-row{ display:flex; align-items:center; gap:10px; }
.slider-row label{ min-width:148px; }
.slider-row input[type=range]{ flex:1; }
.slider-row input[type=number]{ width: 70px; padding: 4px 6px; background: var(--bg); color: var(--text); border: 1px solid var(--border); }
.pct{ min-width:48px; text-align:right; font-size:12px; color:var(--muted); }
.menu-panel button, .menu-panel select, .menu-panel input{ border-radius:8px; border:1px solid var(--border); }
.menu-panel button{ padding:8px 10px; font-size:12px; background:var(--accent); color:#fff; cursor:pointer; transition:all .15s; }
.menu-panel input[type=text] { padding: 6px 8px; background:var(--bg); color:var(--text); }
.menu-panel input[type=color] { min-height: 32px; padding: 2px; }
.menu-panel .helper{ font-size:12px; color:var(--muted); }

/* Sub-category styling */
.sub-section-wrapper { display:flex; flex-direction:column; gap:10px; padding-top:10px; }
.sub-section { border:1px solid var(--border); border-radius:10px; overflow:hidden; }
.sub-section summary {
    font-weight: 600;
    font-size: 14px;
    background: rgba(128,128,128,0.04);
    padding: 10px 12px;
}
.sub-section summary:hover { background: rgba(128,128,128,0.08); }

/* Patterns List */
.patterns-list .pattern-item{ display:flex; justify-content:space-between; align-items:center; gap:8px; padding:6px; border-radius:6px; }
.patterns-list .pattern-item:nth-child(odd){ background:rgba(128,128,128,0.05); }
.patterns-list .pattern-name{ font-size:14px; flex-grow:1; text-align:left; }
.patterns-list button{ font-size:11px; padding:4px 8px; }
.patterns-list .delete-btn{ background:var(--danger); }

/* Bottom close button (no notch) + footnote (reduced spacing) */
.menu-notch{
  position:sticky; bottom:0;
  display:flex; flex-direction:column; justify-content:center; align-items:center;
  padding:12px 0 2px; margin-top:8px; gap:8px;
}
.menu-notch button{
  border:none; cursor:pointer; font-weight:600;
  padding:12px 16px; border-radius:999px;
  background:var(--card); color:var(--text);
  border:1px solid var(--border); box-shadow:var(--shadow);
}
.menu-footnote{ font-size:12px; color:var(--muted); letter-spacing:0.2px; margin-bottom:0; }

/* Overlays (Counters, Clock) */
.counter-display, .click-counter, .clock-display{ position:fixed; padding:8px 12px; border-radius:12px; z-index:1100; }
.counter-display button{ padding:6px 8px; border-radius:6px; border:1px solid var(--border); background:var(--accent); color:#fff; cursor:pointer; font-size:12px; }

/* Positional classes for overlays */
.pos-top-left{ top:10px; left:10px; }
.pos-top-center{ top:10px; left:50%; transform:translateX(-50%); }
.pos-top-right{ top:10px; right:20px; }
.pos-bottom-left{ bottom:10px; left:10px; }
.pos-bottom-center{ bottom:10px; left:50%; transform:translateX(-50%); }
.pos-bottom-right{ bottom:10px; right:10px; }

.click-counter.pos-top-right{ top:60px; }
.counter-display{ display:flex; align-items:center; gap:8px; }

/* Version tag */
.version {
    position: fixed;
    bottom: 4px;
    right: 6px;
    font-size: 10px;
    color: var(--muted);
    opacity: 0.7;
    z-index: 1000;
    pointer-events: none;
}

/* Responsiveness */
@media (max-width:600px){
  .menu-panel{ right:8px; left:8px; width:auto; top:70px; bottom:8px; max-height:none; }
  .app{ padding:12px; gap: 16px; }
  .title-wrap.custom-logo h1 { font-size: 56px; }
  body { padding: 10px; padding-bottom: 70px; }
  .addbar { padding: 12px; gap: 8px; }
  .addbar input[type="text"] { padding: 10px 12px; }
  .addbar button { padding: 10px 14px; }
  .item { padding: 12px 14px; gap: 10px; }
  .controls { padding: 6px 8px; gap: 8px; margin-top: 0; }
  button.ctrl { padding: 8px 12px; }
  .menu-panel { padding: 12px; }
  .menu-panel summary { padding: 10px 12px; }
  .menu-panel .content { padding: 8px 10px 12px; gap: 8px; }
  .slider-row label { flex-shrink: 0; min-width: auto; }
  .menu-notch { padding: 10px 0 6px; margin-top: 8px; gap: 6px; }
  .menu-notch button { padding: 10px 14px; }
  .menu-footnote { font-size: 11px; margin-bottom: 0; }
  .counter-display, .click-counter, .clock-display { padding: 6px 10px; border-radius: 10px; }
  .counter-display button { padding: 4px 6px; font-size: 11px; }
  .version { font-size: 9px; bottom: 3px; right: 5px; }
  :root { --font-size: 15px; --glass-backdrop-blur: 6px; }
}

:focus-visible{ outline:2px solid var(--accent); outline-offset:2px; border-radius:8px; }
.row{ display:flex; gap:8px; align-items:center; }
.stack{ display:flex; flex-direction:column; gap:8px; }
.hr{ border:none; border-top:1px solid var(--border); margin:6px 0; }

/* ========== Natural Slide Animations ========== */
.item.slide-enter{ opacity:0; transform:translateY(10px); }
.item.slide-enter-active{ transition: opacity var(--slide-duration) var(--slide-ease), transform var(--slide-duration) var(--slide-ease); opacity:1; transform:translateY(0); }
.item.slide-out{ transition: opacity var(--slide-duration) var(--slide-ease), transform var(--slide-duration) var(--slide-ease); opacity:0; transform:translateX(14px); }
.item.collapsing{ overflow:hidden; height:0 !important; padding-top:0 !important; padding-bottom:0 !important; margin:0 !important; border:0 !important; }

/* Card scroll on mobile/long lists */
.card { max-height: calc(100vh - 220px); overflow-y: auto; -webkit-overflow-scrolling: touch; }
@media (max-width:600px){
  .card { max-height: calc(100vh - 235px); }
}

/* ========== Welcome Prompt ========== */
.welcome-overlay {
  position: fixed;
  inset: 0;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 2000;
  opacity: 0;
  transition: opacity 0.3s ease;
  pointer-events: none;
}
.welcome-overlay.visible {
    opacity: 1;
    pointer-events: auto;
}
.welcome-prompt {
  background: var(--card);
  padding: 30px;
  border-radius: 16px;
  max-width: 600px;
  width: 90%;
  text-align: center;
  transform: scale(0.95);
  transition: transform 0.3s ease;
  position: relative;
}
.welcome-prompt .remove {
    position: absolute;
    top: 15px;
    right: 15px;
}
.welcome-overlay.visible .welcome-prompt {
    transform: scale(1);
}
.welcome-prompt h2 {
  margin-top: 0;
  font-size: 24px;
}
.welcome-prompt p {
  color: var(--muted);
  margin-bottom: 24px;
}
.list-type-options {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}
.list-type-option {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
  cursor: pointer;
  transition: all 0.2s ease;
}
.list-type-option:hover {
  background: var(--accent);
  color: white;
  border-color: var(--accent);
}
.list-type-option h3 {
  margin: 0 0 8px 0;
  font-size: 16px;
}
.list-type-option p {
  font-size: 12px;
  color: var(--muted);
  margin: 0;
}
.list-type-option:hover p {
  color: rgba(255, 255, 255, 0.8);
}
.list-name-prompt {
    display: flex;
    flex-direction: column;
    gap: 12px;
}
.list-name-prompt input {
    padding: 12px 14px;
    border: 1px solid var(--border);
    border-radius: 10px;
    background: var(--bg);
    color: var(--text);
    outline: none;
    box-shadow: inset 0 1px 2px rgba(0,0,0,.05);
    font-size: 16px;
}
.list-name-prompt button {
    padding: 12px 16px;
    border: 1px solid var(--border);
    background: var(--accent);
    color: white;
    border-radius: 10px;
    cursor: pointer;
    transition: all .15s;
    font-size: 16px;
}
.welcome-back-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
    width: 100%;
}
.welcome-back-options button {
    padding: 12px 16px;
    border: 1px solid var(--border);
    border-radius: 10px;
    cursor: pointer;
    transition: all .15s;
    font-size: 16px;
    font-weight: 600;
}
.welcome-back-options .resume-btn {
    background: var(--accent);
    color: white;
}
.welcome-back-options .create-new-btn {
    background: var(--bg);
    color: var(--text);
}
.welcome-back-options .start-fresh-btn {
    background: transparent;
    color: var(--danger);
    border-color: var(--danger);
}
.dismiss-prompt-row {
    margin-top: 24px;
    text-align: center;
}
.dismiss-prompt-row label {
    font-size: 14px;
    color: var(--muted);
    cursor: pointer;
}

/* ========== Multi-list Tabs ========== */
.tab-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  display: flex;
  align-items: center;
  gap: 12px;
  z-index: 1050;
  padding: 12px;
  max-width: 1020px;
  margin: 0 auto;
}
.tabs-wrapper {
    flex: 1; /* take up all available space */
    min-width: 0; /* crucial for flex shrinking */
    mask-image: linear-gradient(to right, black, black);
    -webkit-mask-image: linear-gradient(to right, black, black);
    transition: mask-image 0.2s ease, -webkit-mask-image 0.2s ease;
}
.tabs-wrapper.fade-right {
    mask-image: linear-gradient(to right, black calc(100% - 40px), transparent);
    -webkit-mask-image: linear-gradient(to right, black calc(100% - 40px), transparent);
}
.tabs-wrapper.fade-left {
    mask-image: linear-gradient(to right, transparent, black 40px);
    -webkit-mask-image: linear-gradient(to right, transparent, black 40px);
}
.tabs-wrapper.fade-both {
    mask-image: linear-gradient(to right, transparent, black 40px, black calc(100% - 40px), transparent);
    -webkit-mask-image: linear-gradient(to right, transparent, black 40px, black calc(100% - 40px), transparent);
}

.tabs-container {
  display: flex;
  gap: 8px;
  overflow-x: auto;
  overflow-y: hidden;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
  padding-bottom: 15px;
  margin-bottom: -15px;
  padding-left: 4px; /* Fix for outline cutoff */
  padding-right: 4px; /* Fix for outline cutoff */
}
.tabs-container::-webkit-scrollbar { display: none; }

.tab {
  background: var(--card);
  border: 1px solid var(--border);
  padding: 8px 16px;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s ease;
  font-weight: 600;
  display: flex;
  align-items: center;
  flex-shrink: 0;
  white-space: nowrap;
  user-select: none;
  -webkit-user-select: none;
}
.tab.active {
  background: var(--accent);
  color: white;
  border-color: var(--accent);
  outline: 2px solid color-mix(in srgb, var(--accent) 50%, transparent);
  outline-offset: 2px;
}
.add-tab-btn {
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  font-size: 24px;
  line-height: 36px;
  cursor: pointer;
  box-shadow: var(--shadow);
  flex-shrink: 0;
}


/* ========== Tab Context Menu ========== */
#tabContextMenu {
    position: fixed;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    box-shadow: var(--shadow);
    z-index: 3000;
    padding: 6px;
    display: none; /* Initially hidden */
    flex-direction: column;
    gap: 4px;
    min-width: 160px;
    visibility: hidden;
    opacity: 0;
    transform: translateY(5px);
    transition: opacity .15s ease, transform .15s ease, visibility .15s;
}
#tabContextMenu.visible {
    display: flex;
    visibility: visible;
    opacity: 1;
    transform: translateY(0);
}
.context-menu-item {
    padding: 8px 12px;
    cursor: pointer;
    border-radius: 6px;
    font-size: 14px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: background 0.15s ease, color 0.15s ease;
}
.context-menu-item:hover {
    background: var(--accent);
    color: white;
}
.context-menu-item.danger:hover {
    background: var(--danger);
}
.context-color-input {
    opacity: 0; width: 0; height: 0; padding: 0; border: none;
    position: absolute; right: 12px;
}

/* Workflow Stages Styling */
#workflowStagesList .row {
    padding: 6px;
    border-radius: 6px;
    align-items: center;
}
#workflowStagesList .row:nth-child(odd) {
    background: rgba(128,128,128,0.05);
}
#workflowStagesList .row span {
    flex-grow: 1;
    text-align: left;
    font-size: 14px;
}
#workflowStagesList .row button {
    font-size: 11px;
    padding: 4px 8px;
}

/* PDF Export Styling */
.pdf-preview-container {
    margin-top: 10px;
}
#pdfPreview {
    width: 100%;
    height: 250px; /* A bit more height for a better preview */
    border: 1px solid var(--border);
    border-radius: 8px;
    background-color: var(--bg);
}
</style>
</head>
<body>
  <div class="welcome-overlay" id="welcomeOverlay">
    <div class="welcome-prompt glass" id="welcomePrompt">
      <button class="remove" id="closePromptBtn" style="display: none;">✖</button>
      <div id="listTypeStep">
          <h2 id="welcomeTitle">Welcome to MySparkList!</h2>
          <p id="welcomeSubText">What kind of list are you creating today?</p>
          <div class="list-type-options">
            <div class="list-type-option" data-type="General Tasks">
              <h3>General Tasks</h3>
              <p>Cleaning, daily to-dos, errands, etc.</p>
            </div>
            <div class="list-type-option" data-type="Milestones">
              <h3>Milestones</h3>
              <p>Life goals, long-term objectives, etc.</p>
            </div>
            <div class="list-type-option" data-type="Educational">
              <h3>Educational</h3>
              <p>Study topics, learning goals, etc.</p>
            </div>
            <div class="list-type-option" data-type="Call Behaviors">
              <h3>Call Behaviors</h3>
              <p>For call center agents and support.</p>
            </div>
            <div class="list-type-option" data-type="Workflow">
              <h3>Workflow / Staged Tasks</h3>
              <p>For projects, multi-step tasks, or any process you want to track with more detail.</p>
            </div>
          </div>
      </div>
      <div id="listNameStep" style="display: none;">
          <button class="remove" id="backToListTypeBtn" aria-label="Go back">✖</button>
          <h2>Name Your List</h2>
          <p id="listNamePromptText">Give your new list a name.</p>
          <div class="list-name-prompt">
              <input type="text" id="newListNameInput" placeholder="E.g., 'Weekly Chores'">
              <button id="createListBtn">Create List</button>
          </div>
      </div>
    </div>
  </div>

  <div class="welcome-overlay" id="welcomeBackOverlay">
    <div class="welcome-prompt glass">
        <h2>Welcome Back to MySparkList!</h2>
        <p>What would you like to do?</p>
        <div class="welcome-back-options">
            <button id="resumeBtn" class="resume-btn">Resume Current Lists</button>
            <button id="createNewBtn" class="create-new-btn">Create a New List</button>
            <button id="startFreshBtn" class="start-fresh-btn">Start Fresh (Delete All)</button>
        </div>
        <div class="dismiss-prompt-row">
            <label><input type="checkbox" id="hideWelcomeBack"> Don't show this again</label>
        </div>
    </div>
  </div>

  <canvas id="ambianceCanvas"></canvas>

  <div class="app" id="app">
    <div class="title-wrap glass" id="titleWrap"><h1 id="appTitle">MySparkList</h1></div>

    <main class="card glass" role="main" aria-label="Checklist">
      <div class="addbar">
        <input id="newItem" type="text" placeholder="Add an item…" aria-label="New item" />
        <button id="addBtn" aria-label="Add item">Add</button>
      </div>
      <ul id="list" aria-live="polite"></ul>
    </main>

    <canvas id="bubblesCanvas"></canvas>

    <div class="controls glass" id="controlsBar">
      <div class="clear-controls-container" id="clearControlsContainer">
        <!-- Buttons are now dynamically added here by JavaScript -->
      </div>
      <button id="darkToggle" class="ctrl dark-toggle">🌙 Dark</button>
      <div style="justify-self: end; display: flex; gap: 8px;">
        <button id="shareBtn" class="ctrl menu-btn" aria-label="Share List">
            <svg xmlns="http://www.w3.org/2000/svg" style="width: 20px; height: 20px; fill: currentColor;" viewBox="0 0 24 24"><path d="M18,16.08C17.24,16.08 16.56,16.38 16.04,16.85L8.91,12.7C8.96,12.47 9,12.24 9,12C9,11.76 8.96,11.53 8.91,11.3L16.04,7.15C16.56,7.62 17.24,7.92 18,7.92C19.66,7.92 21,6.58 21,5C21,3.42 19.66,2 18,2C16.34,2 15,3.42 15,5C15,5.24 15.04,5.47 15.09,5.7L7.96,9.85C7.44,9.38 6.76,9.08 6,9.08C4.34,9.08 3,10.42 3,12C3,13.58 4.34,15 6,15C6.76,15 7.44,14.62 7.96,14.15L15.09,18.3C15.04,18.53 15,18.76 15,19C15,20.58 16.34,22 18,22C19.66,22 21,20.58 21,19C21,17.42 19.66,16.08 18,16.08Z" /></svg>
        </button>
        <button id="menuBtn" class="ctrl menu-btn" aria-label="Open menu" aria-controls="menuPanel" aria-expanded="false">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" /></svg>
        </button>
      </div>
    </div>
  </div>

  <div class="tab-bar" id="tabBar">
    <div class="tabs-wrapper">
      <div class="tabs-container" id="tabsContainer"></div>
    </div>
    <button class="add-tab-btn" id="addTabBtn">+</button>
  </div>

  <div id="tabContextMenu">
    <div class="context-menu-item" id="ctxRename">Rename</div>
    <div class="context-menu-item" id="ctxSetColor">
        Set Color
        <input type="color" id="ctxColorInput" class="context-color-input">
    </div>
    <div class="context-menu-item" id="ctxShare">Share List</div>
    <div class="context-menu-item danger" id="ctxDelete">Delete List</div>
  </div>

  <div class="menu-panel glass" id="menuPanel" aria-hidden="true">

    <div class="section" id="secCheckmarkAnims">
        <details id="detailsCheckmarkAnims">
            <summary>
                Checkmark Animations <span class="hint">bubbles, wind & presets</span>
            </summary>
            <div class="content">
                <div class="sub-section-wrapper">
                    <div class="sub-section">
                        <details id="secAnimStyle">
                            <summary>
                                Animation Style <span class="hint">bubbles, splash, fireworks & more</span>
                            </summary>
                            <div class="content">
                                <div class="row">
                                    <label for="animationStyleSelect" style="min-width: 50px;">Style</label>
                                    <select id="animationStyleSelect" style="flex-grow: 1;">
                                        <option value="bubbles" selected>Bubbles</option>
                                        <option value="splash">Splash</option>
                                        <option value="fireworks">Fireworks</option>
                                        <option value="energy">Energy Pulse</option>
                                        <option value="boomerang">Boomerang</option>
                                        <option value="lightning">Lightning</option>
                                    </select>
                                </div>
                                <div class="row">
                                    <label for="animationPresetSelect" style="min-width: 50px;">Preset</label>
                                    <select id="animationPresetSelect" style="flex-grow: 1;">
                                        <option value="-1" disabled>-- Custom --</option>
                                    </select>
                                </div>
                                <div class="hr"></div>
                                <div class="slider-row">
                                    <label for="animIntensity" id="animIntensityLabel">Density</label>
                                    <input type="range" id="animIntensity" min="0" max="200" value="6" />
                                    <span class="pct" id="animIntensityPct">0%</span>
                                </div>
                                <div class="slider-row">
                                    <label for="emissionScale" id="emissionScaleLabel">Emission Scale</label>
                                    <input type="range" id="emissionScale" min="0" max="200" value="70" />
                                    <span class="pct" id="emissionScalePct">0%</span>
                                </div>
                                <div class="slider-row">
                                    <label for="holdRate">Hold Stream Rate</label>
                                    <input type="range" id="holdRate" min="0" max="100" value="35" />
                                    <span class="pct" id="holdRatePct">0%</span>
                                </div>
                                <div class="slider-row">
                                    <label for="bubbleSize" id="bubbleSizeLabel">Size</label>
                                    <input type="range" id="bubbleSize" min="1" max="20" value="6" />
                                    <span class="pct" id="bubbleSizePct">0%</span>
                                </div>
                                <div class="slider-row">
                                    <label for="bubbleSpeed" id="bubbleSpeedLabel">Pop</label>
                                    <input type="range" id="bubbleSpeed" min="0" max="24" value="6" />
                                    <span class="pct" id="bubbleSpeedPct">0%</span>
                                </div>
                                <div class="slider-row">
                                    <label for="bubbleLifeSlider">Life</label>
                                    <input type="range" id="bubbleLifeSlider" min="30" max="1200" value="90" />
                                    <input type="number" id="bubbleLifeSeconds" min="0.5" max="20" step="0.1" value="1.5" />
                                    <span class="pct" id="bubbleLifePct">s</span>
                                </div>
                                <div class="stack" id="shapeSelectRow">
                                    <label for="shapeSelect">Shape</label>
                                    <select id="shapeSelect">
                                        <option value="circle" selected>Circle</option>
                                        <option value="square">Square</option>
                                        <option value="triangle">Triangle</option>
                                        <option value="star">Star</option>
                                        <option value="heart">Heart</option>
                                        <option value="hexagon">Hexagon</option>
                                        <option value="boomerang">Boomerang</option>
                                        <option value="random">Random (mix)</option>
                                    </select>
                                </div>
                                <div class="stack" id="bubbleOutlineRow">
                                    <label for="bubbleOutline">Bubble Outline</label>
                                    <select id="bubbleOutline">
                                        <option value="none" selected>None</option>
                                        <option value="thinBlack">Thin Black</option>
                                        <option value="thinWhite">Thin White</option>
                                        <option value="accent">Accent Color</option>
                                        <option value="rainbow">Rainbow</option>
                                    </select>
                                </div>
                                <div class="stack">
                                    <label for="colorMode">Color Mode</label>
                                    <select id="colorMode">
                                        <option value="single">Single Color</option>
                                        <option value="fade" selected>Fade Start → End</option>
                                        <option value="tie">Tie-Dye (rainbow)</option>
                                        <option value="velocityHeatmap">Velocity Heatmap</option>
                                        <option value="screenSpace">Screen Space Rainbow</option>
                                        <option value="party">Party Mode</option>
                                    </select>
                                    <label id="singleColorRow">Single Color:
                                        <input type="color" id="bubbleColor" value="#16a34a" />
                                    </label>
                                    <label id="startColorRow">Start Color:
                                        <input type="color" id="bubbleStartColor" value="#16a34a" />
                                    </label>
                                    <label id="endColorRow">End Color:
                                        <input type="color" id="bubbleEndColor" value="#22c55e" />
                                    </label>
                                </div>
                                <div class="row">
                                    <label class="helper"><input type="checkbox" id="enableAnimations"> Enable Animations</label>
                                </div>
                                <div class="row">
                                    <label class="helper"><input type="checkbox" id="enableEndless"> Enable Hold-to-Stream</label>
                                </div>
                                <div class="row">
                                    <label class="helper"><input type="checkbox" id="containParticles"> Contain Particles (Bounce)</label>
                                </div>
                                <div class="row">
                                    <button id="resetAnimBtn" type="button" title="Reset bubble settings to default">Reset to Default</button>
                                </div>
                                <div class="helper">Settings % reflect how far you are across each slider’s range.</div>
                            </div>
                        </details>
                    </div>

                    <div class="sub-section">
                        <details id="secWind">
                            <summary>
                                Wind <span class="hint">directional flow, push-back & more</span>
                            </summary>
                            <div class="content">
                                <div class="row"><label class="helper"><input type="checkbox" id="enableWind"> Enable Wind</label></div>
                                <div class="hr"></div>
                                <label for="windPattern">Wind Pattern</label>
                                <select id="windPattern">
                                    <option value="steady" selected>Steady</option>
                                    <option value="sine">Sine Wave</option>
                                    <option value="gusts">Gusts</option>
                                    <option value="inward">All Sides Inward</option>
                                    <option value="push1">Push Back 1 (toward user)</option>
                                    <option value="push2">Push Back 2 (strong)</option>
                                    <option value="vortex">Vortex</option>
                                    <option value="crosswind">Crosswind</option>
                                </select>
                                <div class="slider-row" id="windIntensityRow">
                                    <label for="windIntensity">Intensity</label>
                                    <input type="range" id="windIntensity" min="0" max="100" value="30" />
                                    <span class="pct" id="windIntensityPct">0%</span>
                                </div>
                                <div class="slider-row" id="windDirectionRow">
                                    <label for="windDirection">Direction (°)</label>
                                    <input type="range" id="windDirection" min="0" max="360" value="0" />
                                    <span class="pct" id="windDirectionPct">0%</span>
                                </div>
                                <div class="helper">Use the Direction slider for Steady and Sine patterns. Other patterns have unique behaviors.</div>
                            </div>
                        </details>
                    </div>

                    <div class="sub-section">
                        <details id="secPatterns">
                            <summary>
                                Saved Patterns <span class="hint">save, load, import & export</span>
                            </summary>
                            <div class="content">
                                <div class="row">
                                    <input type="text" id="patternNameInput" placeholder="New pattern name..." style="flex-grow:1;">
                                    <button id="savePatternBtn">Save</button>
                                </div>
                                <div class="hr"></div>
                                <div id="patternsList" class="patterns-list stack">
                                    <div class="helper">No saved patterns yet.</div>
                                </div>
                                <div class="hr"></div>
                                <div class="row" style="justify-content: space-between;">
                                    <button id="importPatternsBtn">Import from File...</button>
                                    <button id="exportPatternsBtn">Export All to File</button>
                                </div>
                                <input type="file" id="importFile" accept=".json,application/json" style="display:none;">
                            </div>
                        </details>
                    </div>
                </div>
            </div>
        </details>
    </div>

    <div class="section" id="secAppearance">
      <details id="detailsAppearance">
        <summary>
          Appearance <span class="hint">UI, background & animations</span>
        </summary>
        <div class="content">
          
          <div class="sub-section">
            <details id="secUICustomizations">
                <summary>User Interface Customizations</summary>
                <div class="content">
                    <div class="stack">
                        <label for="uiStyleSelect">Style</label>
                        <select id="uiStyleSelect"></select>
                    </div>
                    <div id="opacityControlsWrapper" class="stack">
                        <div class="slider-row">
                          <label for="glassOpacity">Opacity</label>
                          <input type="range" id="glassOpacity" min="10" max="100" value="75" />
                          <span class="pct" id="glassOpacityPct">0%</span>
                        </div>
                         <div class="slider-row">
                          <label for="glassBlurSlider">Blur Intensity</label>
                          <input type="range" id="glassBlurSlider" min="0" max="20" value="8" />
                          <span class="pct" id="glassBlurPct">8px</span>
                        </div>
                        <div class="slider-row">
                          <label for="glassSaturationSlider">Backdrop Saturation</label>
                          <input type="range" id="glassSaturationSlider" min="50" max="200" value="150" />
                          <span class="pct" id="glassSaturationPct">150%</span>
                        </div>
                        <div class="slider-row">
                          <label for="glassBorderSlider">Border Opacity</label>
                          <input type="range" id="glassBorderSlider" min="0" max="100" value="8" />
                          <span class="pct" id="glassBorderPct">8%</span>
                        </div>
                    </div>
                    <div class="row">
                      <button id="uiStyleResetBtn" type="button" title="Reset UI Style and Opacity to default">Reset UI Style</button>
                    </div>
                    <div class="hr"></div>
                    <div class="row">
                       <label class="helper"><input type="checkbox" id="keepMenuExpanded"> Keep Menu Sections Expanded</label>
                    </div>
                    <div class="hr"></div>
                    <div class="stack">
                        <div class="row">
                           <label class="helper"><input type="checkbox" id="enableNaturalSlide"> Natural Slide Gestures</label>
                        </div>
                        <div class="slider-row">
                          <label for="slideSpeed">Slide Speed</label>
                          <input type="range" id="slideSpeed" min="200" max="1400" value="800" />
                          <span class="pct" id="slideSpeedPct">800ms</span>
                        </div>
                    </div>
                </div>
            </details>
          </div>

          <div class="sub-section">
            <details id="secCompletionEffect">
                <summary>Completion Effect</summary>
                <div class="content">
                    <div class="row">
                        <label for="completionCheckedColor" style="flex: 1;">Checked Color</label>
                        <input type="color" id="completionCheckedColor" value="#16a34a">
                    </div>
                    <div class="row">
                        <label for="completionUncheckedColor" style="flex: 1;">Unchecked Color</label>
                        <input type="color" id="completionUncheckedColor" value="#ef4444">
                    </div>
                    <div id="completionInProgressColorRow" class="row" style="display: none;">
                        <label for="completionInProgressColor" style="flex: 1;">In Progress Color</label>
                        <input type="color" id="completionInProgressColor" value="#2563eb">
                    </div>
                    <div class="slider-row">
                      <label for="completionGlow">Glow Intensity</label>
                      <input type="range" id="completionGlow" min="4" max="12" value="6" />
                      <span class="pct" id="completionGlowPct">6px</span>
                    </div>
                    <div class="slider-row">
                      <label for="completionSpeed">Animation Speed</label>
                      <input type="range" id="completionSpeed" min="300" max="1500" value="900" />
                      <span class="pct" id="completionSpeedPct">900ms</span>
                    </div>
                    <div class="row">
                       <label class="helper"><input type="checkbox" id="enableScanLine"> Enable Scan Line Effect</label>
                    </div>
                    <div class="slider-row" id="scanAngleControls" style="display:none;">
                      <label for="scanAngle">Scan Angle</label>
                      <input type="range" id="scanAngle" min="0" max="360" value="180" />
                      <span class="pct" id="scanAnglePct">180°</span>
                    </div>
                    <div class="row">
                      <button id="completionResetBtn" type="button">Reset to Default</button>
                    </div>
                </div>
            </details>
          </div>

          <div class="sub-section">
            <details id="secBackground">
                <summary>Background</summary>
                <div class="content">
                    <div class="stack">
                        <label><input type="checkbox" id="enableCustomBackground"> Enable Custom Background</label>
                    </div>
                    <div id="customBackgroundOptions" class="stack" style="display:none;">
                        <div class="hr"></div>
                        <div class="stack">
                            <label for="backgroundType">Background Type</label>
                            <select id="backgroundType">
                              <option value="theme" selected>Theme Default</option>
                              <option value="image">Image</option>
                              <option value="color">Color / Gradient</option>
                            </select>
                        </div>
                        <div id="imageWallpaperControls" class="stack" style="display:none; margin-top: 10px;">
                            <label for="wallpaperFile">Choose Image</label>
                            <input type="file" id="wallpaperFile" accept="image/jpeg,.jpg,.jpeg,image/png,image/webp,image/*" />
                            <div class="helper">Recommended: images under 5 MB for stability.</div>
                            <label for="wallpaperFit">Image Format</label>
                            <select id="wallpaperFit">
                              <option value="cover" selected>Cover (fill, crop)</option>
                              <option value="contain">Contain (fit inside)</option>
                              <option value="fill">Stretch to Fill</option>
                              <option value="center">Center (no scale)</option>
                              <option value="tile">Tile</option>
                            </select>
                            <div class="row">
                              <button id="wallpaperResetBtn" type="button" title="Remove custom wallpaper">Remove Image</button>
                            </div>
                        </div>
                        <div id="colorWallpaperControls" class="stack" style="display:none; margin-top: 10px;">
                            <label for="colorWallpaperType">Color Type</label>
                            <select id="colorWallpaperType">
                              <option value="solid">Solid</option>
                              <option value="gradient">Gradient</option>
                            </select>
                            <div id="solidColorControls" class="stack">
                              <label>Color: <input type="color" id="wallpaperColor1" value="#2c3e50"></label>
                            </div>
                            <div id="gradientColorControls" class="stack" style="display:none;">
                              <label>Start Color: <input type="color" id="wallpaperColor2" value="#3498db"></label>
                              <label>End Color: <input type="color" id="wallpaperColor3" value="#13223a"></label>
                              <div class="slider-row">
                                <label for="gradientAngle">Angle</label>
                                <input type="range" id="gradientAngle" min="0" max="360" value="145">
                                <span class="pct" id="gradientAnglePct">145°</span>
                              </div>
                              <div class="slider-row">
                                <label for="gradientSpread">Gradient Spread</label>
                                <input type="range" id="gradientSpread" min="0" max="100" value="0">
                                <span class="pct" id="gradientSpreadPct">0%</span>
                              </div>
                              <div class="hr"></div>
                              <label><input type="checkbox" id="gradientSpinToggle"> Enable Spinning</label>
                              <div class="slider-row" id="gradientSpinControls" style="display:none;">
                                  <label for="gradientSpinSpeed">Spin Speed</label>
                                  <input type="range" id="gradientSpinSpeed" min="1" max="100" value="10">
                                  <span class="pct" id="gradientSpinSpeedPct">10%</span>
                              </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="hr"></div>
    
                    <div class="stack">
                        <label><input type="checkbox" id="enableAmbiance"> Enable Background Live Effects</label>
                        <div id="ambianceSettings" class="stack" style="display:none; margin-top: 10px; gap: 10px;">
                            <label for="ambianceSelect">Effect Type</label>
                            <select id="ambianceSelect">
                                <option value="none" selected>None</option>
                                <option value="snowflakes">Snowflakes</option>
                                <option value="orbs">Floating Orbs</option>
                                <option value="starfield">Starfield</option>
                                <option value="matrix">Matrix Rain</option>
                            </select>
                            <div id="ambianceControls" class="stack" style="display:none; border:1px solid var(--border); border-radius:8px; padding:10px; gap: 10px;">
                                <div id="snowControls" class="stack" style="display:none; gap: 10px;">
                                    <div class="slider-row">
                                        <label for="snowDensity">Density</label>
                                        <input type="range" id="snowDensity" min="0" max="300" value="100">
                                        <span class="pct" id="snowDensityPct">0%</span>
                                    </div>
                                    <div class="slider-row">
                                        <label for="snowSize">Size</label>
                                        <input type="range" id="snowSize" min="10" max="40" value="20">
                                        <span class="pct" id="snowSizePct">0%</span>
                                    </div>
                                    <div class="slider-row">
                                        <label for="snowSpeed">Speed</label>
                                        <input type="range" id="snowSpeed" min="10" max="100" value="30">
                                        <span class="pct" id="snowSpeedPct">0%</span>
                                    </div>
                                </div>
                                <div id="orbsControls" class="stack" style="display:none; gap: 10px;">
                                    <div class="slider-row">
                                        <label for="orbsDensity">Density</label>
                                        <input type="range" id="orbsDensity" min="10" max="300" value="80">
                                        <span class="pct" id="orbsDensityPct">0%</span>
                                    </div>
                                    <div class="slider-row">
                                        <label for="orbsSize">Size</label>
                                        <input type="range" id="orbsSize" min="20" max="150" value="70">
                                        <span class="pct" id="orbsSizePct">0%</span>
                                    </div>
                                    <div class="slider-row">
                                        <label for="orbsSpeed">Speed</label>
                                        <input type="range" id="orbsSpeed" min="5" max="100" value="20">
                                        <span class="pct" id="orbsSpeedPct">0%</span>
                                    </div>
                                    <label>Orb Color: <input type="color" id="orbsColor" value="#9aa4b2"></label>
                                </div>
                                <div id="starfieldControls" class="stack" style="display:none; gap: 10px;">
                                    <div class="slider-row">
                                        <label for="starfieldDensity">Density</label>
                                        <input type="range" id="starfieldDensity" min="50" max="1500" value="500">
                                        <span class="pct" id="starfieldDensityPct">0%</span>
                                    </div>
                                    <div class="slider-row">
                                        <label for="starfieldSize">Size</label>
                                        <input type="range" id="starfieldSize" min="1" max="10" value="3">
                                        <span class="pct" id="starfieldSizePct">0%</span>
                                    </div>
                                    <div class="slider-row">
                                        <label for="starfieldSpeed">Speed</label>
                                        <input type="range" id="starfieldSpeed" min="1" max="100" value="25">
                                        <span class="pct" id="starfieldSpeedPct">0%</span>
                                    </div>
                                </div>
                                <div id="matrixControls" class="stack" style="display:none; gap: 10px;">
                                    <div class="slider-row">
                                        <label for="matrixDensity">Density</label>
                                        <input type="range" id="matrixDensity" min="10" max="300" value="100">
                                        <span class="pct" id="matrixDensityPct">0%</span>
                                    </div>
                                    <div class="slider-row">
                                        <label for="matrixSize">Size</label>
                                        <input type="range" id="matrixSize" min="8" max="24" value="14">
                                        <span class="pct" id="matrixSizePct">0%</span>
                                    </div>
                                    <div class="slider-row">
                                        <label for="matrixSpeed">Speed</label>
                                        <input type="range" id="matrixSpeed" min="5" max="100" value="40">
                                        <span class="pct" id="matrixSpeedPct">0%</span>
                                    </div>
                                    <label>Rain Color: <input type="color" id="matrixColor" value="#00ff47"></label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </details>
          </div>
        </div>
      </details>
    </div>

    <div class="section" id="secUtility">
        <details id="detailsUtility">
            <summary>
                Utility <span class="hint">counters, clock & factory reset</span>
            </summary>
            <div class="content">
                <div class="stack">
                    <label><input type="checkbox" id="enableSecCounter"> Second Counter</label>
                    <label><input type="checkbox" id="enableClickCounter"> Click Counter</label>
                    <button id="resetClickCounter" type="button">Reset Click Counter</button>
                </div>
                <div class="hr"></div>
                <div class="stack">
                    <label><input type="checkbox" id="enableClock"> Enable Clock</label>
                    <div id="clockOptionsWrapper" class="stack">
                        <label for="clockPosition">Position</label>
                        <select id="clockPosition">
                            <option value="pos-top-left">Top Left</option>
                            <option value="pos-top-center">Top Center</option>
                            <option value="pos-top-right" selected>Top Right</option>
                            <option value="pos-bottom-left">Bottom Left</option>
                            <option value="pos-bottom-center">Bottom Center</option>
                            <option value="pos-bottom-right">Bottom Right</option>
                        </select>
                        <label for="clockDetail">Detail Level</label>
                        <select id="clockDetail">
                            <option value="time">Time (HH:MM)</option>
                            <option value="timeSec">Time with Seconds (HH:MM:SS)</option>
                            <option value="dateTime" selected>Date &amp; Time</option>
                            <option value="full">Full Details</option>
                        </select>
                    </div>
                </div>
                <div class="hr"></div>
                <div class="stack">
                    <label><input type="checkbox" id="simpleModeToggle"> Simple Mode</label>
                    <div class="helper">Enable to simplify the UI and hide advanced customization options.</div>
                </div>
                <div class="hr"></div>
                <div class="sub-section">
                    <details id="secDevToolbox">
                        <summary>DevToolbox</summary>
                        <div class="content">
                            <div class="stack">
                                <button id="exportStateBtn" type="button">State Export</button>
                                <div class="helper">
                                    If you're encountering a bug, click "State Export" to download your current settings. Please email this file to 
                                    <a href="mailto:MySparkList.Contact@gmail.com">MySparkList.Contact@gmail.com</a>. 
                                    Allow up to 72 hours for troubleshooting and a response. This export does not include your list content.
                                </div>
                            </div>
                        </div>
                    </details>
                </div>
                <div class="hr"></div>
                <div class="sub-section" id="secWorkflowStages" style="display: none;">
                    <details id="detailsWorkflowStages">
                        <summary>Customize Workflow Stages</summary>
                        <div class="content stack">
                            <div id="workflowStagesList" class="stack"></div>
                            <div class="row">
                                <input type="text" id="newStageName" placeholder="New stage name..." style="flex-grow:1;">
                                <button id="addStageBtn">Add Stage</button>
                            </div>
                            <div class="row" style="margin-top: 8px;">
                                <button id="resetStagesBtn" type="button" style="flex-grow: 1;">Reset to Default</button>
                            </div>
                        </div>
                    </details>
                </div>
                <div class="hr"></div>
                <div class="sub-section">
                    <details id="secPdfExport">
                        <summary>PDF Export</summary>
                        <div class="content stack">
                            <div class="row">
                                <input type="text" id="pdfHeader" placeholder="Company / Header Text" style="flex-grow:1;">
                            </div>
                            <div class="row">
                                <input type="text" id="pdfAuthor" placeholder="Author Name" style="flex-grow:1;">
                            </div>
                            <div class="stack" style="margin-top: 8px; gap: 4px;">
                                <label for="pdfLogoUpload" class="helper" style="text-align: left; font-size: 13px;">Company Logo (Optional)</label>
                                <div class="row">
                                    <input type="file" id="pdfLogoUpload" accept="image/png, image/jpeg" style="flex-grow: 1;">
                                    <button id="pdfClearLogoBtn" type="button" style="display: none;">Clear</button>
                                </div>
                            </div>
                            <div class="row">
                                <label for="pdfTheme" style="min-width: 80px;">Theme</label>
                                <select id="pdfTheme" style="flex-grow:1;">
                                    <option value="striped">Striped</option>
                                    <option value="grid">Grid</option>
                                    <option value="plain">Plain</option>
                                </select>
                            </div>
                            <div class="row">
                                <label for="pdfAccentColor" style="min-width: 80px;">Accent</label>
                                <select id="pdfAccentColor" style="flex-grow:1;">
                                    <option value="#2563eb">Default Blue</option>
                                    <option value="#16a34a">Green</option>
                                    <option value="#ef4444">Red</option>
                                    <option value="#6b7280">Grey</option>
                                    <option value="#000000">Black</option>
                                </select>
                            </div>
                            <div class="stack">
                                <label class="helper"><input type="checkbox" id="pdfIncludeDate" checked> Include Date</label>
                                <div class="row">
                                    <label for="pdfIncludeTime" class="helper" style="flex: 1;"><input type="checkbox" id="pdfIncludeTime" checked> Include Time</label>
                                    <input type="text" id="pdfCustomTime" placeholder="auto" style="width: 100px; font-size: 12px;">
                                </div>
                                <label class="helper"><input type="checkbox" id="pdfIncludeAuthor" checked> Include Author</label>
                                <label class="helper"><input type="checkbox" id="pdfIncludeCheckboxes"> Include Checkboxes</label>
                            </div>
                            <div class="pdf-preview-container" style="display: none;">
                                <iframe id="pdfPreview" style="width: 100%; height: 250px;"></iframe>
                            </div>
                            <div class="row" style="justify-content: space-between;">
                                <div>
                                  <button id="showPreviewBtn" type="button">Show Preview</button>
                                  <button id="enlargePreviewBtn" type="button">Enlarge Preview</button>
                                </div>
                                <button id="downloadPdfBtn" type="button">Download PDF</button>
                            </div>
                        </div>
                    </details>
                </div>
                <div class="hr"></div>
                <button id="panicResetBtn" type="button" style="background:var(--danger);" title="Warning: This will clear all items and reset all settings to default.">Panic Reset to Factory Default</button>
                <div class="helper">Panic Reset clears everything (except saved patterns) and reloads the page. This action cannot be undone.</div>
            </div>
        </details>
    </div>

    <div class="menu-notch">
      <button id="closeMenuNotch" aria-controls="menuPanel" aria-label="Close menu">Close menu</button>
      <div class="menu-footnote" id="menuFootnote" aria-hidden="true">Designed for productivity. Made by Noa.</div>
    </div>
  </div>

  <div class="counter-display glass pos-top-right" id="secCounter" style="display:none">
    <span id="secCount">0 s</span>
    <button id="pauseCounter">Pause</button>
  </div>
  <div class="click-counter glass pos-top-right" id="clickCounter" style="display:none">
    Clicks: <span id="clickCount">0</span>
  </div>
  <div class="clock-display glass" id="clockDisplay" style="display:none;"></div>

  <div class="version" id="versionTag">v1.3.1</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

<script>
(function(){
  /* ---------- DOM GETTERS ---------- */
  const list = document.getElementById('list');
  const input = document.getElementById('newItem');
  const addBtn = document.getElementById('addBtn');
  const appTitle = document.getElementById('appTitle');
  const titleWrap = document.getElementById('titleWrap');

  const clearControlsContainer = document.getElementById('clearControlsContainer');
  const darkToggle = document.getElementById('darkToggle');
  const menuBtn = document.getElementById('menuBtn');
  const shareBtn = document.getElementById('shareBtn');
  const menuPanel = document.getElementById('menuPanel');
  const closeMenuNotch = document.getElementById('closeMenuNotch');
  
  // Welcome Prompt
  const welcomeOverlay = document.getElementById('welcomeOverlay');
  const welcomePrompt = document.getElementById('welcomePrompt');
  const welcomeTitle = document.getElementById('welcomeTitle');
  const welcomeSubText = document.getElementById('welcomeSubText');
  const closePromptBtn = document.getElementById('closePromptBtn');
  const listTypeStep = document.getElementById('listTypeStep');
  const listNameStep = document.getElementById('listNameStep');
  const listTypeOptions = document.querySelectorAll('.list-type-option');
  const newListNameInput = document.getElementById('newListNameInput');
  const createListBtn = document.getElementById('createListBtn');
  const backToListTypeBtn = document.getElementById('backToListTypeBtn');

  // Welcome Back Prompt
  const welcomeBackOverlay = document.getElementById('welcomeBackOverlay');
  const resumeBtn = document.getElementById('resumeBtn');
  const createNewBtn = document.getElementById('createNewBtn');
  const startFreshBtn = document.getElementById('startFreshBtn');
  const hideWelcomeBack = document.getElementById('hideWelcomeBack');

  // Tabs
  const tabBar = document.getElementById('tabBar');
  const tabsContainer = document.getElementById('tabsContainer');
  const addTabBtn = document.getElementById('addTabBtn');
  
  // Tab Context Menu
  const tabContextMenu = document.getElementById('tabContextMenu');
  const ctxRename = document.getElementById('ctxRename');
  const ctxSetColor = document.getElementById('ctxSetColor');
  const ctxColorInput = document.getElementById('ctxColorInput');
  const ctxShare = document.getElementById('ctxShare');
  const ctxDelete = document.getElementById('ctxDelete');

  // Animation Style
  const animationStyleSelect = document.getElementById('animationStyleSelect');
  const animationPresetSelect = document.getElementById('animationPresetSelect');
  const bubbleSpeedLabel = document.getElementById('bubbleSpeedLabel');
  const animIntensityLabel = document.getElementById('animIntensityLabel');
  const emissionScaleLabel = document.getElementById('emissionScaleLabel');
  const bubbleSizeLabel = document.getElementById('bubbleSizeLabel');
  const shapeSelectRow = document.getElementById('shapeSelectRow');
  const bubbleOutlineRow = document.getElementById('bubbleOutlineRow');

  // Bubbles core controls
  const animIntensity = document.getElementById('animIntensity');
  const emissionScale = document.getElementById('emissionScale');
  const holdRate = document.getElementById('holdRate');
  const bubbleSize = document.getElementById('bubbleSize');
  const bubbleSpeed = document.getElementById('bubbleSpeed');
  const bubbleLifeSlider = document.getElementById('bubbleLifeSlider');
  const bubbleLifeSeconds = document.getElementById('bubbleLifeSeconds');
  const enableAnimations = document.getElementById('enableAnimations');
  const enableEndless = document.getElementById('enableEndless');
  const resetAnimBtn = document.getElementById('resetAnimBtn');

  // Percent labels
  const pct = {
    anim: document.getElementById('animIntensityPct'),
    escale: document.getElementById('emissionScalePct'),
    hold: document.getElementById('holdRatePct'),
    size: document.getElementById('bubbleSizePct'),
    speed: document.getElementById('bubbleSpeedPct'),
    life: document.getElementById('bubbleLifePct'),
    windI: document.getElementById('windIntensityPct'),
    windDir: document.getElementById('windDirectionPct'),
    glass: document.getElementById('glassOpacityPct'),
    glassBlur: document.getElementById('glassBlurPct'),
    glassSaturation: document.getElementById('glassSaturationPct'),
    glassBorder: document.getElementById('glassBorderPct'),
    slide: document.getElementById('slideSpeedPct'),
    snowDensity: document.getElementById('snowDensityPct'),
    snowSize: document.getElementById('snowSizePct'),
    snowSpeed: document.getElementById('snowSpeedPct'),
    orbsDensity: document.getElementById('orbsDensityPct'),
    orbsSize: document.getElementById('orbsSizePct'),
    orbsSpeed: document.getElementById('orbsSpeedPct'),
    starfieldDensity: document.getElementById('starfieldDensityPct'),
    starfieldSize: document.getElementById('starfieldSizePct'),
    starfieldSpeed: document.getElementById('starfieldSpeedPct'),
    matrixDensity: document.getElementById('matrixDensityPct'),
    matrixSize: document.getElementById('matrixSizePct'),
    matrixSpeed: document.getElementById('matrixSpeedPct'),
    gradientAngle: document.getElementById('gradientAnglePct'),
    gradientSpread: document.getElementById('gradientSpreadPct'),
    gradientSpinSpeed: document.getElementById('gradientSpinSpeedPct'),
    completionGlow: document.getElementById('completionGlowPct'),
    completionSpeed: document.getElementById('completionSpeedPct')
  };

  // Color + shape controls
  const colorMode = document.getElementById('colorMode');
  const bubbleColor = document.getElementById('bubbleColor');
  const bubbleStartColor = document.getElementById('bubbleStartColor');
  const bubbleEndColor = document.getElementById('bubbleEndColor');
  const singleColorRow = document.getElementById('singleColorRow');
  const startColorRow = document.getElementById('startColorRow');
  const endColorRow = document.getElementById('endColorRow');
  const shapeSelect = document.getElementById('shapeSelect');
  const bubbleOutline = document.getElementById('bubbleOutline');

  // Wind controls
  const enableWind = document.getElementById('enableWind');
  const containParticles = document.getElementById('containParticles');
  const windPattern = document.getElementById('windPattern');
  const windIntensity = document.getElementById('windIntensity');
  const windDirection = document.getElementById('windDirection');
  const windDirectionRow = document.getElementById('windDirectionRow');

  // Appearance
  const uiStyleSelect = document.getElementById('uiStyleSelect');
  const opacityControlsWrapper = document.getElementById('opacityControlsWrapper');
  
  // Glass controls
  const glassOpacity = document.getElementById('glassOpacity');
  const glassBlurSlider = document.getElementById('glassBlurSlider');
  const glassSaturationSlider = document.getElementById('glassSaturationSlider');
  const glassBorderSlider = document.getElementById('glassBorderSlider');
  const uiStyleResetBtn = document.getElementById('uiStyleResetBtn');
  
  // Completion Effect Controls
  const completionCheckedColor = document.getElementById('completionCheckedColor');
  const completionUncheckedColor = document.getElementById('completionUncheckedColor');
  const completionInProgressColor = document.getElementById('completionInProgressColor');
  const completionInProgressColorRow = document.getElementById('completionInProgressColorRow');
  const completionGlow = document.getElementById('completionGlow');
  const completionSpeed = document.getElementById('completionSpeed');
  const completionResetBtn = document.getElementById('completionResetBtn');
  const enableScanLine = document.getElementById('enableScanLine');
  const scanAngle = document.getElementById('scanAngle');
  const scanAngleControls = document.getElementById('scanAngleControls');

  // Wallpaper
  const enableCustomBackground = document.getElementById('enableCustomBackground');
  const customBackgroundOptions = document.getElementById('customBackgroundOptions');
  const backgroundType = document.getElementById('backgroundType');
  const imageWallpaperControls = document.getElementById('imageWallpaperControls');
  const colorWallpaperControls = document.getElementById('colorWallpaperControls');
  const wallpaperFile = document.getElementById('wallpaperFile');
  const wallpaperFit = document.getElementById('wallpaperFit');
  const wallpaperResetBtn = document.getElementById('wallpaperResetBtn');
  const colorWallpaperType = document.getElementById('colorWallpaperType');
  const solidColorControls = document.getElementById('solidColorControls');
  const gradientColorControls = document.getElementById('gradientColorControls');
  const wallpaperColor1 = document.getElementById('wallpaperColor1');
  const wallpaperColor2 = document.getElementById('wallpaperColor2');
  const wallpaperColor3 = document.getElementById('wallpaperColor3');
  const gradientAngle = document.getElementById('gradientAngle');
  const gradientSpread = document.getElementById('gradientSpread');
  const gradientSpinToggle = document.getElementById('gradientSpinToggle');
  const gradientSpinControls = document.getElementById('gradientSpinControls');
  const gradientSpinSpeed = document.getElementById('gradientSpinSpeed');

  // Utility
  const enableSecCounter = document.getElementById('enableSecCounter');
  const enableClickCounter = document.getElementById('enableClickCounter');
  const resetClickCounter = document.getElementById('resetClickCounter');
  const secCounter = document.getElementById('secCounter');
  const secCount = document.getElementById('secCount');
  const pauseCounter = document.getElementById('pauseCounter');
  const clickCounter = document.getElementById('clickCounter');
  const clickCount = document.getElementById('clickCount');
  const simpleModeToggle = document.getElementById('simpleModeToggle');
  const exportStateBtn = document.getElementById('exportStateBtn');
  const secWorkflowStages = document.getElementById('secWorkflowStages');
  const workflowStagesList = document.getElementById('workflowStagesList');
  const newStageName = document.getElementById('newStageName');
  const addStageBtn = document.getElementById('addStageBtn');
  const resetStagesBtn = document.getElementById('resetStagesBtn');
  const secPdfExport = document.getElementById('secPdfExport');
  const pdfHeader = document.getElementById('pdfHeader');
  const pdfAuthor = document.getElementById('pdfAuthor');
  const pdfTheme = document.getElementById('pdfTheme');
  const pdfAccentColor = document.getElementById('pdfAccentColor');
  const pdfIncludeDate = document.getElementById('pdfIncludeDate');
  const pdfIncludeTime = document.getElementById('pdfIncludeTime');
  const pdfCustomTime = document.getElementById('pdfCustomTime');
  const pdfIncludeAuthor = document.getElementById('pdfIncludeAuthor');
  const pdfIncludeCheckboxes = document.getElementById('pdfIncludeCheckboxes');
  const pdfLogoUpload = document.getElementById('pdfLogoUpload');
  const pdfClearLogoBtn = document.getElementById('pdfClearLogoBtn');
  const pdfPreview = document.getElementById('pdfPreview');
  const enlargePreviewBtn = document.getElementById('enlargePreviewBtn');
  const downloadPdfBtn = document.getElementById('downloadPdfBtn');
  const showPreviewBtn = document.getElementById('showPreviewBtn');

  // PDF Export Listeners
  const pdfPreviewContainer = document.querySelector('.pdf-preview-container');
  showPreviewBtn.addEventListener('click', () => {
    const isVisible = pdfPreviewContainer.style.display === 'block';
    pdfPreviewContainer.style.display = isVisible ? 'none' : 'block';
    showPreviewBtn.textContent = isVisible ? 'Show Preview' : 'Hide Preview';
    if (!isVisible) {
      generatePdfPreview();
    }
  });
  pdfLogoUpload.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
            pdfLogoData = event.target.result;
            pdfClearLogoBtn.style.display = 'block';
            generatePdfPreviewIfVisible();
        };
        reader.readAsDataURL(file);
    }
  });

  pdfClearLogoBtn.addEventListener('click', () => {
    pdfLogoData = null;
    pdfLogoUpload.value = ''; // Clear the file input
    pdfClearLogoBtn.style.display = 'none';
    generatePdfPreviewIfVisible();
  });

  pdfHeader.addEventListener('input', generatePdfPreviewIfVisible);
  pdfAuthor.addEventListener('input', generatePdfPreviewIfVisible);
  pdfTheme.addEventListener('change', generatePdfPreviewIfVisible);
  pdfAccentColor.addEventListener('change', generatePdfPreviewIfVisible);
  pdfIncludeDate.addEventListener('change', generatePdfPreviewIfVisible);
  pdfIncludeTime.addEventListener('change', generatePdfPreviewIfVisible);
  pdfCustomTime.addEventListener('input', generatePdfPreviewIfVisible);
  pdfIncludeAuthor.addEventListener('change', generatePdfPreviewIfVisible);
  pdfIncludeCheckboxes.addEventListener('change', generatePdfPreviewIfVisible);
  downloadPdfBtn.addEventListener('click', downloadPdf);


  function generatePdfPreviewIfVisible() {
    if (pdfPreviewContainer.style.display === 'block') {
      generatePdfPreview();
    }
  }

  function generatePdfPreview() {
    const currentList = lists[activeListIndex];
    if (!currentList) {
        pdfPreview.src = "";
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const headerText = pdfHeader.value || currentList.name;
    const authorText = pdfAuthor.value;
    const theme = pdfTheme.value;
    const accentColor = pdfAccentColor.value;
    const includeDate = pdfIncludeDate.checked;
    const includeTime = pdfIncludeTime.checked;
    const includeAuthor = pdfIncludeAuthor.checked;
    const includeCheckboxes = pdfIncludeCheckboxes.checked;

    const pageWidth = doc.internal.pageSize.width;
    const margin = 14;
    let finalY = 20;
    let logoRightEdge = pageWidth - margin;

    if (pdfLogoData) {
        try {
            const imgProps = doc.getImageProperties(pdfLogoData);
            const maxLogoW = 40;
            const maxLogoH = 20;
            let logoW = imgProps.width;
            let logoH = imgProps.height;
            const ratio = logoW / logoH;

            if (logoW > maxLogoW || logoH > maxLogoH) {
                if (logoW / maxLogoW > logoH / maxLogoH) {
                    logoW = maxLogoW;
                    logoH = maxLogoW / ratio;
                } else {
                    logoH = maxLogoH;
                    logoW = maxLogoH * ratio;
                }
            }
            
            const logoX = pageWidth - margin - logoW;
            const logoY = margin;
            doc.addImage(pdfLogoData, logoX, logoY, logoW, logoH);
            logoRightEdge = logoX - 5; 
            finalY = Math.max(finalY, logoY + logoH + 10);
        } catch(e) {
            console.error("Could not add logo to PDF for preview", e);
        }
    }

    doc.setFontSize(18);
    doc.text(headerText, margin, 22, { maxWidth: logoRightEdge - margin });
    finalY = Math.max(finalY, 35);

    const customTime = pdfCustomTime.value.trim();
    let dateTimeInfo = [];
    if (includeDate) dateTimeInfo.push(new Date().toLocaleDateString());
    if (includeTime) dateTimeInfo.push(customTime || new Date().toLocaleTimeString());

    if (dateTimeInfo.length > 0) {
        doc.setFontSize(10);
        doc.text(dateTimeInfo.join('  |  '), margin, finalY);
        finalY += 6;
    }
    
    if (includeAuthor && authorText) {
        doc.setFontSize(10);
        doc.text(`By: ${authorText}`, margin, finalY);
        finalY += 10;
    }

    const tableData = getTasksForPdf();
    const tableHeaders = [
        { header: 'Task', dataKey: 'text' },
        { header: 'Status', dataKey: 'status' }
    ];

    let headStyles = { fillColor: accentColor };

    doc.autoTable({
        startY: finalY,
        columns: tableHeaders,
        body: tableData,
        theme: theme,
        headStyles: headStyles,
        styles: { valign: 'middle' },
        columnStyles: {
            text: { cellPadding: { left: pdfIncludeCheckboxes.checked ? 8 : 2 } }
        },
        didDrawCell: function(data) {
            if (data.section === 'body' && data.column.dataKey === 'text' && pdfIncludeCheckboxes.checked) {
                const isComplete = data.row.raw.isComplete;
                const checkboxSize = 3.5;
                const checkboxX = data.cell.x + 2;
                const checkboxY = data.cell.y + data.cell.height / 2 - checkboxSize / 2;
                
                doc.setDrawColor(100);
                doc.setFillColor(255, 255, 255);
                doc.rect(checkboxX, checkboxY, checkboxSize, checkboxSize, 'FD');

                if (isComplete) {
                    doc.setLineWidth(0.6);
                    doc.setDrawColor(0);
                    doc.line(checkboxX + 0.7, checkboxY + 1.75, checkboxX + 1.5, checkboxY + 2.75);
                    doc.line(checkboxX + 1.5, checkboxY + 2.75, checkboxX + 2.8, checkboxY + 0.8);
                }
            }
        },
        didDrawPage: function(data) {
            const pageCount = doc.internal.getNumberOfPages();
            const pageWidth = doc.internal.pageSize.width;
            const pageHeight = doc.internal.pageSize.height;

            // Watermark
            doc.setFontSize(8);
            doc.setTextColor('#cccccc'); // An off-grey color
            const watermarkText = "Made at https://www.mysparklist.com/";
            const textWidth = doc.getStringUnitWidth(watermarkText) * doc.getFontSize() / doc.internal.scaleFactor;
            const textX = (pageWidth - textWidth) / 2;
            doc.text(watermarkText, textX, pageHeight - 10);

            // Page number
            doc.setFontSize(8);
            doc.setTextColor('#888888'); // A light grey for the page number
            const pageNumText = "Page " + pageCount;
            doc.text(pageNumText, pageWidth - data.settings.margin.right, pageHeight - 10, { align: 'right' });
        }
    });

    pdfPreview.src = doc.output('datauristring');
  }


  function getTasksForPdf() {
      const currentList = lists[activeListIndex];
      if (!currentList) return [];
      const tasks = currentList.items;

      if (currentList.type === 'Workflow') {
          return tasks.map(task => {
              const stageName = currentList.stages.find(stage => stage === task.status) || task.status;
              const isComplete = currentList.stages.length > 0 && task.status === currentList.stages[currentList.stages.length - 1];
              return { text: task.text, status: stageName, isComplete: isComplete };
          });
      } else { // default list
          return tasks.map(task => {
              const isComplete = task.status === 'complete';
              return { text: task.text, status: isComplete ? 'Completed' : 'Pending', isComplete: isComplete };
          });
      }
  }


  function downloadPdf() {
      const currentList = lists[activeListIndex];
      if (!currentList) return;

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const headerText = pdfHeader.value || currentList.name;
      const authorText = pdfAuthor.value;
      const theme = pdfTheme.value;
      const accentColor = pdfAccentColor.value;
      const includeDate = pdfIncludeDate.checked;
      const includeTime = pdfIncludeTime.checked;
      const includeAuthor = pdfIncludeAuthor.checked;
      const includeCheckboxes = pdfIncludeCheckboxes.checked;

      const pageWidth = doc.internal.pageSize.width;
      const margin = 14;
      let finalY = 20;
      let logoRightEdge = pageWidth - margin;

      if (pdfLogoData) {
          try {
              const imgProps = doc.getImageProperties(pdfLogoData);
              const maxLogoW = 40;
              const maxLogoH = 20;
              let logoW = imgProps.width;
              let logoH = imgProps.height;
              const ratio = logoW / logoH;

              if (logoW > maxLogoW || logoH > maxLogoH) {
                  if (logoW / maxLogoW > logoH / maxLogoH) {
                      logoW = maxLogoW;
                      logoH = maxLogoW / ratio;
                  } else {
                      logoH = maxLogoH;
                      logoW = maxLogoH * ratio;
                  }
              }
              
              const logoX = pageWidth - margin - logoW;
              const logoY = margin;
              doc.addImage(pdfLogoData, logoX, logoY, logoW, logoH);
              logoRightEdge = logoX - 5; 
              finalY = Math.max(finalY, logoY + logoH + 10);
          } catch(e) {
              console.error("Could not add logo to PDF for download", e);
          }
      }

      doc.setFontSize(18);
      doc.text(headerText, margin, 22, { maxWidth: logoRightEdge - margin });
      finalY = Math.max(finalY, 35);

      const customTime = pdfCustomTime.value.trim();
      let dateTimeInfo = [];
      if (includeDate) dateTimeInfo.push(new Date().toLocaleDateString());
      if (includeTime) dateTimeInfo.push(customTime || new Date().toLocaleTimeString());

      if (dateTimeInfo.length > 0) {
          doc.setFontSize(10);
          doc.text(dateTimeInfo.join('  |  '), margin, finalY);
          finalY += 6;
      }
      
      if (includeAuthor && authorText) {
          doc.setFontSize(10);
          doc.text(`By: ${authorText}`, margin, finalY);
          finalY += 10;
      }

      const tableData = getTasksForPdf();
      const tableHeaders = [
          { header: 'Task', dataKey: 'text' },
          { header: 'Status', dataKey: 'status' }
      ];

      let headStyles = { fillColor: accentColor };

      doc.autoTable({
          startY: finalY,
          columns: tableHeaders,
          body: tableData,
          theme: theme,
          headStyles: headStyles,
          styles: { valign: 'middle' },
          columnStyles: {
              text: { cellPadding: { left: pdfIncludeCheckboxes.checked ? 8 : 2 } }
          },
          didDrawCell: function(data) {
              if (data.section === 'body' && data.column.dataKey === 'text' && pdfIncludeCheckboxes.checked) {
                  const isComplete = data.row.raw.isComplete;
                  const checkboxSize = 3.5;
                  const checkboxX = data.cell.x + 2;
                  const checkboxY = data.cell.y + data.cell.height / 2 - checkboxSize / 2;
                  
                  doc.setDrawColor(100);
                  doc.setFillColor(255, 255, 255);
                  doc.rect(checkboxX, checkboxY, checkboxSize, checkboxSize, 'FD');

                  if (isComplete) {
                      doc.setLineWidth(0.6);
                      doc.setDrawColor(0);
                      doc.line(checkboxX + 0.7, checkboxY + 1.75, checkboxX + 1.5, checkboxY + 2.75);
                      doc.line(checkboxX + 1.5, checkboxY + 2.75, checkboxX + 2.8, checkboxY + 0.8);
                  }
              }
          },
          didDrawPage: function(data) {
            const pageCount = doc.internal.getNumberOfPages();
            const pageWidth = doc.internal.pageSize.width;
            const pageHeight = doc.internal.pageSize.height;

            // Watermark
            doc.setFontSize(8);
            doc.setTextColor('#cccccc'); // An off-grey color
            const watermarkText = "Made at https://www.mysparklist.com/";
            const textWidth = doc.getStringUnitWidth(watermarkText) * doc.getFontSize() / doc.internal.scaleFactor;
            const textX = (pageWidth - textWidth) / 2;
            doc.text(watermarkText, textX, pageHeight - 10);

            // Page number
            doc.setFontSize(8);
            doc.setTextColor('#888888'); // A light grey for the page number
            const pageNumText = "Page " + pageCount;
            doc.text(pageNumText, pageWidth - data.settings.margin.right, pageHeight - 10, { align: 'right' });
          }
      });

      doc.save(`${currentList.name.replace(/\s+/g, '-')}-export.pdf`);
  }

  enlargePreviewBtn.addEventListener('click', () => {
      const pdfDataUri = pdfPreview.src;
      if (pdfDataUri) {
          const newTab = window.open();
          newTab.document.write(`<iframe src="${pdfDataUri}" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%;" allowfullscreen></iframe>`);
          newTab.document.title = 'PDF Preview';
      }
  });

  // Natural Slide controls
  const enableNaturalSlide = document.getElementById('enableNaturalSlide');
  const slideSpeed = document.getElementById('slideSpeed');

  // Utility
  const panicResetBtn = document.getElementById('panicResetBtn');
  const enableClock = document.getElementById('enableClock');
  const clockDisplay = document.getElementById('clockDisplay');
  const clockPosition = document.getElementById('clockPosition');
  const clockDetail = document.getElementById('clockDetail');
  const clockOptionsWrapper = document.getElementById('clockOptionsWrapper');
  const versionTag = document.getElementById('versionTag');

  // Saved Patterns
  const patternNameInput = document.getElementById('patternNameInput');
  const savePatternBtn = document.getElementById('savePatternBtn');
  const patternsList = document.getElementById('patternsList');
  const importPatternsBtn = document.getElementById('importPatternsBtn');
  const exportPatternsBtn = document.getElementById('exportPatternsBtn');
  const importFile = document.getElementById('importFile');

  // Ambiance Effects
  const enableAmbiance = document.getElementById('enableAmbiance');
  const ambianceSettings = document.getElementById('ambianceSettings');
  const ambianceSelect = document.getElementById('ambianceSelect');
  const ambianceControls = document.getElementById('ambianceControls');
  const snowControls = document.getElementById('snowControls');
  const snowDensity = document.getElementById('snowDensity');
  const snowSize = document.getElementById('snowSize');
  const snowSpeed = document.getElementById('snowSpeed');
  const orbsControls = document.getElementById('orbsControls');
  const orbsDensity = document.getElementById('orbsDensity');
  const orbsSize = document.getElementById('orbsSize');
  const orbsSpeed = document.getElementById('orbsSpeed');
  const orbsColor = document.getElementById('orbsColor');
  const starfieldControls = document.getElementById('starfieldControls');
  const starfieldDensity = document.getElementById('starfieldDensity');
  const starfieldSize = document.getElementById('starfieldSize');
  const starfieldSpeed = document.getElementById('starfieldSpeed');
  const matrixControls = document.getElementById('matrixControls');
  const matrixDensity = document.getElementById('matrixDensity');
  const matrixSize = document.getElementById('matrixSize');
  const matrixSpeed = document.getElementById('matrixSpeed');
  const matrixColor = document.getElementById('matrixColor');

  // Canvas
  const bubblesCanvas = document.getElementById('bubblesCanvas');
  const ctxBubbles = bubblesCanvas.getContext('2d');
  const ambianceCanvas = document.getElementById('ambianceCanvas');
  const ctxAmbiance = ambianceCanvas.getContext('2d');

  // Sections
  const secCheckmarkAnims = document.getElementById('secCheckmarkAnims');
  const secAppearance = document.getElementById('secAppearance');
  const secUtility = document.getElementById('secUtility');
  const secAnimStyle = document.getElementById('secAnimStyle');
  const secWind = document.getElementById('secWind');
  const secPatterns = document.getElementById('secPatterns');
  const secBackground = document.getElementById('secBackground');

  /* ---------- GLOBALS ---------- */
  const PARTICLE_CAP = 25000;
  const MATRIX_CHARS = 'アァカサタナハマヤャラワガザダバパイィキシチニヒミリヰギジヂビピウゥクスツヌフムユュルグズブプエェケセテネヘメレヱゲゼデベペオォコソトノホモヨョロヲゴゾドボポヴッン';

  let secInterval = null, seconds = 0, counterPaused = false, totalClicks = 0, clockInterval = null;
  let particles = []; let streams = []; let ambianceParticles = []; let t = 0;
  let lastSnapshot = null;
  let currentAccentColor = '#2563eb';
  let savedPatterns = [];
  let gradientAnimationAngle = 0;
  let screenFlash = 0;
  let lightningBolts = [];
  let pdfLogoData = null;
  
  let lists = [];
  let activeListIndex = 0;
  let listCreationCallback = null;
  let temp_listType = '';
  let contextListIndex = -1;
  let tabClickTimer = null;
  const DBL_CLICK_DELAY = 250; 

  const materialPresets = {
      glass: {
          name: 'Glass',
          styles: {
              'default':  { name: 'Default',   light: '255,255,255', dark: '15,20,24' },
              'graphite': { name: 'Graphite',  light: '240,240,245', dark: '35,35,40' },
              'blue':     { name: 'Blue',      light: '235,245,255', dark: '20,30,45' },
              'purple':   { name: 'Purple',    light: '245,240,255', dark: '35,25,45' },
              'pink':     { name: 'Pink',      light: '255,240,245', dark: '50,25,35' },
              'red':      { name: 'Red',       light: '255,240,240', dark: '50,25,25' },
              'orange':   { name: 'Orange',    light: '255,245,235', dark: '55,35,20' },
              'yellow':   { name: 'Yellow',    light: '255,250,235', dark: '50,45,25' },
              'green':    { name: 'Green',     light: '240,255,240', dark: '20,40,25' }
          }
      }
  };
  
  /* ---------- UTILS ---------- */
  function resizeCanvas(cv){
    cv.style.width = window.innerWidth+'px';
    cv.style.height = window.innerHeight+'px';
    const dpr = window.devicePixelRatio || 1;
    cv.width = Math.round(window.innerWidth * dpr);
    cv.height = Math.round(window.innerHeight * dpr);
    if (cv.getContext('2d')) {
        cv.getContext('2d').setTransform(dpr,0,0,dpr,0,0);
    }
  }
  function hexToRgb(hex){ const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec((hex||'').trim()); return m ? {r:parseInt(m[1],16),g:parseInt(m[2],16),b:parseInt(m[3],16)} : null; }
  function rgbToHex(r,g,b){ const h = (n)=>n.toString(16).padStart(2,'0'); return '#'+h(Math.max(0,Math.min(255,Math.round(r))))+h(Math.max(0,Math.min(255,Math.round(g))))+h(Math.max(0,Math.min(255,Math.round(b)))); }
  function hslToHex(h,s,l){ s/=100; l/=100; const c=(1-Math.abs(2*l-1))*s; const x=c*(1-Math.abs(((h/60)%2)-1)); const m=l-c/2; let r=0,g=0,b=0; if(0<=h&&h<60){r=c;g=x;b=0;} else if(60<=h&&h<120){r=x;g=c;b=0;} else if(120<=h&&h<180){r=0;g=c;b=x;} else if(180<=h&&h<240){r=0;g=x;b=c;} else if(240<=h&&h<300){r=x;g=0;b=c;} else {r=c;g=0;b=x;} return rgbToHex((r+m)*255,(g+m)*255,(b+m)*255); }
  function lerp(a,b,t){ return a+(b-a)*t; }
  function lerpColor(hexA,hexB,t){ const A=hexToRgb(hexA), B=hexToRgb(hexB); if (!A || !B) return '#000000'; return rgbToHex(lerp(A.r,B.r,t), lerp(A.g,B.g,t), lerp(A.b,B.b,t)); }
  function gaussianRand(){ let u=0,v=0; while(u===0) u=Math.random(); while(v===0) v=Math.random(); return Math.sqrt(-2.0*Math.log(u))*Math.cos(2.0*Math.PI*v); }
  function isColorDark(hexColor) {
    const rgb = hexToRgb(hexColor);
    if (!rgb) return false;
    // Formula for perceived brightness (luminance)
    const luminance = (0.299 * rgb.r + 0.587 * rgb.g + 0.114 * rgb.b) / 255;
    return luminance < 0.5;
  }

  function generateShareLink(listIndex) {
    if (listIndex < 0 || listIndex >= lists.length) {
        alert("Cannot share. No valid list selected.");
        return;
    }
    const listToShare = lists[listIndex];

    // Share name, type, and items for a better user experience
    const dataToShare = {
        name: listToShare.name,
        type: listToShare.type,
        items: listToShare.items,
        stages: listToShare.type === 'Workflow' ? listToShare.stages : undefined
    };
    const jsonString = JSON.stringify(dataToShare);

    try {
        // Modern, robust way to encode string to Base64, handling Unicode
        const uint8Array = new TextEncoder().encode(jsonString);
        const encodedString = btoa(String.fromCharCode.apply(null, uint8Array));

        const baseUrl = `${location.origin}${location.pathname}`;
        const shareableLink = `${baseUrl}?list=${encodeURIComponent(encodedString)}`;

        if (navigator.clipboard) {
            navigator.clipboard.writeText(shareableLink).then(() => {
                alert("Share link copied to clipboard!");
            }).catch(err => {
                console.error('Failed to copy share link: ', err);
                prompt("Could not copy to clipboard automatically. Here is the link:", shareableLink);
            });
        } else {
            // Fallback for older browsers
            prompt("Clipboard access is not available. Here is the link:", shareableLink);
        }
    } catch (e) {
        console.error("Error generating share link:", e);
        alert("Could not generate share link. The list might be too large.");
    }
  }

  function saveData(){
    localStorage.setItem('mysparklist.lists', JSON.stringify(lists));
    localStorage.setItem('mysparklist.activeListIndex', activeListIndex);
    const store = (k,v)=>localStorage.setItem('mysparklist.'+k, String(v));

    store('animationStyle', animationStyleSelect.value);
    store('animIntensity',animIntensity.value); store('emissionScale',emissionScale.value); store('holdRate',holdRate.value);
    store('bubbleSize',bubbleSize.value); store('bubbleSpeed',bubbleSpeed.value); store('bubbleLife',bubbleLifeSlider.value);
    store('animationsEnabled',enableAnimations.checked); store('colorMode',colorMode.value); store('bubbleColor',bubbleColor.value);
    store('bubbleStartColor',bubbleStartColor.value); store('bubbleEndColor',bubbleEndColor.value); store('shape',shapeSelect.value);
    store('bubbleOutline', bubbleOutline.value); store('containParticles', containParticles.checked);
    store('enableWind',enableWind.checked); store('windPattern',windPattern.value); 
    store('windIntensity',windIntensity.value); store('windDirection',windDirection.value); store('endlessEnabled',enableEndless.checked);
    store('darkMode',document.documentElement.classList.contains('dark')); 
    store('glassOpacity', glassOpacity.value);
    store('glassBlur', glassBlurSlider.value);
    store('glassSaturation', glassSaturationSlider.value);
    store('glassBorder', glassBorderSlider.value);
    store('uiStyle', uiStyleSelect.value);
    store('completionCheckedColor', completionCheckedColor.value);
    store('completionUncheckedColor', completionUncheckedColor.value);
    store('completionInProgressColor', completionInProgressColor.value);
    store('completionGlow', completionGlow.value);
    store('completionSpeed', completionSpeed.value);
    store('enableCustomBackground', enableCustomBackground.checked);
    store('ambianceEnabled', enableAmbiance.checked);
    store('ambianceEffect', ambianceSelect.value);
    store('snowDensity', snowDensity.value); store('snowSize', snowSize.value); store('snowSpeed', snowSpeed.value);
    store('orbsDensity', orbsDensity.value); store('orbsSize', orbsSize.value); store('orbsSpeed', orbsSpeed.value); store('orbsColor', orbsColor.value);
    store('starfieldDensity', starfieldDensity.value); store('starfieldSize', starfieldSize.value); store('starfieldSpeed', starfieldSpeed.value);
    store('matrixDensity', matrixDensity.value); store('matrixSize', matrixSize.value); store('matrixSpeed', matrixSpeed.value); store('matrixColor', matrixColor.value);
    store('backgroundType', backgroundType.value); store('wallpaperFit', wallpaperFit.value); store('colorWallpaperType', colorWallpaperType.value);
    store('wallpaperColor1', wallpaperColor1.value); store('wallpaperColor2', wallpaperColor2.value); store('wallpaperColor3', wallpaperColor3.value);
    store('gradientAngle', gradientAngle.value); store('gradientSpread', gradientSpread.value); store('gradientSpinEnabled', gradientSpinToggle.checked);
    store('gradientSpinSpeed', gradientSpinSpeed.value);
    store('secCounter',enableSecCounter.checked); store('clickCounter',enableClickCounter.checked); store('clickCount',totalClicks);
    store('seconds',seconds);
    store('naturalSlide', enableNaturalSlide.checked);
    store('enableScanLine', enableScanLine.checked);
    store('scanAngle', scanAngle.value);
    store('slideSpeed', slideSpeed.value); store('clockEnabled', enableClock.checked); store('clockPosition', clockPosition.value);
    store('clockDetail', clockDetail.value);
    store('simpleMode', simpleModeToggle.checked);
    store('hasLaunchedBefore', 'true');
    store('hideWelcomeBack', hideWelcomeBack.checked);
    store('keepMenuExpanded', document.getElementById('keepMenuExpanded')?.checked);
    localStorage.setItem('mysparklist.savedPatterns', JSON.stringify(savedPatterns));

    const keepMenuExpanded = document.getElementById('keepMenuExpanded')?.checked;
    const detailsElements = document.querySelectorAll('.menu-panel details');
    detailsElements.forEach(el => {
        if (el.id) {
            if (keepMenuExpanded) {
                store(`secOpen.${el.id}`, el.open);
            } else {
                localStorage.removeItem('mysparklist.secOpen.' + el.id);
            }
        }
    });
  }

  function loadData(){
    const get = (k, fallback) => localStorage.getItem('mysparklist.'+k) ?? fallback;
    const hasLaunchedBefore = (get('hasLaunchedBefore', 'false') === 'true');
    const shouldHideWelcomeBack = (get('hideWelcomeBack', 'false') === 'true');
    let isSharedListLoaded = false;
    
    // Default loading from localStorage
    lists = JSON.parse(get('lists', '[]'));
    activeListIndex = parseInt(get('activeListIndex', '0'), 10);

    // Data migration from 'done' to 'status'
    lists.forEach(list => {
        if (list.items) {
            list.items.forEach(item => {
                if (typeof item.done !== 'undefined') {
                    item.status = item.done ? 'complete' : 'pending';
                    delete item.done;
                }
                // Ensure all items have a status
                if (!item.status) {
                    item.status = 'pending';
                }
            });
        }
    });

    // Check for shared list and OVERRIDE if present
    const urlParams = new URLSearchParams(window.location.search);
    const sharedListData = urlParams.get('list');

    if (sharedListData) {
        try {
            // Modern, robust way to decode Base64 to string, handling Unicode
            const binaryString = atob(sharedListData);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            const decodedString = new TextDecoder().decode(bytes);
            const parsedData = JSON.parse(decodedString);

            if (parsedData && Array.isArray(parsedData.items)) {
                const listType = parsedData.type || "General Tasks";
                let initialStatus = 'pending';
                if (listType === 'Workflow' && parsedData.stages && parsedData.stages.length > 0) {
                    initialStatus = parsedData.stages[0];
                }

                // Set all items to the initial status
                parsedData.items.forEach(item => item.status = initialStatus);

                const newList = {
                    name: (parsedData.name || "Shared List") + " 🔗",
                    type: listType,
                    items: parsedData.items,
                    color: null,
                    stages: parsedData.stages
                };
                
                // Replace all existing lists with the new shared one.
                lists = [newList];
                activeListIndex = 0;
                isSharedListLoaded = true;

                // Clean the URL
                const newUrl = window.location.pathname;
                history.replaceState({}, document.title, newUrl);
                
            } else {
                throw new Error("Invalid shared list data format.");
            }
        } catch (e) {
            console.error("Failed to load shared list:", e);
            alert("Could not load the shared list. The link may be invalid or corrupted.");
            const newUrl = window.location.pathname;
            history.replaceState({}, document.title, newUrl);
        }
    }
    
    if (lists.length === 0) {
      if (!hasLaunchedBefore) {
        showListCreationPrompt(true, (newListData) => {
            lists.push({ ...newListData, items: [] });
            activeListIndex = 0;
            localStorage.setItem('mysparklist.hasLaunchedBefore', 'true');
            updateUIForActiveList();
            saveData();
        });
      } else {
        lists = [{ name: 'My First List', type: 'General Tasks', items: [] }];
        activeListIndex = 0;
      }
    } else if (hasLaunchedBefore && !shouldHideWelcomeBack && !isSharedListLoaded) {
        welcomeBackOverlay.classList.add('visible');
    }
    
    updateUIForActiveList();

    // --- NEW DEFAULTS FROM JSON (2) ---
    animationStyleSelect.value = get('animationStyle', 'fireworks');
    animIntensity.value = get('animIntensity', '15');
    emissionScale.value = get('emissionScale', '80');
    holdRate.value = get('holdRate', '35');
    bubbleSize.value = get('bubbleSize', '7');
    bubbleSpeed.value = get('bubbleSpeed', '4');
    bubbleLifeSlider.value = get('bubbleLife', '250');
    colorMode.value = get('colorMode', 'fade');
    bubbleColor.value = get('bubbleColor', '#16a34a');
    bubbleStartColor.value = get('bubbleStartColor', '#b1dffb');
    bubbleEndColor.value = get('bubbleEndColor', '#ff0000');
    shapeSelect.value = get('shape', 'circle');
    bubbleOutline.value = get('bubbleOutline', 'none');
    containParticles.checked = (get('containParticles', 'false') === 'true');
    enableWind.checked = (get('enableWind', 'false') === 'true');
    windPattern.value = get('windPattern', 'steady');
    windIntensity.value = get('windIntensity', '30');
    windDirection.value = get('windDirection', '0');
    enableAnimations.checked = (get('animationsEnabled', 'true') === 'true');
    enableEndless.checked = (get('endlessEnabled', 'false') === 'true');
    enableSecCounter.checked = (get('secCounter', 'false') === 'true');
    enableClickCounter.checked = (get('clickCounter', 'false') === 'true');
    totalClicks = parseInt(get('clickCount', '0'), 10) || 0;
    seconds = parseInt(get('seconds', '0'), 10) || 0;

    const darkModePreference = get('darkMode', 'true');
    if (darkModePreference === 'true') {
        document.documentElement.classList.add('dark');
        darkToggle.innerHTML = '☀️ Light';
    }

    glassOpacity.value = get('glassOpacity', '25');
    glassBlurSlider.value = get('glassBlur', '9');
    glassSaturationSlider.value = get('glassSaturation', '93');
    glassBorderSlider.value = get('glassBorder', '23');
    populateStyleSelector('glass');
    uiStyleSelect.value = get('uiStyle', 'graphite');
    completionCheckedColor.value = get('completionCheckedColor', '#22c55e');
    completionUncheckedColor.value = get('completionUncheckedColor', '#f87171');
    completionInProgressColor.value = get('completionInProgressColor', '#3b82f6');
    completionGlow.value = get('completionGlow', '6');
    completionSpeed.value = get('completionSpeed', '900');
    enableCustomBackground.checked = (get('enableCustomBackground', 'true') === 'true');
    enableAmbiance.checked = (get('ambianceEnabled', 'true') === 'true');
    ambianceSelect.value = get('ambianceEffect', 'orbs');
    snowDensity.value = get('snowDensity', '100');
    snowSize.value = get('snowSize', '20');
    snowSpeed.value = get('snowSpeed', '30');
    orbsDensity.value = get('orbsDensity', '26');
    orbsSize.value = get('orbsSize', '68');
    orbsSpeed.value = get('orbsSpeed', '8');
    orbsColor.value = get('orbsColor', '#9aa4b2');
    starfieldDensity.value = get('starfieldDensity', '500');
    starfieldSize.value = get('starfieldSize', '3');
    starfieldSpeed.value = get('starfieldSpeed', '25');
    matrixDensity.value = get('matrixDensity', '100');
    matrixSize.value = get('matrixSize', '14');
    matrixSpeed.value = get('matrixSpeed', '40');
    matrixColor.value = get('matrixColor', '#00ff47');
    backgroundType.value = get('backgroundType', 'color');
    wallpaperFit.value = get('wallpaperFit', 'cover');
    colorWallpaperType.value = get('colorWallpaperType', 'gradient');
    wallpaperColor1.value = get('wallpaperColor1', '#2c3e50');
    wallpaperColor2.value = get('wallpaperColor2', '#006eff');
    wallpaperColor3.value = get('wallpaperColor3', '#020019');
    gradientAngle.value = get('gradientAngle', '145');
    gradientSpread.value = get('gradientSpread', '0');
    gradientAnimationAngle = parseFloat(gradientAngle.value);
    gradientSpinToggle.checked = (get('gradientSpinEnabled', 'true') === 'true');
    gradientSpinSpeed.value = get('gradientSpinSpeed', '10');
    enableNaturalSlide.checked = (get('naturalSlide', 'true') === 'true');
    enableScanLine.checked = (get('enableScanLine', 'true') === 'true');
    scanAngle.value = get('scanAngle', '180');
    slideSpeed.value = get('slideSpeed', '800');
    enableClock.checked = (get('clockEnabled', 'false') === 'true');
    clockPosition.value = get('clockPosition', 'pos-top-right');
    clockDetail.value = get('clockDetail', 'dateTime');
    simpleModeToggle.checked = (get('simpleMode', 'false') === 'true');
    hideWelcomeBack.checked = shouldHideWelcomeBack;
    savedPatterns = JSON.parse(get('savedPatterns', '[]'));
    
    const keepMenuExpanded = get('keepMenuExpanded', 'false') === 'true';
    if(document.getElementById('keepMenuExpanded')) {
      document.getElementById('keepMenuExpanded').checked = keepMenuExpanded;
    }

    const detailsElements = document.querySelectorAll('.menu-panel details');
    detailsElements.forEach(el => {
        if (el.id) {
            if (keepMenuExpanded) {
                 el.open = (get(`secOpen.${el.id}`, 'false') === 'true');
            } else {
                el.open = false;
            }
        }
    });

    applyAllSettings();
    
    updateSectionVisibility(hasLaunchedBefore);

    if (simpleModeToggle.checked) {
      applySimplifiedMode(true, true);
    }
  }

  function applyAllSettings() {
    updatePercentages(); 
    syncColorControlVisibility(); 
    syncWindControls(); 
    applyGlassOpacity(); 
    applyGlassBlur();
    applyGlassSaturation();
    applyGlassBorderOpacity();
    applyMaterialStyle();
    applyCompletionEffectSettings();
    applyScanAngle();
    syncScanAngleVisibility();
    updateWallpaper(); 
    applyClockSettings(); 
    updateCountersVisibility(); 
    applyAmbianceSettings(); 
    renderPatternsList();
    syncAnimationSettingsUI(); 
    applyLogoTheme();
    syncCustomBackgroundVisibility();
    clickCount.textContent = totalClicks; 
    updateSecondCounter(); 
    applySlideSpeed();
    gradientSpinControls.style.display = gradientSpinToggle.checked ? 'flex' : 'none';
    bubbleLifeSlider.dispatchEvent(new Event('input'));
  }

  /* ---------- Section Visibility ---------- */
  function updateSectionVisibility(hasLaunched) {
      const devMode = !simpleModeToggle.checked;
      if (!hasLaunched && !devMode) {
          secCheckmarkAnims.style.display = 'none';
          secAppearance.style.display = 'none';
          secUtility.querySelector('details').open = true;
      } else {
          secCheckmarkAnims.style.display = devMode ? 'block' : 'none';
          secAppearance.style.display = devMode ? 'block' : 'none';
      }
  }

  /* ---------- Logo & Title ---------- */
  function applyLogoTheme() {
      const h1 = appTitle;
      
      h1.style.fontFamily = ''; h1.style.fontWeight = ''; h1.style.color = '';
      h1.style.textShadow = ''; h1.style.letterSpacing = ''; h1.className = '';
      h1.innerHTML = '';

      titleWrap.classList.remove('custom-logo', 'no-glass');
      titleWrap.classList.add('glass');

      h1.style.fontFamily = 'system-ui, sans-serif';
      h1.style.fontWeight = '700';
      h1.style.color = 'var(--text)';
      h1.textContent = 'MySparkList';
  }

  /* ---------- Appearance ---------- */
    function populateStyleSelector() {
        uiStyleSelect.innerHTML = '';
        const styles = materialPresets.glass.styles || {};
        for (const [key, value] of Object.entries(styles)) {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = value.name;
            uiStyleSelect.appendChild(option);
        }
    }

  function applyMaterialStyle() {
    const style = uiStyleSelect.value;
    const isDark = document.documentElement.classList.contains('dark');
    const root = document.documentElement;
    
    document.querySelectorAll('.glass').forEach(el => {
        el.classList.remove('metal');
    });

    const preset = materialPresets.glass.styles[style];
    if (!preset) return;
    
    const rgbString = isDark ? preset.dark : preset.light;
    
    root.style.setProperty('--glass-tint', rgbString);
  }
    
    function applyGlassOpacity(){
      const val = Math.max(10, Math.min(100, parseInt(glassOpacity.value,10)||75));
      const alpha = (val/100).toFixed(2);
      document.documentElement.style.setProperty('--glass-alpha', alpha);
      pct.glass.textContent = val + '%';
    }

    function applyGlassBlur(){
      const val = parseInt(glassBlurSlider.value, 10);
      document.documentElement.style.setProperty('--glass-backdrop-blur', `${val}px`);
      pct.glassBlur.textContent = `${val}px`;
    }

    function applyGlassSaturation(){
      const val = parseInt(glassSaturationSlider.value, 10);
      document.documentElement.style.setProperty('--glass-backdrop-sat', `${val}%`);
      pct.glassSaturation.textContent = `${val}%`;
    }
    
    function applyGlassBorderOpacity() {
        const val = parseInt(glassBorderSlider.value, 10);
        const isDark = document.documentElement.classList.contains('dark');
        const baseColor = isDark ? '255,255,255' : '0,0,0';
        document.documentElement.style.setProperty('--glass-stroke', `rgba(${baseColor}, ${val / 100})`);
        pct.glassBorder.textContent = `${val}%`;
    }


  function resetUiStyleToDefault(){
    uiStyleSelect.value = 'default';
    
    const isDark = document.documentElement.classList.contains('dark');
    glassOpacity.value = isDark ? 55 : 75;
    glassBlurSlider.value = isDark ? 10 : 8;
    glassSaturationSlider.value = isDark ? 160 : 150;
    glassBorderSlider.value = 8;

    applyMaterialStyle();
    applyGlassOpacity();
    applyGlassBlur();
    applyGlassSaturation();
    applyGlassBorderOpacity();
  }

  /* ---------- Completion Effects ---------- */
  function applyCompletionEffectSettings() {
      const root = document.documentElement;
      const okColor = completionCheckedColor.value;
      const dangerColor = completionUncheckedColor.value;
      
      root.style.setProperty('--completion-duration', `${completionSpeed.value}ms`);
      root.style.setProperty('--completion-ok-color', okColor);
      root.style.setProperty('--completion-danger-color', dangerColor);
      root.style.setProperty('--completion-progress-color', completionInProgressColor.value);
      root.style.setProperty('--completion-glow-spread', `${completionGlow.value}px`);

      // Generate stronger/lighter versions for glows
      const okRgb = hexToRgb(okColor);
      const dangerRgb = hexToRgb(dangerColor);
      const progressRgb = hexToRgb(completionInProgressColor.value);

      if (okRgb) {
          const okStrong = rgbToHex(okRgb.r * 1.2, okRgb.g * 1.2, okRgb.b * 1.2);
          root.style.setProperty('--completion-ok-strong-color', okStrong);
      }
      if (dangerRgb) {
          const dangerStrong = rgbToHex(dangerRgb.r * 1.2, dangerRgb.g * 1.2, dangerRgb.b * 1.2);
          root.style.setProperty('--completion-danger-strong-color', dangerStrong);
      }
      if (progressRgb) {
          const progressStrong = rgbToHex(progressRgb.r * 1.2, progressRgb.g * 1.2, progressRgb.b * 1.2);
          root.style.setProperty('--completion-progress-strong-color', progressStrong);
      }
      updatePercentages();
  }

  function resetCompletionEffectSettings() {
      const isDark = document.documentElement.classList.contains('dark');
      completionCheckedColor.value = isDark ? '#22c55e' : '#16a34a';
      completionUncheckedColor.value = isDark ? '#f87171' : '#ef4444';
      completionInProgressColor.value = isDark ? '#3b82f6' : '#2563eb';
      completionGlow.value = 6;
      completionSpeed.value = 900;
      enableScanLine.checked = false;
      scanAngle.value = 180;
      applyCompletionEffectSettings();
      applyScanAngle();
      syncScanAngleVisibility();
  }
  
  function applyScanAngle() {
      const angle = scanAngle.value;
      document.documentElement.style.setProperty('--scan-line-angle', `${angle}deg`);
      if(pct.scanAngle) pct.scanAngle.textContent = `${angle}°`;
  }

  function syncScanAngleVisibility() {
      scanAngleControls.style.display = enableScanLine.checked ? 'flex' : 'none';
  }


  /* ---------- Wallpaper ---------- */
  function syncCustomBackgroundVisibility() {
    const isChecked = enableCustomBackground.checked;
    customBackgroundOptions.style.display = isChecked ? 'flex' : 'none';
    if (!isChecked) {
        backgroundType.value = 'theme';
    }
    updateWallpaper();
  }

  function clearAllBackgroundStyles() {
      document.body.style.backgroundImage = '';
      document.body.style.backgroundColor = '';
      document.body.style.backgroundSize = '';
      document.body.style.backgroundPosition = '';
      document.body.style.backgroundRepeat = '';
      document.body.style.backgroundAttachment = '';
  }


  function updateWallpaper() {
    if (!enableCustomBackground.checked) {
        clearAllBackgroundStyles();
        return;
    }

    const type = backgroundType.value;
    imageWallpaperControls.style.display = type === 'image' ? 'flex' : 'none';
    colorWallpaperControls.style.display = type === 'color' ? 'flex' : 'none';
    
    if (type === 'theme') {
      clearAllBackgroundStyles();
    } else if (type === 'image') {
      const wpData = localStorage.getItem('mysparklist.wallpaperDataUrl');
      if (wpData) applyImageWallpaper(wpData, wallpaperFit.value);
      else clearImageWallpaper();
    } else if (type === 'color') {
      applyColorWallpaper();
    }
  }

  function applyImageWallpaper(dataUrl, fit) {
    document.body.style.backgroundImage = `url('${dataUrl}')`;
    document.body.style.backgroundAttachment = 'fixed';
    document.body.style.backgroundRepeat = fit === 'tile' ? 'repeat' : 'no-repeat';
    document.body.style.backgroundPosition = fit === 'tile' ? 'top left' : 'center center';
    let size = 'auto';
    if (fit === 'cover') size = 'cover';
    else if (fit === 'contain') size = 'contain';
    else if (fit === 'fill') size = '100% 100%';
    document.body.style.backgroundSize = size;
  }

  function clearImageWallpaper() {
    clearAllBackgroundStyles();
  }

  function applyColorWallpaper() {
    const type = colorWallpaperType.value;
    solidColorControls.style.display = type === 'solid' ? 'flex' : 'none';
    gradientColorControls.style.display = type === 'gradient' ? 'flex' : 'none';
    if (type === 'solid') {
      document.body.style.backgroundImage = 'none';
      document.body.style.backgroundColor = wallpaperColor1.value;
    } else {
      const spreadValue = parseInt(gradientSpread.value, 10);
      const startPos = -spreadValue;
      const endPos = 100 + spreadValue;
      const angle = gradientSpinToggle.checked ? gradientAnimationAngle : gradientAngle.value;
      document.body.style.backgroundColor = '';
      document.body.style.backgroundImage = `linear-gradient(${angle}deg, ${wallpaperColor2.value} ${startPos}%, ${wallpaperColor3.value} ${endPos}%)`;
    }
  }

  function updateWallpaperUI() {
    const type = colorWallpaperType.value;
    solidColorControls.style.display = type === 'solid' ? 'flex' : 'none';
    gradientColorControls.style.display = type === 'gradient' ? 'flex' : 'none';
    updateWallpaper();
  }

  /* ---------- Items ---------- */
  function animateEnter(li){
    if(!enableNaturalSlide.checked) return;
    li.classList.add('slide-enter');
    void li.offsetHeight;
    li.classList.add('slide-enter-active');
    setTimeout(()=>{ li.classList.remove('slide-enter','slide-enter-active'); }, parseInt(slideSpeed.value,10)+20);
  }

  function animateRemove(li, done){
    if(!enableNaturalSlide.checked){ li.remove(); done&&done(); return; }
    const height = li.getBoundingClientRect().height;
    li.style.height = height+'px';
    li.style.transition = `height var(--slide-duration) var(--slide-ease)`;
    li.classList.add('slide-out');
    requestAnimationFrame(()=>{
      li.classList.add('collapsing');
      li.style.height = '0px';
      setTimeout(()=>{ li.remove(); done&&done(); }, parseInt(slideSpeed.value,10)+30);
    });
  }

  function updateItemUI(li, status) {
    const currentList = lists[activeListIndex];
    if (!li || !currentList) return;

    const cb = li.querySelector('input[type="checkbox"]');
    const badge = li.querySelector('.badge');
    const text = li.querySelector('.text');

    li.classList.remove('done', 'in-progress', 'pulse', 'warn', 'scan-effect-done', 'scan-effect-warn');
    text.style.textDecoration = 'none';
    
    let isComplete = false;
    let isPending = true;
    let isIntermediate = false;

    if (currentList.type === 'Workflow') {
        const stageIndex = currentList.stages.indexOf(status);
        const lastStageIndex = currentList.stages.length - 1;
        isComplete = (stageIndex === lastStageIndex);
        isPending = (stageIndex === 0);
        isIntermediate = !isComplete && !isPending;
    } else { // Standard list
        isComplete = (status === 'complete');
        isPending = (status === 'pending');
    }

    badge.textContent = status;
    cb.checked = isComplete;

    if (isComplete) {
        li.classList.add('done');
        text.style.textDecoration = 'line-through';
    } else if (isIntermediate) {
        li.classList.add('in-progress');
    } else { // isPending
        // No special class needed for pending, it's the default
    }
  }

  function addItem(text, status, silentAnim = false) {
    const li = document.createElement('li');
    li.className = 'item';
    li.draggable = true;
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    const lbl = document.createElement('label');
    lbl.className = 'label';
    const txt = document.createElement('span');
    txt.className = 'text';
    txt.textContent = text || 'Untitled';
    const badge = document.createElement('span');
    badge.className = 'badge';
    lbl.append(txt, badge);
    const rm = document.createElement('button');
    rm.className = 'remove';
    rm.textContent = '✖';
    li.append(cb, lbl, rm);
    
    updateItemUI(li, status); // Set initial UI
    
    list.appendChild(li);
    if (!silentAnim) animateEnter(li);

    cb.onchange = function() {
        const currentList = lists[activeListIndex];
        const itemIndex = Array.from(list.children).indexOf(li);
        if (itemIndex === -1) return;
        const currentItem = currentList.items[itemIndex];
        const oldStatus = currentItem.status;

        let newStatus;
        let stageChange = { oldIndex: -1, newIndex: -1, isWorkflow: currentList.type === 'Workflow' };

        if (stageChange.isWorkflow) {
            stageChange.oldIndex = currentList.stages.indexOf(oldStatus);
            stageChange.newIndex = (stageChange.oldIndex + 1) % currentList.stages.length;
            newStatus = currentList.stages[stageChange.newIndex];
        } else {
            newStatus = (oldStatus === 'pending') ? 'complete' : 'pending';
        }
        currentItem.status = newStatus;

        updateItemUI(li, newStatus);
        
        const wasComplete = stageChange.isWorkflow ? (stageChange.oldIndex === currentList.stages.length - 1) : (oldStatus === 'complete');
        const isNowComplete = stageChange.isWorkflow ? (stageChange.newIndex === currentList.stages.length - 1) : (newStatus === 'complete');
        const isProgressing = stageChange.isWorkflow ? (stageChange.newIndex > stageChange.oldIndex) : (newStatus === 'complete');

        // Handle forward progress
        if (isProgressing && !wasComplete) {
            if (enableScanLine.checked) {
                li.classList.remove('scan-effect-done', 'scan-effect-warn', 'scan-effect-progress');
                void li.offsetWidth; // Trigger reflow to restart animation
                if (isNowComplete) {
                    li.classList.add('scan-effect-done');
                } else {
                    li.classList.add('scan-effect-progress');
                }
            }
            // Big animation only on the final step
            if (isNowComplete) {
                if (enableAnimations.checked) {
                    spawnParticlesFromEl(cb);
                }
                li.classList.add('pulse');
                setTimeout(() => li.classList.remove('pulse'), parseInt(completionSpeed.value, 10) + 50);
            }
        }
        // Handle "un-checking" from a completed state
        else if (wasComplete && !isNowComplete) {
            li.classList.add('warn');
            if (enableScanLine.checked) {
                li.classList.remove('scan-effect-done', 'scan-effect-warn', 'scan-effect-progress');
                void li.offsetWidth; // Trigger reflow
                li.classList.add('scan-effect-warn');
            }
            setTimeout(() => li.classList.remove('warn'), parseInt(completionSpeed.value, 10) + 50);
        }
        
        saveData();
    };

    cb.addEventListener('pointerdown', (e)=>{ 
      if(!enableAnimations.checked || !enableEndless.checked || cb.checked) return; 
      e.stopPropagation();
      startParticleStream(cb, e.pointerId); 
    });
    ['pointerup','pointercancel','pointerleave'].forEach(ev=>{ cb.addEventListener(ev,(e)=>{ stopParticleStream(e.pointerId); },{passive:true}); });

    rm.onclick = ()=>{ 
      const itemIndex = Array.from(list.children).indexOf(li);
      lists[activeListIndex].items.splice(itemIndex, 1);
      
      streams = streams.filter(s=>!(s.el===cb)); 
      animateRemove(li, saveData); 
    };
    li.ondragstart = e=>{ li.classList.add('dragging'); e.dataTransfer.setData('text/plain',''); };
    li.ondragend = ()=> li.classList.remove('dragging');
  }

  addBtn.onclick = ()=>{ 
    if(input.value.trim()){ 
      const currentList = lists[activeListIndex];
      let initialStatus = 'pending';
      if (currentList.type === 'Workflow' && currentList.stages && currentList.stages.length > 0) {
          initialStatus = currentList.stages[0];
      }
      const newItem = { text: input.value.trim(), status: initialStatus };
      currentList.items.push(newItem);
      addItem(newItem.text, newItem.status); 
      input.value=''; 
      saveData(); 
    } 
  };
  input.onkeydown = e=>{ if(e.key==='Enter') addBtn.click(); };

  list.ondragover = e=>{
    e.preventDefault();
    const dragging = list.querySelector('.item.dragging');
    const after = getAfter(e.clientY);
    if(!dragging) return;
    if(after==null) list.append(dragging); else list.insertBefore(dragging, after);
  };
  function getAfter(y){
    const els = [...list.querySelectorAll('.item:not(.dragging)')];
    return els.reduce((closest,child)=>{
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height/2;
      return (offset<0 && offset>closest.offset) ? {offset, element:child} : closest;
    }, {offset:-Infinity}).element;
  }
  
  function setMenu(open){
    menuPanel.style.display = open ? 'block' : 'none';
    menuPanel.setAttribute('aria-hidden', !open);
    menuBtn.setAttribute('aria-expanded', open);
  }

  menuBtn.onclick = ()=>{ const isOpen = menuPanel.style.display==='block'; setMenu(!isOpen); };
  closeMenuNotch.onclick = ()=> setMenu(false);
  closeMenuNotch.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); setMenu(false); } });

  darkToggle.onclick = ()=>{
    document.documentElement.classList.toggle('dark');
    const isDark = document.documentElement.classList.contains('dark');
    darkToggle.innerHTML = isDark ? '☀️ Light' : '🌙 Dark';
    applyMaterialStyle();
    applyLogoTheme();
    applyGlassBorderOpacity(); // Re-apply border for theme change
    resetCompletionEffectSettings(); // Reset colors to match theme
    saveData();
  };

  /* ---------- Counters & Clock ---------- */
  function syncClockOptionsVisibility() {
      clockOptionsWrapper.style.display = enableClock.checked ? 'flex' : 'none';
  }
  function updateCountersVisibility(){ 
    secCounter.style.display = enableSecCounter.checked ? 'flex' : 'none'; 
    clickCounter.style.display = enableClickCounter.checked ? 'block' : 'none';
  }
  enableSecCounter.onchange = ()=>{ updateCountersVisibility(); saveData(); };
  enableClickCounter.onchange = ()=>{ updateCountersVisibility(); saveData(); };
  enableAnimations.onchange = ()=>{ if(!enableAnimations.checked){ streams.length=0; } saveData(); };
  resetClickCounter.onclick = ()=>{ totalClicks=0; clickCount.textContent='0'; saveData(); };
  document.addEventListener('click',(e)=>{ if(enableClickCounter.checked){ totalClicks++; clickCount.textContent=totalClicks; if(totalClicks%5===0) saveData(); } }, true);
  function startCounter(){ if(!enableSecCounter.checked) return; stopCounter(); secInterval=setInterval(()=>{ if(!counterPaused){ seconds++; updateSecondCounter(); } },1000); }
  function stopCounter(){ if(secInterval){ clearInterval(secInterval); secInterval=null; } }
  function updateSecondCounter(){ secCount.textContent = seconds + ' s'; }
  pauseCounter.onclick = ()=>{ counterPaused = !counterPaused; pauseCounter.textContent = counterPaused ? 'Resume' : 'Pause'; };
  
  function startClock() {
    stopClock();
    if(enableClock.checked){ clockInterval = setInterval(updateClock, 1000); updateClock(); }
  }
  function stopClock() { if(clockInterval) clearInterval(clockInterval); clockInterval = null; }
  function updateClock() {
      const now = new Date(), level = clockDetail.value;
      const timeOpts = { hour: 'numeric', minute: '2-digit' };
      const timeSecOpts = { ...timeOpts, second: '2-digit' };
      const dateOpts = { weekday: 'short', month: 'short', day: 'numeric' };
      let timeString = now.toLocaleTimeString([], timeOpts);
      if (level === 'timeSec') timeString = now.toLocaleTimeString([], timeSecOpts);
      else if (level === 'dateTime') timeString = `${now.toLocaleDateString([], dateOpts)}, ${timeString}`;
      else if (level === 'full') timeString = now.toLocaleString([], {...dateOpts, ...timeSecOpts});
      clockDisplay.textContent = timeString;
  }
  function applyClockSettings(){
    clockDisplay.style.display = enableClock.checked ? 'block' : 'none';
    syncClockOptionsVisibility();
    if (enableClock.checked) startClock(); else stopClock();
    const positionClass = clockPosition.value || 'pos-top-right';
    clockDisplay.className = `clock-display glass ${positionClass}`;
    // Version tag position is now static, no longer tied to clock
  }

  /* ---------- Simplified (Non-Advanced) Mode ---------- */
  function applySimplifiedMode(on, silent=false){
    if(on){
      if (!lastSnapshot) lastSnapshot = collectSettings();
      enableAnimations.checked = false;
      enableWind.checked = false;
      enableEndless.checked = false;
      enableAmbiance.checked = false;
      if(backgroundType.value !== 'theme'){ backgroundType.value = 'theme'; updateWallpaper(); }
    } else {
      if(lastSnapshot){ applySettings(lastSnapshot); lastSnapshot = null; }
    }
    applyAmbianceSettings();
    if(!silent) saveData();
  }

  function collectSettings(){
    return {
      animations: { style: animationStyleSelect.value, intensity: animIntensity.value, scale: emissionScale.value, holdRate: holdRate.value, size: bubbleSize.value, speed: bubbleSpeed.value, life: bubbleLifeSlider.value, shape: shapeSelect.value, outline: bubbleOutline.value, colorMode: colorMode.value, color: bubbleColor.value, startColor: bubbleStartColor.value, endColor: bubbleEndColor.value, contain: containParticles.checked },
      wind: { enabled: enableWind.checked, pattern: windPattern.value, intensity: windIntensity.value, direction: windDirection.value },
      toggles: { animations: enableAnimations.checked, endless: enableEndless.checked, secCounter: enableSecCounter.checked, clickCounter: enableClickCounter.checked, naturalSlide: enableNaturalSlide.checked, enableScanLine: enableScanLine.checked, clock: enableClock.checked, ambiance: enableAmbiance.checked, customBackground: enableCustomBackground.checked },
      appearance: { glassOpacity: glassOpacity.value, glassBlur: glassBlurSlider.value, glassSaturation: glassSaturationSlider.value, glassBorder: glassBorderSlider.value, uiStyle: uiStyleSelect.value, dark: document.documentElement.classList.contains('dark'), backgroundType: backgroundType.value, wallpaperFit: wallpaperFit.value, colorWallpaperType: colorWallpaperType.value, wallpaperColor1: wallpaperColor1.value, wallpaperColor2: wallpaperColor2.value, wallpaperColor3: wallpaperColor3.value, gradientAngle: gradientAngle.value, gradientSpread: gradientSpread.value, gradientSpinEnabled: gradientSpinToggle.checked, gradientSpinSpeed: gradientSpinSpeed.value },
      completion: { checkedColor: completionCheckedColor.value, uncheckedColor: completionUncheckedColor.value, inProgressColor: completionInProgressColor.value, glow: completionGlow.value, speed: completionSpeed.value, scanAngle: scanAngle.value },
      ambiance: { effect: ambianceSelect.value, snowDensity: snowDensity.value, snowSize: snowSize.value, snowSpeed: snowSpeed.value, orbsDensity: orbsDensity.value, orbsSize: orbsSize.value, orbsSpeed: orbsSpeed.value, orbsColor: orbsColor.value, starfieldDensity: starfieldDensity.value, starfieldSize: starfieldSize.value, starfieldSpeed: starfieldSpeed.value, matrixDensity: matrixDensity.value, matrixSize: matrixSize.value, matrixSpeed: matrixSpeed.value, matrixColor: matrixColor.value },
      slideSpeed: slideSpeed.value,
      clock: { position: clockPosition.value, detail: clockDetail.value },
      sections: { checkmark: secCheckmarkAnims.querySelector('details').open, animStyle: secAnimStyle.open, wind: secWind.open, patterns: secPatterns.open, appearance: secAppearance.querySelector('details').open, background: secBackground.open, utility: secUtility.querySelector('details').open }
    };
  }

  function applySettings(s) {
      if (!s) return;
      if (s.animations) {
          animationStyleSelect.value = s.animations.style; animIntensity.value = s.animations.intensity; emissionScale.value = s.animations.scale; holdRate.value = s.animations.holdRate;
          bubbleSize.value = s.animations.size; bubbleSpeed.value = s.animations.speed; bubbleLifeSlider.value = s.animations.life;
          shapeSelect.value = s.animations.shape; bubbleOutline.value = s.animations.outline; colorMode.value = s.animations.colorMode;
          bubbleColor.value = s.animations.color; bubbleStartColor.value = s.animations.startColor; bubbleEndColor.value = s.animations.endColor;
          containParticles.checked = s.animations.contain;
      }
      if (s.wind) {
          enableWind.checked = s.wind.enabled; windPattern.value = s.wind.pattern;
          windIntensity.value = s.wind.intensity; windDirection.value = s.wind.direction;
      }
      if (s.toggles) {
          enableAnimations.checked = s.toggles.animations; enableEndless.checked = s.toggles.endless;
          enableSecCounter.checked = s.toggles.secCounter; enableClickCounter.checked = s.toggles.clickCounter;
          enableNaturalSlide.checked = s.toggles.naturalSlide;
          enableScanLine.checked = s.toggles.enableScanLine;
          enableClock.checked = s.toggles.clock;
          enableAmbiance.checked = s.toggles.ambiance;
          enableCustomBackground.checked = s.toggles.customBackground;
      }
      if (s.appearance) {
          glassOpacity.value = s.appearance.glassOpacity;
          glassBlurSlider.value = s.appearance.glassBlur;
          glassSaturationSlider.value = s.appearance.glassSaturation;
          glassBorderSlider.value = s.appearance.glassBorder;
          populateStyleSelector();
          uiStyleSelect.value = s.appearance.uiStyle;
          document.documentElement.classList.toggle('dark', s.appearance.dark);
          darkToggle.innerHTML = s.appearance.dark ? '☀️ Light' : '🌙 Dark';
          backgroundType.value = s.appearance.backgroundType; wallpaperFit.value = s.appearance.wallpaperFit;
          colorWallpaperType.value = s.appearance.colorWallpaperType; wallpaperColor1.value = s.appearance.wallpaperColor1;
          wallpaperColor2.value = s.appearance.wallpaperColor2; wallpaperColor3.value = s.appearance.wallpaperColor3;
          gradientAngle.value = s.appearance.gradientAngle; gradientSpread.value = s.appearance.gradientSpread || '0';
          gradientSpinToggle.checked = s.appearance.gradientSpinEnabled || false;
          gradientSpinSpeed.value = s.appearance.gradientSpinSpeed || '10';
      }
      if (s.completion) {
          completionCheckedColor.value = s.completion.checkedColor;
          completionUncheckedColor.value = s.completion.uncheckedColor;
          completionInProgressColor.value = s.completion.inProgressColor || '#3b82f6';
          completionGlow.value = s.completion.glow;
          completionSpeed.value = s.completion.speed;
          scanAngle.value = s.completion.scanAngle || '180';
      }
      if (s.ambiance) {
          ambianceSelect.value = s.ambiance.effect;
          snowDensity.value = s.ambiance.snowDensity; snowSize.value = s.ambiance.snowSize; snowSpeed.value = s.ambiance.snowSpeed;
          orbsDensity.value = s.ambiance.orbsDensity; orbsSize.value = s.ambiance.orbsSize; orbsSpeed.value = s.ambiance.orbsSpeed; orbsColor.value = s.ambiance.orbsColor;
          starfieldDensity.value = s.ambiance.starfieldDensity; starfieldSize.value = s.ambiance.starfieldSize; starfieldSpeed.value = s.ambiance.starfieldSpeed;
          matrixDensity.value = s.ambiance.matrixDensity; matrixSize.value = s.ambiance.matrixSize; matrixSpeed.value = s.ambiance.matrixSpeed; matrixColor.value = s.ambiance.matrixColor;
      }
      if (s.clock) {
          clockPosition.value = s.clock.position; clockDetail.value = s.clock.detail;
      }
      if (s.sections) {
        secCheckmarkAnims.querySelector('details').open = s.sections.checkmark; secAnimStyle.open = s.sections.animStyle;
        secWind.open = s.sections.wind; secPatterns.open = s.sections.patterns;
        secAppearance.querySelector('details').open = s.sections.appearance; secBackground.open = s.sections.background;
        secUtility.querySelector('details').open = s.sections.utility;
      }
      slideSpeed.value = s.slideSpeed || '800';
      applyAllSettings();
  }

  /* ---------- Color mode UI visibility ---------- */
  function syncColorControlVisibility(){ const mode=colorMode.value; singleColorRow.style.display = (mode==='single')?'block':'none'; const fade=(mode==='fade'); startColorRow.style.display=fade?'block':'none'; endColorRow.style.display=fade?'block':'none'; }

  /* ---------- Percent labels ---------- */
  function updatePercentages(){ 
    const pctOf=(el)=> Math.round(((parseFloat(el.value)-parseFloat(el.min))/(parseFloat(el.max)-parseFloat(el.min)))*100); 
    pct.anim.textContent=pctOf(animIntensity)+'%'; pct.escale.textContent=pctOf(emissionScale)+'%'; pct.hold.textContent=pctOf(holdRate)+'%'; 
    pct.size.textContent=pctOf(bubbleSize)+'%'; pct.speed.textContent=pctOf(bubbleSpeed)+'%';
    pct.windI.textContent=pctOf(windIntensity)+'%'; pct.windDir.textContent=pctOf(windDirection)+'%';
    pct.glass.textContent=Math.max(10, Math.min(100, parseInt(glassOpacity.value,10)||75)) + '%'; 
    pct.slide.textContent = slideSpeed.value + 'ms';
    pct.completionGlow.textContent = completionGlow.value + 'px';
    pct.completionSpeed.textContent = completionSpeed.value + 'ms';
    pct.snowDensity.textContent=pctOf(snowDensity)+'%'; pct.snowSize.textContent=pctOf(snowSize)+'%'; pct.snowSpeed.textContent=pctOf(snowSpeed)+'%';
    pct.orbsDensity.textContent=pctOf(orbsDensity)+'%'; pct.orbsSize.textContent=pctOf(orbsSize)+'%'; pct.orbsSpeed.textContent=pctOf(orbsSpeed)+'%';
    pct.starfieldDensity.textContent=pctOf(starfieldDensity)+'%'; pct.starfieldSize.textContent=pctOf(starfieldSize)+'%'; pct.starfieldSpeed.textContent=pctOf(starfieldSpeed)+'%';
    pct.matrixDensity.textContent=pctOf(matrixDensity)+'%'; pct.matrixSize.textContent=pctOf(matrixSize)+'%'; pct.matrixSpeed.textContent=pctOf(matrixSpeed)+'%';
    if(pct.gradientAngle) pct.gradientAngle.textContent=`${Math.round(gradientAngle.value)}°`;
    if(pct.gradientSpread) pct.gradientSpread.textContent=pctOf(gradientSpread)+'%';
    if(pct.gradientSpinSpeed) pct.gradientSpinSpeed.textContent=pctOf(gradientSpinSpeed)+'%';
    if(pct.scanAngle) pct.scanAngle.textContent = `${scanAngle.value}°`;
  }

  /* ---------- Slide speed ---------- */
  function applySlideSpeed(){
    const ms = Math.max(80, Math.min(2000, parseInt(slideSpeed.value,10)||800));
    document.documentElement.style.setProperty('--slide-duration', ms+'ms');
    pct.slide.textContent = ms+'ms';
  }
  
  /* ---------- Resets & Presets ---------- */
  const animationPresets = {
    bubbles: [
        { name: "Default Bubbles", settings: { animIntensity: "3", emissionScale: "70", holdRate: "35", bubbleSize: "6", bubbleSpeed: "7", bubbleLife: "72", shape: "circle", bubbleOutline: "none", colorMode: "single", bubbleColor: "#16a34a", bubbleStartColor: "#4ade80", bubbleEndColor: "#16a34a", enableWind: false, windPattern: "inward", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Rainbow Pop", settings: { animIntensity: "20", emissionScale: "100", holdRate: "35", bubbleSize: "8", bubbleSpeed: "8", bubbleLife: "120", shape: "random", bubbleOutline: "thinWhite", colorMode: "tie", bubbleColor: "#16a34a", bubbleStartColor: "#4ade80", bubbleEndColor: "#16a34a", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Gentle Drift", settings: { animIntensity: "5", emissionScale: "50", holdRate: "35", bubbleSize: "10", bubbleSpeed: "1", bubbleLife: "600", shape: "circle", bubbleOutline: "none", colorMode: "fade", bubbleColor: "#16a34a", bubbleStartColor: "#a8d5e2", bubbleEndColor: "#f0f8ff", enableWind: true, windPattern: "sine", windIntensity: "10", windDirection: "90", containParticles: true } },
        { name: "Tiny Fizz", settings: { animIntensity: "200", emissionScale: "20", holdRate: "35", bubbleSize: "2", bubbleSpeed: "10", bubbleLife: "45", shape: "circle", bubbleOutline: "none", colorMode: "single", bubbleColor: "#ffffff", bubbleStartColor: "#4ade80", bubbleEndColor: "#16a34a", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Heart Burst", settings: { animIntensity: "15", emissionScale: "80", holdRate: "35", bubbleSize: "9", bubbleSpeed: "6", bubbleLife: "150", shape: "heart", bubbleOutline: "none", colorMode: "fade", bubbleColor: "#16a34a", bubbleStartColor: "#ff8fab", bubbleEndColor: "#ffc2d1", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Cosmic Stars", settings: { animIntensity: "30", emissionScale: "120", holdRate: "35", bubbleSize: "7", bubbleSpeed: "5", bubbleLife: "300", shape: "star", bubbleOutline: "thinWhite", colorMode: "fade", bubbleColor: "#16a34a", bubbleStartColor: "#ffffff", bubbleEndColor: "#93c5fd", enableWind: true, windPattern: "push1", windIntensity: "20", windDirection: "0", containParticles: true } },
        { name: "Square Tech", settings: { animIntensity: "50", emissionScale: "60", holdRate: "35", bubbleSize: "5", bubbleSpeed: "4", bubbleLife: "180", shape: "square", bubbleOutline: "accent", colorMode: "single", bubbleColor: "#0ea5e9", bubbleStartColor: "#4ade80", bubbleEndColor: "#16a34a", enableWind: true, windPattern: "gusts", windIntensity: "15", windDirection: "270", containParticles: true } },
        { name: "Lava Lamp", settings: { animIntensity: "4", emissionScale: "40", holdRate: "10", bubbleSize: "20", bubbleSpeed: "1", bubbleLife: "900", shape: "circle", bubbleOutline: "none", colorMode: "fade", bubbleColor: "#16a34a", bubbleStartColor: "#ff4500", bubbleEndColor: "#ff8c00", enableWind: true, windPattern: "sine", windIntensity: "5", windDirection: "0", containParticles: true } },
        { name: "Confetti Cannon", settings: { animIntensity: "100", emissionScale: "150", holdRate: "35", bubbleSize: "4", bubbleSpeed: "18", bubbleLife: "120", shape: "random", bubbleOutline: "none", colorMode: "party", bubbleColor: "#16a34a", bubbleStartColor: "#4ade80", bubbleEndColor: "#16a34a", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Under the Sea", settings: { animIntensity: "10", emissionScale: "100", holdRate: "35", bubbleSize: "8", bubbleSpeed: "2", bubbleLife: "450", shape: "circle", bubbleOutline: "none", colorMode: "fade", bubbleColor: "#16a34a", bubbleStartColor: "#48cae4", bubbleEndColor: "#0077b6", enableWind: true, windPattern: "sine", windIntensity: "8", windDirection: "90", containParticles: true } },
        { name: "Bouncy Balls", settings: { animIntensity: "25", emissionScale: "100", holdRate: "35", bubbleSize: "7", bubbleSpeed: "5", bubbleLife: "600", shape: "circle", bubbleOutline: "thinBlack", colorMode: "tie", bubbleColor: "#16a34a", bubbleStartColor: "#4ade80", bubbleEndColor: "#16a34a", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: true } },
        { name: "Ghostly Apparitions", settings: { animIntensity: "2", emissionScale: "60", holdRate: "35", bubbleSize: "20", bubbleSpeed: "1", bubbleLife: "1200", shape: "circle", bubbleOutline: "none", colorMode: "fade", bubbleColor: "#16a34a", bubbleStartColor: "#ffffff", bubbleEndColor: "#f0f8ff", enableWind: true, windPattern: "sine", windIntensity: "5", windDirection: "180", containParticles: true } },
        { name: "Crystal Shards", settings: { animIntensity: "80", emissionScale: "90", holdRate: "35", bubbleSize: "6", bubbleSpeed: "15", bubbleLife: "90", shape: "triangle", bubbleOutline: "accent", colorMode: "single", bubbleColor: "#81e6d9", bubbleStartColor: "#4ade80", bubbleEndColor: "#16a34a", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Heatmap", settings: { animIntensity: "30", emissionScale: "100", holdRate: "35", bubbleSize: "6", bubbleSpeed: "10", bubbleLife: "180", shape: "circle", bubbleOutline: "none", colorMode: "velocityHeatmap", bubbleColor: "#16a34a", bubbleStartColor: "#4ade80", bubbleEndColor: "#16a34a", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } }
    ],
    splash: [
        { name: "Default Splash", settings: { animIntensity: "150", emissionScale: "80", holdRate: "20", bubbleSize: "3", bubbleSpeed: "12", bubbleLife: "60", shape: "circle", bubbleOutline: "none", colorMode: "fade", bubbleColor: "#aaddff", bubbleStartColor: "#d4f1ff", bubbleEndColor: "#87CEEB", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Mud Splatter", settings: { animIntensity: "120", emissionScale: "70", holdRate: "20", bubbleSize: "5", bubbleSpeed: "8", bubbleLife: "75", shape: "circle", bubbleOutline: "none", colorMode: "fade", bubbleColor: "#aaddff", bubbleStartColor: "#8b5e34", bubbleEndColor: "#6a4a2a", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Paint Splatter", settings: { animIntensity: "200", emissionScale: "100", holdRate: "20", bubbleSize: "4", bubbleSpeed: "15", bubbleLife: "90", shape: "circle", bubbleOutline: "none", colorMode: "tie", bubbleColor: "#aaddff", bubbleStartColor: "#d4f1ff", bubbleEndColor: "#87CEEB", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Lava Burst", settings: { animIntensity: "80", emissionScale: "90", holdRate: "20", bubbleSize: "8", bubbleSpeed: "6", bubbleLife: "120", shape: "circle", bubbleOutline: "none", colorMode: "fade", bubbleColor: "#aaddff", bubbleStartColor: "#ffcc00", bubbleEndColor: "#ff4500", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Ink Blot", settings: { animIntensity: "180", emissionScale: "60", holdRate: "20", bubbleSize: "6", bubbleSpeed: "10", bubbleLife: "50", shape: "circle", bubbleOutline: "none", colorMode: "single", bubbleColor: "#000000", bubbleStartColor: "#d4f1ff", bubbleEndColor: "#87CEEB", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Slime Splash", settings: { animIntensity: "100", emissionScale: "75", holdRate: "20", bubbleSize: "7", bubbleSpeed: "7", bubbleLife: "100", shape: "circle", bubbleOutline: "none", colorMode: "fade", bubbleColor: "#aaddff", bubbleStartColor: "#adff2f", bubbleEndColor: "#7cfc00", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Fountain Jet", settings: { animIntensity: "200", emissionScale: "30", holdRate: "20", bubbleSize: "2", bubbleSpeed: "20", bubbleLife: "180", shape: "circle", bubbleOutline: "none", colorMode: "single", bubbleColor: "#e0ffff", bubbleStartColor: "#d4f1ff", bubbleEndColor: "#87CEEB", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Chocolate Syrup", settings: { animIntensity: "100", emissionScale: "80", holdRate: "20", bubbleSize: "6", bubbleSpeed: "5", bubbleLife: "110", shape: "circle", bubbleOutline: "none", colorMode: "fade", bubbleColor: "#aaddff", bubbleStartColor: "#7b3f00", bubbleEndColor: "#4a2500", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Fairy Dust", settings: { animIntensity: "200", emissionScale: "100", holdRate: "20", bubbleSize: "2", bubbleSpeed: "12", bubbleLife: "120", shape: "star", bubbleOutline: "none", colorMode: "party", bubbleColor: "#aaddff", bubbleStartColor: "#d4f1ff", bubbleEndColor: "#87CEEB", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Blood Splatter", settings: { animIntensity: "160", emissionScale: "90", holdRate: "20", bubbleSize: "4", bubbleSpeed: "16", bubbleLife: "50", shape: "circle", bubbleOutline: "none", colorMode: "fade", bubbleColor: "#aaddff", bubbleStartColor: "#dc143c", bubbleEndColor: "#8b0000", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Nebula Cloud", settings: { animIntensity: "20", emissionScale: "150", holdRate: "20", bubbleSize: "15", bubbleSpeed: "1", bubbleLife: "600", shape: "circle", bubbleOutline: "none", colorMode: "fade", bubbleColor: "#aaddff", bubbleStartColor: "#480ca8", bubbleEndColor: "#f72585", enableWind: true, windPattern: "inward", windIntensity: "10", windDirection: "0", containParticles: true } },
        { name: "Liquid Gold", settings: { animIntensity: "180", emissionScale: "80", holdRate: "20", bubbleSize: "3", bubbleSpeed: "9", bubbleLife: "80", shape: "circle", bubbleOutline: "none", colorMode: "fade", bubbleColor: "#aaddff", bubbleStartColor: "#fff700", bubbleEndColor: "#ffd700", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Glitch", settings: { animIntensity: "200", emissionScale: "120", holdRate: "20", bubbleSize: "5", bubbleSpeed: "22", bubbleLife: "30", shape: "square", bubbleOutline: "none", colorMode: "party", bubbleColor: "#aaddff", bubbleStartColor: "#d4f1ff", bubbleEndColor: "#87CEEB", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Heatmap Splash", settings: { animIntensity: "150", emissionScale: "80", holdRate: "20", bubbleSize: "4", bubbleSpeed: "14", bubbleLife: "70", shape: "circle", bubbleOutline: "none", colorMode: "velocityHeatmap", bubbleColor: "#aaddff", bubbleStartColor: "#d4f1ff", bubbleEndColor: "#87CEEB", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } }
    ],
    fireworks: [
        { name: "Default Firework", settings: { animIntensity: "14", emissionScale: "70", holdRate: "35", bubbleSize: "6", bubbleSpeed: "3", bubbleLife: "239", shape: "circle", bubbleOutline: "none", colorMode: "fade", bubbleColor: "#16a34a", bubbleStartColor: "#ff0000", bubbleEndColor: "#fbff00", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Grand Finale", settings: { animIntensity: "50", emissionScale: "150", holdRate: "35", bubbleSize: "8", bubbleSpeed: "4", bubbleLife: "300", shape: "circle", bubbleOutline: "none", colorMode: "tie", bubbleColor: "#16a34a", bubbleStartColor: "#ff0000", bubbleEndColor: "#fbff00", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Blue Peony", settings: { animIntensity: "15", emissionScale: "80", holdRate: "35", bubbleSize: "7", bubbleSpeed: "3", bubbleLife: "250", shape: "circle", bubbleOutline: "none", colorMode: "fade", bubbleColor: "#16a34a", bubbleStartColor: "#87cefa", bubbleEndColor: "#0000cd", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Crackling Stars", settings: { animIntensity: "25", emissionScale: "100", holdRate: "35", bubbleSize: "5", bubbleSpeed: "5", bubbleLife: "200", shape: "star", bubbleOutline: "none", colorMode: "fade", bubbleColor: "#16a34a", bubbleStartColor: "#ffffff", bubbleEndColor: "#ffff00", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Silent Night", settings: { animIntensity: "10", emissionScale: "60", holdRate: "35", bubbleSize: "6", bubbleSpeed: "2", bubbleLife: "350", shape: "circle", bubbleOutline: "none", colorMode: "fade", bubbleColor: "#16a34a", bubbleStartColor: "#ffffff", bubbleEndColor: "#d3d3d3", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Ground Spinner", settings: { animIntensity: "40", emissionScale: "50", holdRate: "35", bubbleSize: "4", bubbleSpeed: "1", bubbleLife: "180", shape: "circle", bubbleOutline: "none", colorMode: "tie", bubbleColor: "#16a34a", bubbleStartColor: "#ff0000", bubbleEndColor: "#fbff00", enableWind: true, windPattern: "push2", windIntensity: "40", windDirection: "0", containParticles: true } },
        { name: "Willow Tree", settings: { animIntensity: "12", emissionScale: "90", holdRate: "35", bubbleSize: "3", bubbleSpeed: "4", bubbleLife: "600", shape: "circle", bubbleOutline: "none", colorMode: "fade", bubbleColor: "#16a34a", bubbleStartColor: "#ffd700", bubbleEndColor: "#ffa500", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Patriotic Burst", settings: { animIntensity: "20", emissionScale: "90", holdRate: "35", bubbleSize: "7", bubbleSpeed: "3", bubbleLife: "260", shape: "circle", bubbleOutline: "none", colorMode: "fade", bubbleColor: "#16a34a", bubbleStartColor: "#ff0000", bubbleEndColor: "#0000ff", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Emerald Sky", settings: { animIntensity: "18", emissionScale: "85", holdRate: "35", bubbleSize: "6", bubbleSpeed: "4", bubbleLife: "280", shape: "circle", bubbleOutline: "none", colorMode: "fade", bubbleColor: "#16a34a", bubbleStartColor: "#ffffff", bubbleEndColor: "#00ff7f", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Heart in the Sky", settings: { animIntensity: "1", emissionScale: "100", holdRate: "35", bubbleSize: "10", bubbleSpeed: "3", bubbleLife: "300", shape: "heart", bubbleOutline: "none", colorMode: "single", bubbleColor: "#ff1493", bubbleStartColor: "#ff0000", bubbleEndColor: "#fbff00", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Distant Storm", settings: { animIntensity: "5", emissionScale: "200", holdRate: "35", bubbleSize: "4", bubbleSpeed: "6", bubbleLife: "400", shape: "circle", bubbleOutline: "none", colorMode: "fade", bubbleColor: "#16a34a", bubbleStartColor: "#ffffff", bubbleEndColor: "#add8e6", enableWind: true, windPattern: "gusts", windIntensity: "30", windDirection: "270", containParticles: true } },
        { name: "Party Popper", settings: { animIntensity: "30", emissionScale: "110", holdRate: "35", bubbleSize: "5", bubbleSpeed: "5", bubbleLife: "220", shape: "random", bubbleOutline: "none", colorMode: "party", bubbleColor: "#16a34a", bubbleStartColor: "#ff0000", bubbleEndColor: "#fbff00", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Chrysanthemum", settings: { animIntensity: "22", emissionScale: "100", holdRate: "35", bubbleSize: "6", bubbleSpeed: "4", bubbleLife: "250", shape: "circle", bubbleOutline: "none", colorMode: "velocityHeatmap", bubbleColor: "#16a34a", bubbleStartColor: "#ff0000", bubbleEndColor: "#fbff00", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Screen Space", settings: { animIntensity: "25", emissionScale: "120", holdRate: "35", bubbleSize: "7", bubbleSpeed: "3", bubbleLife: "300", shape: "circle", bubbleOutline: "none", colorMode: "screenSpace", bubbleColor: "#16a34a", bubbleStartColor: "#ff0000", bubbleEndColor: "#fbff00", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } }
    ],
    energy: [
        { name: "Default Energy Pulse", settings: { animIntensity: "113", emissionScale: "70", holdRate: "35", bubbleSize: "14", bubbleSpeed: "3", bubbleLife: "319", shape: "circle", bubbleOutline: "none", colorMode: "tie", bubbleColor: "#16a34a", bubbleStartColor: "#ff0000", bubbleEndColor: "#fbff00", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Electric Blue", settings: { animIntensity: "150", emissionScale: "50", holdRate: "35", bubbleSize: "10", bubbleSpeed: "10", bubbleLife: "60", shape: "circle", bubbleOutline: "none", colorMode: "fade", bubbleColor: "#16a34a", bubbleStartColor: "#00ffff", bubbleEndColor: "#0000ff", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Solar Flare", settings: { animIntensity: "80", emissionScale: "120", holdRate: "35", bubbleSize: "20", bubbleSpeed: "2", bubbleLife: "400", shape: "circle", bubbleOutline: "none", colorMode: "fade", bubbleColor: "#16a34a", bubbleStartColor: "#ffff00", bubbleEndColor: "#ff4500", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Void Pulse", settings: { animIntensity: "100", emissionScale: "80", holdRate: "35", bubbleSize: "15", bubbleSpeed: "4", bubbleLife: "300", shape: "circle", bubbleOutline: "none", colorMode: "fade", bubbleColor: "#16a34a", bubbleStartColor: "#4b0082", bubbleEndColor: "#000000", enableWind: true, windPattern: "inward", windIntensity: "25", windDirection: "0", containParticles: true } },
        { name: "Green Matrix", settings: { animIntensity: "200", emissionScale: "40", holdRate: "35", bubbleSize: "8", bubbleSpeed: "8", bubbleLife: "150", shape: "square", bubbleOutline: "none", colorMode: "single", bubbleColor: "#00ff00", bubbleStartColor: "#ff0000", bubbleEndColor: "#fbff00", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Power Up", settings: { animIntensity: "180", emissionScale: "90", holdRate: "35", bubbleSize: "12", bubbleSpeed: "5", bubbleLife: "240", shape: "star", bubbleOutline: "none", colorMode: "fade", bubbleColor: "#16a34a", bubbleStartColor: "#ffffff", bubbleEndColor: "#ffd700", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Sonic Boom", settings: { animIntensity: "50", emissionScale: "200", holdRate: "35", bubbleSize: "2", bubbleSpeed: "24", bubbleLife: "40", shape: "circle", bubbleOutline: "thinWhite", colorMode: "single", bubbleColor: "#ffffff", bubbleStartColor: "#ff0000", bubbleEndColor: "#fbff00", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Warp Drive", settings: { animIntensity: "120", emissionScale: "100", holdRate: "35", bubbleSize: "3", bubbleSpeed: "15", bubbleLife: "300", shape: "circle", bubbleOutline: "none", colorMode: "fade", bubbleColor: "#16a34a", bubbleStartColor: "#ffffff", bubbleEndColor: "#8ecae6", enableWind: true, windPattern: "push2", windIntensity: "50", windDirection: "0", containParticles: false } },
        { name: "Magic Missile", settings: { animIntensity: "100", emissionScale: "60", holdRate: "35", bubbleSize: "10", bubbleSpeed: "6", bubbleLife: "200", shape: "triangle", bubbleOutline: "none", colorMode: "fade", bubbleColor: "#16a34a", bubbleStartColor: "#da70d6", bubbleEndColor: "#9400d3", enableWind: true, windPattern: "push1", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Healing Aura", settings: { animIntensity: "40", emissionScale: "100", holdRate: "35", bubbleSize: "18", bubbleSpeed: "1", bubbleLife: "500", shape: "circle", bubbleOutline: "none", colorMode: "fade", bubbleColor: "#16a34a", bubbleStartColor: "#fafad2", bubbleEndColor: "#ffd700", enableWind: true, windPattern: "inward", windIntensity: "15", windDirection: "0", containParticles: true } },
        { name: "Ball Lightning", settings: { animIntensity: "10", emissionScale: "80", holdRate: "35", bubbleSize: "12", bubbleSpeed: "8", bubbleLife: "250", shape: "circle", bubbleOutline: "none", colorMode: "fade", bubbleColor: "#16a34a", bubbleStartColor: "#ffffff", bubbleEndColor: "#ffff00", enableWind: true, windPattern: "gusts", windIntensity: "60", windDirection: "45", containParticles: true } },
        { name: "Fractal Burst", settings: { animIntensity: "200", emissionScale: "90", holdRate: "35", bubbleSize: "4", bubbleSpeed: "12", bubbleLife: "80", shape: "square", bubbleOutline: "none", colorMode: "screenSpace", bubbleColor: "#16a34a", bubbleStartColor: "#ff0000", bubbleEndColor: "#fbff00", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Rage Pulse", settings: { animIntensity: "130", emissionScale: "110", holdRate: "35", bubbleSize: "16", bubbleSpeed: "6", bubbleLife: "180", shape: "circle", bubbleOutline: "none", colorMode: "fade", bubbleColor: "#16a34a", bubbleStartColor: "#ff4500", bubbleEndColor: "#dc143c", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Party Energy", settings: { animIntensity: "160", emissionScale: "100", holdRate: "35", bubbleSize: "10", bubbleSpeed: "8", bubbleLife: "200", shape: "random", bubbleOutline: "none", colorMode: "party", bubbleColor: "#16a34a", bubbleStartColor: "#ff0000", bubbleEndColor: "#fbff00", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } }
    ],
    boomerang: [
        { name: "Default Boomerang", settings: { animIntensity: "1", emissionScale: "100", holdRate: "35", bubbleSize: "12", bubbleSpeed: "10", bubbleLife: "400", shape: "boomerang", bubbleOutline: "none", colorMode: "single", bubbleColor: "#cd853f", bubbleStartColor: "#ff0000", bubbleEndColor: "#fbff00", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Vortex Return", settings: { animIntensity: "3", emissionScale: "100", holdRate: "35", bubbleSize: "10", bubbleSpeed: "12", bubbleLife: "600", shape: "boomerang", bubbleOutline: "none", colorMode: "tie", bubbleColor: "#cd853f", bubbleStartColor: "#ff0000", bubbleEndColor: "#fbff00", enableWind: true, windPattern: "vortex", windIntensity: "15", windDirection: "0", containParticles: true } },
        { name: "Heat-Seeking", settings: { animIntensity: "1", emissionScale: "100", holdRate: "35", bubbleSize: "10", bubbleSpeed: "15", bubbleLife: "300", shape: "boomerang", bubbleOutline: "none", colorMode: "velocityHeatmap", bubbleColor: "#cd853f", bubbleStartColor: "#ff0000", bubbleEndColor: "#fbff00", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Ghostly Return", settings: { animIntensity: "1", emissionScale: "100", holdRate: "35", bubbleSize: "15", bubbleSpeed: "8", bubbleLife: "800", shape: "boomerang", bubbleOutline: "none", colorMode: "fade", bubbleColor: "#cd853f", bubbleStartColor: "#ffffff", bubbleEndColor: "#e6e6fa", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Crosswind Challenge", settings: { animIntensity: "2", emissionScale: "100", holdRate: "35", bubbleSize: "11", bubbleSpeed: "14", bubbleLife: "500", shape: "boomerang", bubbleOutline: "none", colorMode: "single", bubbleColor: "#a0522d", bubbleStartColor: "#ff0000", bubbleEndColor: "#fbff00", enableWind: true, windPattern: "crosswind", windIntensity: "40", windDirection: "90", containParticles: true } },
        { name: "Party Time", settings: { animIntensity: "4", emissionScale: "100", holdRate: "35", bubbleSize: "9", bubbleSpeed: "11", bubbleLife: "450", shape: "boomerang", bubbleOutline: "none", colorMode: "party", bubbleColor: "#cd853f", bubbleStartColor: "#ff0000", bubbleEndColor: "#fbff00", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Slow & Steady", settings: { animIntensity: "1", emissionScale: "80", holdRate: "35", bubbleSize: "14", bubbleSpeed: "6", bubbleLife: "1200", shape: "boomerang", bubbleOutline: "none", colorMode: "single", bubbleColor: "#8b4513", bubbleStartColor: "#ff0000", bubbleEndColor: "#fbff00", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Screen Space Arc", settings: { animIntensity: "2", emissionScale: "100", holdRate: "35", bubbleSize: "10", bubbleSpeed: "13", bubbleLife: "400", shape: "boomerang", bubbleOutline: "none", colorMode: "screenSpace", bubbleColor: "#cd853f", bubbleStartColor: "#ff0000", bubbleEndColor: "#fbff00", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Sharp Throw", settings: { animIntensity: "1", emissionScale: "100", holdRate: "35", bubbleSize: "8", bubbleSpeed: "20", bubbleLife: "250", shape: "boomerang", bubbleOutline: "thinBlack", colorMode: "single", bubbleColor: "#f5f5dc", bubbleStartColor: "#ff0000", bubbleEndColor: "#fbff00", enableWind: false, windPattern: "steady", windIntensity: "30", windDirection: "0", containParticles: false } },
        { name: "Push Back", settings: { animIntensity: "3", emissionScale: "100", holdRate: "35", bubbleSize: "9", bubbleSpeed: "12", bubbleLife: "500", shape: "boomerang", bubbleOutline: "none", colorMode: "tie", bubbleColor: "#cd853f", bubbleStartColor: "#ff0000", bubbleEndColor: "#fbff00", enableWind: true, windPattern: "push1", windIntensity: "25", windDirection: "0", containParticles: false } },
        { name: "Unstable Flight", settings: { animIntensity: "2", emissionScale: "100", holdRate: "35", bubbleSize: "11", bubbleSpeed: "10", bubbleLife: "600", shape: "boomerang", bubbleOutline: "none", colorMode: "velocityHeatmap", bubbleColor: "#cd853f", bubbleStartColor: "#ff0000", bubbleEndColor: "#fbff00", enableWind: true, windPattern: "gusts", windIntensity: "30", windDirection: "180", containParticles: true } },
        { name: "Orbital Decay", settings: { animIntensity: "5", emissionScale: "100", holdRate: "35", bubbleSize: "8", bubbleSpeed: "14", bubbleLife: "800", shape: "boomerang", bubbleOutline: "none", colorMode: "fade", bubbleColor: "#cd853f", bubbleStartColor: "#ff4500", bubbleEndColor: "#4b0082", enableWind: true, windPattern: "vortex", windIntensity: "5", windDirection: "0", containParticles: true } }
    ],
    lightning: [
        { name: "Thunder Strike", settings: { animIntensity: "5", emissionScale: "100", holdRate: "20", bubbleSize: "4", bubbleSpeed: "20", bubbleLife: "60", shape: "circle", bubbleOutline: "none", colorMode: "fade", bubbleColor: "#ffffff", bubbleStartColor: "#ffffff", bubbleEndColor: "#add8e6", enableWind: true, windPattern: "gusts", windIntensity: "50", windDirection: "180", containParticles: false } },
        { name: "Chain Lightning", settings: { animIntensity: "8", emissionScale: "120", holdRate: "25", bubbleSize: "3", bubbleSpeed: "25", bubbleLife: "90", shape: "circle", bubbleOutline: "none", colorMode: "velocityHeatmap", bubbleColor: "#ffffff", bubbleStartColor: "#ffffff", bubbleEndColor: "#add8e6", enableWind: true, windPattern: "crosswind", windIntensity: "40", windDirection: "90", containParticles: false } },
        { name: "Storm Fury", settings: { animIntensity: "10", emissionScale: "150", holdRate: "30", bubbleSize: "5", bubbleSpeed: "30", bubbleLife: "120", shape: "circle", bubbleOutline: "none", colorMode: "party", bubbleColor: "#ffffff", bubbleStartColor: "#ffffff", bubbleEndColor: "#add8e6", enableWind: true, windPattern: "vortex", windIntensity: "60", windDirection: "0", containParticles: false } },
        { name: "Electric Web", settings: { animIntensity: "7", emissionScale: "110", holdRate: "22", bubbleSize: "4", bubbleSpeed: "22", bubbleLife: "80", shape: "circle", bubbleOutline: "none", colorMode: "screenSpace", bubbleColor: "#ffffff", bubbleStartColor: "#ffffff", bubbleEndColor: "#add8e6", enableWind: true, windPattern: "push2", windIntensity: "45", windDirection: "0", containParticles: false } },
        { name: "Plasma Storm", settings: { animIntensity: "12", emissionScale: "140", holdRate: "28", bubbleSize: "6", bubbleSpeed: "28", bubbleLife: "100", shape: "circle", bubbleOutline: "none", colorMode: "tie", bubbleColor: "#ffffff", bubbleStartColor: "#ffffff", bubbleEndColor: "#add8e6", enableWind: true, windPattern: "sine", windIntensity: "55", windDirection: "45", containParticles: false } }
    ]
  };

  function populatePresetSelector(style) {
    animationPresetSelect.innerHTML = '';
    const customOption = document.createElement('option');
    customOption.value = "-1";
    customOption.textContent = "-- Custom --";
    customOption.disabled = true;
    animationPresetSelect.appendChild(customOption);

    const presets = animationPresets[style] || [];
    presets.forEach((preset, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = preset.name;
        animationPresetSelect.appendChild(option);
    });
  }

  function loadPreset(style, presetIndex) {
    const preset = animationPresets[style]?.[presetIndex];
    if (!preset) return;

    if (!enableAnimations.checked) {
        enableAnimations.checked = true;
    }

    Object.keys(preset.settings).forEach(key => {
        let el;
        if (key === 'bubbleLife') {
            el = document.getElementById('bubbleLifeSlider');
        } else if (key === 'shape') {
            el = document.getElementById('shapeSelect');
        } else {
            el = document.getElementById(key) || document.getElementById(`bubble${key.charAt(0).toUpperCase() + key.slice(1)}`);
        }
        
        if (el) {
            if (el.type === 'checkbox') {
                el.checked = preset.settings[key];
            } else {
                el.value = preset.settings[key];
            }
        }
    });
    
    applyAllSettings();
    animationPresetSelect.value = presetIndex;
  }

  function switchToCustomPreset() {
    const loadedOption = document.getElementById('loadedPatternOption');
    if (loadedOption) {
        loadedOption.remove();
    }
    animationPresetSelect.selectedIndex = 0;
  }

  function resetAnimationToDefault() {
    if (!enableAnimations.checked) {
        enableAnimations.checked = true;
    }
    loadPreset(animationStyleSelect.value, 0);
  }

  function panicReset(){
      if(confirm("WARNING: Are you sure you want to perform a Panic Reset?\n\nThis will permanently delete all lists and items, remove your wallpaper, and reset every setting to its factory default.\n\nYour saved animation patterns WILL NOT be deleted.")){
          Object.keys(localStorage)
            .filter(key => key.startsWith('mysparklist.') && key !== 'mysparklist.savedPatterns')
            .forEach(key => localStorage.removeItem(key));
          localStorage.removeItem('mysparklist.hideWelcomeBack'); // Also clear the hide welcome back preference
          location.reload();
      }
  }
  
  function exportState() {
    const currentState = collectSettings();
    const exportData = {
        version: versionTag.textContent,
        timestamp: new Date().toISOString(),
        userAgent: navigator.userAgent,
        settings: {
            animations: currentState.animations,
            wind: currentState.wind,
            toggles: currentState.toggles,
            appearance: currentState.appearance,
            completion: currentState.completion,
            ambiance: currentState.ambiance,
            slideSpeed: currentState.slideSpeed,
            clock: currentState.clock,
            simpleMode: simpleModeToggle.checked
        }
    };

    const jsonString = JSON.stringify(exportData, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const date = new Date().toISOString().slice(0, 10);
    a.download = `mysparklist-state-export-${date}.json`;
    a.href = url;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  /* ---------- Shapes & Drawing ---------- */
  function pickShape(){ const mode = shapeSelect.value; if(mode==='random'){ const all = ['circle','square','triangle','star','heart','hexagon','boomerang']; return all[Math.floor(Math.random()*all.length)]; } return mode; }
  
  function defineShapePath(ctx, shape, size){
    ctx.beginPath();
    switch(shape){
      case 'circle': ctx.arc(0,0,size,0,Math.PI*2); break;
      case 'square': ctx.rect(-size, -size, size*2, size*2); break;
      case 'triangle': { const h = size*1.732; ctx.moveTo(0,-h/2); ctx.lineTo(-size, h/2); ctx.lineTo(size, h/2); break; }
      case 'star': { const spikes=5, outer=size, inner=size*0.5; let rotA=-Math.PI/2; ctx.moveTo(Math.cos(rotA)*outer, Math.sin(rotA)*outer); for(let i=0;i<spikes;i++){ rotA+=Math.PI/spikes; ctx.lineTo(Math.cos(rotA)*inner, Math.sin(rotA)*inner); rotA+=Math.PI/spikes; ctx.lineTo(Math.cos(rotA)*outer, Math.sin(rotA)*outer); } break; }
      case 'heart': { const s = size * 0.06; ctx.moveTo(0, -4*s); for(let i=0;i<=60;i++){ const t = Math.PI*2 * (i/60); const x = 16*Math.sin(t)**3; const y = 13*Math.cos(t) - 5*Math.cos(2*t) - 2*Math.cos(3*t) - Math.cos(4*t); ctx.lineTo(x*s,-y*s);} break; }
      case 'hexagon': { for(let i=0;i<6;i++){ const a = Math.PI/3 * i; const x = size*Math.cos(a), y=size*Math.sin(a); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);} break; }
      case 'boomerang': { const s = size * 0.15; ctx.moveTo(-7*s, 0); ctx.quadraticCurveTo(0, 0, 0, -7*s); ctx.quadraticCurveTo(0, 0, 7*s, 0); ctx.quadraticCurveTo(5*s, 2*s, 0, 5*s); ctx.quadraticCurveTo(-5*s, 2*s, -7*s, 0); break; }
      default: ctx.arc(0,0,size,0,Math.PI*2);
    }
    ctx.closePath();
  }

  function drawParticle(ctx, p){
    const scaledSize = p.size * p.pushScale;
    ctx.save();
    ctx.translate(p.x, p.y);
    ctx.rotate(p.rot || 0);
    
    if (p.animType === 'energy') {
        ctx.lineWidth = scaledSize;
        ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(p.vx, p.vy); ctx.stroke();
    } else {
        defineShapePath(ctx, p.shape, scaledSize);
        ctx.fill();
        const outlineMode = bubbleOutline.value;
        if (p.animType === 'bubbles' && outlineMode !== 'none') {
            ctx.lineWidth = 1;
            if (outlineMode === 'thinBlack') ctx.strokeStyle = 'rgba(0,0,0,0.7)';
            else if (outlineMode === 'thinWhite') ctx.strokeStyle = 'rgba(255,255,255,0.7)';
            else if (outlineMode === 'accent') ctx.strokeStyle = currentAccentColor;
            else if (outlineMode === 'rainbow') ctx.strokeStyle = hslToHex((t * 80 + (p.x + p.y) * 0.2) % 360, 95, 60);
            ctx.stroke();
        }
    }
    ctx.restore();
  }

  function drawLightningBolt(ctx, bolt) {
    ctx.strokeStyle = bolt.color;
    ctx.lineWidth = bolt.width || 2;
    ctx.globalAlpha = bolt.opacity || 1;
    ctx.beginPath();
    ctx.moveTo(bolt.segments[0][0], bolt.segments[0][1]);
    bolt.segments.forEach((seg, i) => {
        if (i > 0) ctx.lineTo(seg[0], seg[1]);
    });
    ctx.stroke();
  }

  /* ---------- Particle Creation & Spawning ---------- */
  function createParticle(x, y, settings) {
    if (particles.length >= PARTICLE_CAP) return null;
    const p = { x, y, ox: x, oy: y, vx: settings.vx ?? 0, vy: settings.vy ?? 0, size: Math.max(1, (settings.size ?? 6) * (0.85 + Math.random() * 0.3)), life: settings.life, lifeMax: settings.life, mode: settings.mode, colorSingle: settings.cSingle, colorStart: settings.cStart, colorEnd: settings.cEnd, shape: settings.shape || 'circle', rot: Math.random() * Math.PI * 2, tieJitter: Math.random() * 120, pushScale: 1, animType: settings.animType, particleType: settings.particleType || 'default', randomOffset: Math.random() * 360 };
    if (p.animType === 'boomerang') { p.rotSpeed = (Math.random() - 0.5) * 0.4; }
    particles.push(p);
    return p;
  }

  function spawnParticlesFromEl(el){ 
    const rect=el.getBoundingClientRect(); 
    const cx = rect.left + rect.width/2, cy = rect.top + rect.height/2; 
    const style = animationStyleSelect.value;
    if (style === 'bubbles') spawnBubblesAtPoint(cx, cy);
    else if (style === 'splash') spawnSplashAtPoint(cx, cy);
    else if (style === 'fireworks') spawnFireworksAtPoint(cx, cy);
    else if (style === 'energy') spawnEnergyAtPoint(cx, cy);
    else if (style === 'boomerang') spawnBoomerangsAtPoint(cx, cy);
    else if (style === 'lightning') spawnLightningAtPoint(cx, cy);
  }

  function getCommonSettings() {
      return { density: Math.max(0, parseInt(animIntensity.value, 10) || 0), scale: (parseInt(emissionScale.value, 10) || 0) / 100, lifeFrames: parseInt(bubbleLifeSlider.value, 10) || 90, speed: parseFloat(bubbleSpeed.value) || 6, mode: colorMode.value, cSingle: bubbleColor.value || '#16a34a', cStart: bubbleStartColor.value || '#16a34a', cEnd: bubbleEndColor.value || '#22c55e', size: Math.max(1, parseFloat(bubbleSize.value) || 6) };
  }
  
  function spawnBubblesAtPoint(cx, cy) {
      const s = getCommonSettings(), count = Math.floor(s.density * 3 * Math.max(0, s.scale)), spread = 8 + Math.min(40, s.density * 0.25);
      for (let i = 0; i < count; i++) {
          const pt = { x: cx + (Math.random() - 0.5) * spread * 2, y: cy + (Math.random() - 0.5) * spread * 2 };
          const p = createParticle(pt.x, pt.y, { ...s, life: s.lifeFrames, animType: 'bubbles', shape: pickShape() });
          if (!p) break;
          p.vx += (Math.random() - 0.5) * s.speed * 0.7; p.vy += -(0.5 + Math.random() * 0.6) * s.speed * 0.6;
      }
  }
  
  function spawnSplashAtPoint(cx, cy) {
      const s = getCommonSettings(), count = Math.floor(s.density * 8 * Math.max(0, s.scale)), spread = 5 + Math.min(20, s.density * 0.1);
      for (let i = 0; i < count; i++) {
          const pt = { x: cx + (Math.random() - 0.5) * spread * 2, y: cy + (Math.random() - 0.5) * spread * 2 };
          const p = createParticle(pt.x, pt.y, { ...s, life: s.lifeFrames * 0.8, animType: 'splash', shape: 'circle', size: s.size * 0.5 });
          if (!p) break;
          const angle = Math.random() * Math.PI * 2, force = (1 + Math.random()) * s.speed * 0.8;
          p.vx = Math.cos(angle) * force; p.vy = Math.sin(angle) * force - s.speed * 0.5;
      }
  }

  function spawnFireworksAtPoint(cx, cy) {
      const s = getCommonSettings(), count = Math.floor(s.density * 0.5 * Math.max(0, s.scale)) + 1;
      for (let i = 0; i < count; i++) {
          const p = createParticle(cx, cy, { ...s, life: s.lifeFrames * 0.5, animType: 'fireworks', particleType: 'rocket', shape: 'circle', size: s.size * 0.5 });
          if (!p) break;
          p.vx = (Math.random() - 0.5) * s.speed * 0.5; p.vy = -s.speed * (1.5 + Math.random() * 0.5);
      }
  }

  function spawnEnergyAtPoint(cx, cy) {
      const s = getCommonSettings(), count = Math.floor(s.density * 2 * Math.max(0, s.scale)), spread = 2;
      for (let i = 0; i < count; i++) {
          const pt = { x: cx + (Math.random() - 0.5) * spread * 2, y: cy + (Math.random() - 0.5) * spread * 2 };
          const p = createParticle(pt.x, pt.y, { ...s, life: s.lifeFrames * 0.4, animType: 'energy', size: s.size * 0.3 });
          if (!p) break;
          const angle = Math.random() * Math.PI * 2, force = s.speed * 2.5;
          p.vx = Math.cos(angle) * force; p.vy = Math.sin(angle) * force;
      }
  }

  function spawnBoomerangsAtPoint(cx, cy) {
      const s = getCommonSettings(), count = Math.floor(s.density * 0.2 * Math.max(0, s.scale)) + 1;
      for (let i = 0; i < count; i++) {
          const p = createParticle(cx, cy, { ...s, life: s.lifeFrames, animType: 'boomerang', particleType: 'boomerang', shape: 'boomerang' });
          if (!p) break;
          const angle = (Math.random() - 0.5) * Math.PI;
          p.vx = Math.cos(angle) * s.speed;
          p.vy = Math.sin(angle) * s.speed;
      }
  }

  function spawnLightningAtPoint(cx, cy) {
      const s = getCommonSettings();
      const count = Math.floor(s.density * 0.4 * Math.max(0, s.scale)) + 1;
      for (let i = 0; i < count; i++) {
          screenFlash = 0.8;
          const targetX = cx + (Math.random() - 0.5) * s.scale * 200;
          const targetY = cy + (Math.random() - 0.5) * s.scale * 200 + 100; // Slightly downward bias
          const bolt = createLightningBolt(cx, cy, targetX, targetY, s);
          lightningBolts.push(bolt);
          // Spawn spark particles at end
          const sparkCount = Math.floor(10 * s.density * s.scale);
          for (let j = 0; j < sparkCount; j++) {
              const p = createParticle(targetX, targetY, { ...s, life: s.lifeFrames * 0.3, animType: 'lightning', particleType: 'spark', shape: 'circle', size: s.size * 0.4 });
              if (!p) break;
              const angle = Math.random() * Math.PI * 2;
              const force = (0.5 + Math.random()) * s.speed * 0.8;
              p.vx = Math.cos(angle) * force;
              p.vy = Math.sin(angle) * force;
          }
      }
  }

  function createLightningBolt(startX, startY, endX, endY, s) {
    const segments = [];
    let currentX = startX;
    let currentY = startY;
    const dx = endX - startX;
    const dy = endY - startY;
    const length = Math.hypot(dx, dy);
    const steps = Math.floor(length / 10); // Segments every 10 pixels
    const branchChance = 0.2;
    const maxBranches = 3;

    segments.push([currentX, currentY]);

    for (let i = 0; i < steps; i++) {
      const t = i / steps;
      const targetX = startX + dx * t + (Math.random() - 0.5) * 20;
      const targetY = startY + dy * t + (Math.random() - 0.5) * 20;
      segments.push([targetX, targetY]);
      currentX = targetX;
      currentY = targetY;

      // Add branch
      if (Math.random() < branchChance && segments.length < maxBranches * steps) {
          const branchEndX = currentX + (Math.random() - 0.5) * length * 0.3;
          const branchEndY = currentY + (Math.random() - 0.5) * length * 0.3;
          const branch = createLightningBolt(currentX, currentY, branchEndX, branchEndY, s);
          lightningBolts.push({ ...branch, isBranch: true });
      }
    }

    segments.push([endX, endY]);

    return { segments, life: s.lifeFrames * 0.2, color: lerpColor(s.cStart, s.cEnd, Math.random()), opacity: 1, width: s.size * 0.5 };
  }

  function startParticleStream(el, pointerId){ streams.push({ el, pointerId, active:true }); }
  function stopParticleStream(pointerId){ streams.forEach(s=>{ if(s.pointerId===pointerId) s.active=false; }); }

  /* ---------- Wind & Physics ---------- */
  function syncWindControls(){ windDirectionRow.style.display = ['inward','push1','push2','vortex','crosswind'].includes(windPattern.value)?'none':'flex'; }
  function windField(p){ 
    if(!enableWind.checked) return {fx:0, fy:0, gScale:1, push:0}; 
    const intensity = (parseInt(windIntensity.value,10)||0)/100; if(intensity<=0) return {fx:0, fy:0, gScale:1, push:0}; 
    const base = 0.25 * (0.5 + intensity*1.5), w = windPattern.value; 
    const screenW = bubblesCanvas.width / (window.devicePixelRatio || 1);
    const screenH = bubblesCanvas.height / (window.devicePixelRatio || 1);
    if(w==='inward'){ const dx = screenW/2 - p.x, dy = screenH/2 - p.y, len = Math.hypot(dx,dy) || 1; return { fx: (dx/len)*base, fy: (dy/len)*base, gScale: Math.max(0.6, 1 - 0.35*intensity), push:0 }; }
    if(w==='push1' || w==='push2'){ const dx = p.x - (p.ox ?? p.x), dy = p.y - (p.oy ?? p.y), r = Math.hypot(dx,dy) || 1, rx = dx/r, ry = dy/r, tx = ry, ty = -rx, spiral = base * (w==='push2' ? 2.0 : 1.3), swirl = (0.7 + 0.5*Math.sin(t*1.3 + r*0.04)); return {fx: tx*spiral*swirl + rx*base*0.3, fy: ty*spiral*swirl + ry*base*0.3, gScale: Math.max(0.4, 1 - 0.55*intensity), push: (w==='push2' ? 0.022 : 0.012) * (0.5 + intensity*1.5)};}
    if(w==='vortex'){ const dx = screenW/2 - p.x, dy = screenH/2 - p.y; return { fx: dy * 0.005 * intensity, fy: -dx * 0.005 * intensity, gScale: 1, push: 0 }; }
    if(w==='crosswind'){ return { fx: base * 3, fy: 0, gScale: 1, push: 0 }; }
    const ang = (parseFloat(windDirection.value)||0) * Math.PI/180, dirx = Math.cos(ang), diry = Math.sin(ang);
    if(w==='steady'){ return { fx: dirx * base, fy: diry * base * 0.6, gScale: Math.max(0.7, 1 - 0.25*intensity), push:0 }; }
    if(w==='sine'){ const osc = Math.sin(t*1.5 + p.x*0.004 + p.y*0.003); return { fx: dirx * base * osc, fy: diry * base * osc, gScale: Math.max(0.75, 1 - 0.2*intensity), push:0 }; }
    if(w==='gusts'){ const g = (Math.sin(t*0.9 + p.x*0.01)+Math.sin(t*1.7+p.y*0.01)+Math.sin(t*0.53+2.1))/3, mag = (0.1 + 0.9*Math.abs(g)**2) * base * 1.5; return { fx: dirx * mag, fy: diry * mag * 0.7, gScale: Math.max(0.7, 1 - 0.22*intensity*(0.5+0.5*Math.abs(g))), push:0 }; }
    return {fx:0, fy:0, gScale:1, push:0}; 
  }

  /* ---------- Saved Patterns Logic ---------- */
  function renderPatternsList() {
      patternsList.innerHTML = savedPatterns.length === 0 ? '<div class="helper">No saved patterns yet.</div>' : '';
      savedPatterns.forEach(pattern => {
          const item = document.createElement('div'); item.className = 'pattern-item';
          item.innerHTML = `<span class="pattern-name">${pattern.name}</span>`;
          const loadBtn = document.createElement('button'); loadBtn.textContent = 'Load'; loadBtn.onclick = () => loadPattern(pattern.id);
          const exportBtn = document.createElement('button'); exportBtn.textContent = 'Export'; exportBtn.onclick = () => exportSinglePattern(pattern.id);
          const deleteBtn = document.createElement('button'); deleteBtn.textContent = 'Delete'; deleteBtn.className = 'delete-btn'; deleteBtn.onclick = () => deletePattern(pattern.id);
          const btnWrap = document.createElement('div'); btnWrap.className = 'row'; btnWrap.append(loadBtn, exportBtn, deleteBtn);
          item.append(btnWrap); patternsList.appendChild(item);
      });
  }
  function saveCurrentPattern() {
      const name = patternNameInput.value.trim(); if (!name) { alert('Please enter a name for the pattern.'); return; }
      const newPattern = { id: Date.now(), name: name, settings: { animationStyle: animationStyleSelect.value, animIntensity: animIntensity.value, emissionScale: emissionScale.value, holdRate: holdRate.value, bubbleSize: bubbleSize.value, bubbleSpeed: bubbleSpeed.value, bubbleLife: bubbleLifeSlider.value, shape: shapeSelect.value, bubbleOutline: bubbleOutline.value, colorMode: colorMode.value, bubbleColor: bubbleColor.value, bubbleStartColor: bubbleStartColor.value, bubbleEndColor: bubbleEndColor.value, enableWind: enableWind.checked, windPattern: windPattern.value, windIntensity: windIntensity.value, windDirection: windDirection.value, containParticles: containParticles.checked } };
      savedPatterns.push(newPattern); patternNameInput.value = ''; renderPatternsList(); saveData();
  }
  function loadPattern(id) {
      const pattern = savedPatterns.find(p => p.id === id); if (!pattern) return;

      if (!enableAnimations.checked) {
        enableAnimations.checked = true;
      }
      
      const s = pattern.settings;
      animationStyleSelect.value = s.animationStyle || 'bubbles'; animIntensity.value = s.animIntensity; emissionScale.value = s.emissionScale; holdRate.value = s.holdRate;
      bubbleSize.value = s.bubbleSize; bubbleSpeed.value = s.bubbleSpeed; bubbleLifeSlider.value = s.bubbleLife;
      shapeSelect.value = s.shape; bubbleOutline.value = s.bubbleOutline; colorMode.value = s.colorMode;
      bubbleColor.value = s.bubbleColor; bubbleStartColor.value = s.bubbleStartColor; bubbleEndColor.value = s.bubbleEndColor;
      enableWind.checked = s.enableWind; windPattern.value = s.windPattern; windIntensity.value = s.windIntensity; windDirection.value = s.windDirection;
      containParticles.checked = s.containParticles;
      applyAllSettings();
      
      populatePresetSelector(s.animationStyle);
      const loadedPatternOption = document.createElement('option');
      loadedPatternOption.value = pattern.id;
      loadedPatternOption.textContent = pattern.name;
      loadedPatternOption.selected = true;
      loadedPatternOption.id = 'loadedPatternOption';
      animationPresetSelect.insertBefore(loadedPatternOption, animationPresetSelect.firstChild);
  }
  function deletePattern(id) {
      if (confirm('Are you sure you want to delete this pattern?')) { savedPatterns = savedPatterns.filter(p => p.id !== id); renderPatternsList(); saveData(); }
  }
  function exportSinglePattern(id) {
    const pattern = savedPatterns.find(p => p.id === id);
    if (!pattern) { alert('Could not find the pattern to export.'); return; }
    const exportData = [pattern];
    const jsonString = JSON.stringify(exportData, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const safeName = pattern.name.replace(/[^a-z0-9]/gi, ' ').trim().replace(/\s+/g, '_').toLowerCase();
    a.download = `cc-pattern-${safeName}.json`;
    a.href = url;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  /* ---------- Ambiance Logic ---------- */
  function applyAmbianceSettings() {
      ctxAmbiance.clearRect(0, 0, ambianceCanvas.width, ambianceCanvas.height); // Clear canvas on change
      const isEnabled = enableAmbiance.checked;
      ambianceSettings.style.display = isEnabled ? 'flex' : 'none';
      if (!isEnabled) { ambianceParticles = []; return; }
      const effect = ambianceSelect.value;
      ambianceControls.style.display = effect !== 'none' ? 'block' : 'none';
      ['snow','orbs','starfield','matrix'].forEach(type => { document.getElementById(`${type}Controls`).style.display = effect === `${type === 'snow' ? 'snowflakes' : type}` ? 'flex' : 'none'; });
      if (effect === 'none') { ambianceParticles = []; return; }
      if (!ambianceParticles[0] || ambianceParticles[0].type !== effect) {
          ambianceParticles = [];
          const density = parseInt(document.getElementById(`${effect.replace('flakes','')}Density`).value, 10);
          for (let i = 0; i < density; i++) { ambianceParticles.push(createAmbianceParticle(effect, true)); }
      }
  }
  function createAmbianceParticle(type, isInitial = false) {
      const dpr = window.devicePixelRatio || 1, canvasW = ambianceCanvas.width / dpr, canvasH = ambianceCanvas.height / dpr;
      const p = { type, x: Math.random() * canvasW, y: isInitial ? Math.random() * canvasH : -30, z: isInitial ? Math.random() * 1000 : 1000, baseSize: 0.5 + Math.random() * 0.5, baseSpeed: 0.5 + Math.random() * 0.5, opacity: 0.3 + Math.random() * 0.6, sway: Math.random() * Math.PI * 2, swaySpeed: 0.01 + Math.random() * 0.01, swayAmplitude: 0.5 + Math.random() * 1.0, phase: Math.random() * Math.PI * 2, maxOpacity: 0.1 + Math.random() * 0.4 };
      if (type === 'orbs') p.y = isInitial ? Math.random() * canvasH : canvasH + 50;
      if (type === 'matrix') { p.x = Math.floor(Math.random() * canvasW / 10) * 10; p.length = Math.floor(10 + Math.random() * 20); p.chars = Array.from({length: p.length}, () => MATRIX_CHARS[Math.floor(Math.random() * MATRIX_CHARS.length)]); }
      if (type === 'starfield') { p.x = (Math.random() - 0.5) * canvasW * 2; p.y = (Math.random() - 0.5) * canvasH * 2; }
      return p;
  }
  function ambianceLoop() {
      const effect = ambianceSelect.value;
      if (!enableAmbiance.checked || effect === 'none') { if (ambianceParticles.length > 0) { ctxAmbiance.clearRect(0,0,ambianceCanvas.width,ambianceCanvas.height); ambianceParticles = []; } return; }
      const densityInput = document.getElementById(`${effect.replace('flakes','')}Density`);
      const targetCount = parseInt(densityInput.value, 10);
      while (ambianceParticles.length < targetCount) { ambianceParticles.push(createAmbianceParticle(effect)); } 
      if (ambianceParticles.length > targetCount) { ambianceParticles.length = targetCount; }
      const dpr = window.devicePixelRatio || 1, canvasW = ambianceCanvas.width / dpr, canvasH = ambianceCanvas.height / dpr;
      if (effect === 'matrix' || effect === 'starfield') { ctxAmbiance.fillStyle = document.documentElement.classList.contains('dark') ? 'rgba(11,13,16,0.1)' : 'rgba(240,242,245,0.1)'; ctxAmbiance.fillRect(0,0,canvasW,canvasH); } 
      else { ctxAmbiance.clearRect(0,0,canvasW,canvasH); }
      for (const p of ambianceParticles) {
          switch(effect) {
              case 'snowflakes': const snowSz = parseInt(snowSize.value,10), snowSpd = parseInt(snowSpeed.value,10)/50; p.y += p.baseSpeed * snowSpd; p.sway += p.swaySpeed; p.x += Math.sin(p.sway) * p.swayAmplitude; if (p.y > canvasH + 30) Object.assign(p, createAmbianceParticle(effect)); ctxAmbiance.fillStyle = 'rgba(255,255,255,1)'; ctxAmbiance.globalAlpha = p.opacity; ctxAmbiance.font = `${p.baseSize * snowSz}px Arial`; ctxAmbiance.fillText('❄', p.x, p.y); break;
              case 'orbs': const orbsSz = parseInt(orbsSize.value,10), orbsSpd = parseInt(orbsSpeed.value,10)/50; p.y -= p.baseSpeed * orbsSpd; p.phase += 0.02; if (p.y < -orbsSz) Object.assign(p, createAmbianceParticle(effect)); ctxAmbiance.fillStyle = orbsColor.value; ctxAmbiance.globalCompositeOperation = 'lighter'; ctxAmbiance.beginPath(); ctxAmbiance.globalAlpha = Math.abs(Math.sin(p.phase)) * p.maxOpacity; ctxAmbiance.arc(p.x, p.y, p.baseSize * orbsSz, 0, Math.PI * 2); ctxAmbiance.fill(); ctxAmbiance.globalCompositeOperation = 'source-over'; break;
              case 'matrix': const matrixSz = parseInt(matrixSize.value,10), matrixSpd = parseInt(matrixSpeed.value,10)/50; ctxAmbiance.font = `${matrixSz}px monospace`; for (let i=0; i<p.chars.length; i++) { const yPos = p.y + i*matrixSz; if (yPos > 0 && yPos < canvasH) { const mainColor = hexToRgb(matrixColor.value); ctxAmbiance.fillStyle = (i === p.chars.length - 1) ? '#fff' : `rgba(${mainColor.r},${mainColor.g},${mainColor.b},${i/p.length})`; ctxAmbiance.fillText(p.chars[i], p.x, yPos); } } p.y += p.baseSpeed * matrixSpd * (matrixSz/2); if (p.y > canvasH + p.length * matrixSz) Object.assign(p, createAmbianceParticle(effect)); break;
              case 'starfield': const starSz = parseInt(starfieldSize.value,10), starSpd = parseInt(starfieldSpeed.value,10)/50; p.z -= p.baseSpeed * starSpd * 2; if (p.z <= 0) Object.assign(p, createAmbianceParticle(effect)); const centerX = canvasW/2, centerY = canvasH/2, sx = p.x/(p.z*0.001) + centerX, sy = p.y/(p.z*0.001) + centerY, r = p.baseSize * (1 - p.z/1000) * (starSz/2); if (sx>0 && sx<canvasW && sy>0 && sy<canvasH) { ctxAmbiance.fillStyle = document.documentElement.classList.contains('dark') ? '#FFF' : '#000'; ctxAmbiance.globalAlpha = 1 - p.z/1000; ctxAmbiance.beginPath(); ctxAmbiance.arc(sx, sy, r, 0, Math.PI*2); ctxAmbiance.fill(); } break;
          }
      }
      ctxAmbiance.globalAlpha = 1.0;
  }
  
  /* ---------- Render Loop ---------- */
  function mainLoop(){
    ambianceLoop();
    if(enableAnimations.checked && enableEndless.checked && streams.length){
      streams = streams.filter(st=>st.active && document.body.contains(st.el));
      for(const st of streams){ if(particles.length>=PARTICLE_CAP) break; spawnParticlesFromEl(st.el); }
    }
    ctxBubbles.clearRect(0,0,bubblesCanvas.width,bubblesCanvas.height);
    const dpr = window.devicePixelRatio || 1, screenW = bubblesCanvas.width/dpr, screenH = bubblesCanvas.height/dpr;
    for(let i=particles.length-1;i>=0;i--){
      const p = particles[i], wf = windField(p);
      p.vx += wf.fx; p.vy += wf.fy;
      let gravity = 0.07 * (wf.gScale ?? 1);
      if (p.animType === 'splash') gravity *= 2.5;
      if (p.animType === 'fireworks' && p.particleType === 'spark') gravity *= 1.5;
      if (p.animType !== 'energy' && p.particleType !== 'boomerang') p.vy += gravity;
      if(wf.push){ p.pushScale = Math.min(3.0, p.pushScale + wf.push); } else { p.pushScale = Math.max(1, p.pushScale * 0.985); }
      if (p.animType === 'energy') { p.vx *= 0.92; p.vy *= 0.92; }
      if (p.particleType === 'boomerang') {
          p.rot += p.rotSpeed;
          const dx = p.ox - p.x, dy = p.oy - p.y, dist = Math.hypot(dx, dy);
          const returnForce = Math.min(0.1, dist / 5000);
          p.vx += dx * returnForce; p.vy += dy * returnForce;
          p.vx *= 0.98; p.vy *= 0.98;
      }
      p.x += p.vx; p.y += p.vy; p.life--;
      if (p.particleType === 'rocket' && p.vy >= 0) {
          const s = getCommonSettings(), count = Math.floor(s.density * 2 * Math.max(0, s.scale));
          for (let j = 0; j < count; j++) {
              const spark = createParticle(p.x, p.y, { ...s, life: s.lifeFrames * (0.5 + Math.random()*0.5), animType: 'fireworks', particleType: 'spark', shape: 'circle', size: s.size * 0.3 });
              if (!spark) break;
              const angle = Math.random() * Math.PI * 2, force = Math.random() * s.speed * 1.2;
              spark.vx = Math.cos(angle) * force; spark.vy = Math.sin(angle) * force;
          }
          p.life = 0;
      }
      if (containParticles.checked) {
          const scaledSize = p.size * p.pushScale, damp = -0.65;
          if (p.x > screenW - scaledSize) { p.x = screenW - scaledSize; p.vx *= damp; }
          if (p.x < scaledSize) { p.x = scaledSize; p.vx *= damp; }
          if (p.y > screenH - scaledSize) { p.y = screenH - scaledSize; p.vy *= damp; }
          if (p.y < scaledSize && p.vy < 0) { p.y = scaledSize; p.vy *= damp; }
      }
      const lifeRatio = p.life / (p.lifeMax || 1);
      ctxBubbles.globalAlpha = Math.max(0, lifeRatio < 0.25 ? lifeRatio / 0.25 : 1);
      let drawColor;
      if(p.mode==='fade'){ drawColor = lerpColor(p.colorStart,p.colorEnd, 1 - lifeRatio); }
      else if(p.mode==='tie'){ const hue = (Math.atan2(p.y-p.oy, p.x-p.ox)*180/Math.PI + Math.hypot(p.x-p.ox, p.y-p.oy)*0.8 + t*40 + p.tieJitter)%360; drawColor = hslToHex(hue, 90, 55); }
      else if(p.mode==='velocityHeatmap'){ const speed = Math.hypot(p.vx, p.vy); const hue = Math.max(0, 240 - speed * 12); drawColor = hslToHex(hue, 100, 55); }
      else if(p.mode==='screenSpace'){ const hue = ((p.x / screenW) * 180 + (p.y / screenH) * 180) % 360; drawColor = hslToHex(hue, 85, 60); }
      else if(p.mode==='party'){ const hue = (t * 300 + p.randomOffset) % 360; drawColor = hslToHex(hue, 100, 55); }
      else { drawColor = p.colorSingle; }
      ctxBubbles.fillStyle = drawColor; ctxBubbles.strokeStyle = drawColor;
      drawParticle(ctxBubbles, p);
      if(p.life<=0 || (!containParticles.checked && (p.x<-80 || p.x>screenW+80 || p.y<-120 || p.y>screenH+120))){ particles.splice(i,1); }
    }
    if (screenFlash > 0) {
        ctxBubbles.fillStyle = `rgba(255, 255, 255, ${screenFlash})`;
        ctxBubbles.fillRect(0, 0, bubblesCanvas.width, bubblesCanvas.height);
        screenFlash *= 0.85;
        if (screenFlash < 0.01) screenFlash = 0;
    }
    for (let i = lightningBolts.length - 1; i >= 0; i--) {
        const bolt = lightningBolts[i];
        drawLightningBolt(ctxBubbles, bolt);
        bolt.life--;
        bolt.opacity = bolt.life / (bolt.lifeMax || 12);
        if (bolt.life <= 0) lightningBolts.splice(i, 1);
    }
    if (gradientSpinToggle.checked && backgroundType.value === 'color' && colorWallpaperType.value === 'gradient') {
        gradientAnimationAngle = (gradientAnimationAngle + (parseFloat(gradientSpinSpeed.value)/100)*0.48)%360;
        const spread = parseInt(gradientSpread.value,10);
        document.body.style.backgroundImage = `linear-gradient(${gradientAnimationAngle}deg, ${wallpaperColor2.value} ${-spread}%, ${wallpaperColor3.value} ${100+spread}%)`;
        pct.gradientAngle.textContent = `${Math.round(gradientAnimationAngle)}°`;
    }
    t += 1/60;
    if (Math.floor(t*10) % 10 === 0) { currentAccentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim(); }
    requestAnimationFrame(mainLoop);
  }

  /* ---------- Event Wiring ---------- */
  window.addEventListener('resize', ()=>{ resizeCanvas(bubblesCanvas); resizeCanvas(ambianceCanvas); applyAmbianceSettings(); updateTabScrollIndicators(); });
  
  const animControls = [animIntensity, emissionScale, holdRate, bubbleSize, bubbleSpeed, bubbleLifeSlider, bubbleLifeSeconds, shapeSelect, bubbleOutline, colorMode, bubbleColor, bubbleStartColor, bubbleEndColor, enableWind, windPattern, windIntensity, windDirection, containParticles];
  
  animControls.forEach(el => {
    const eventType = (el.type === 'range' || el.type === 'number' || el.type === 'color') ? 'input' : 'change';
    
    el.addEventListener(eventType, () => {
        if (el.id === 'bubbleLifeSlider') {
            bubbleLifeSeconds.value = (el.value / 60).toFixed(1);
        } else if (el.id === 'bubbleLifeSeconds') {
            const seconds = Math.max(0.5, Math.min(20, parseFloat(el.value) || 0));
            bubbleLifeSlider.value = Math.round(seconds * 60);
        }

        if (el.id === 'colorMode') {
            syncColorControlVisibility();
        }

        updatePercentages();
        switchToCustomPreset();
    });

    el.addEventListener('change', saveData);
  });

  document.querySelectorAll('input[type=range]:not(#animIntensity, #emissionScale, #holdRate, #bubbleSize, #bubbleSpeed, #bubbleLifeSlider, #windIntensity, #windDirection)').forEach(el=> el.addEventListener('input', ()=>{ 
      if(el===glassOpacity) applyGlassOpacity(); 
      if(el===glassBlurSlider) applyGlassBlur();
      if(el===glassSaturationSlider) applyGlassSaturation();
      if(el===glassBorderSlider) applyGlassBorderOpacity();
      if(el===slideSpeed) applySlideSpeed();
      if(el===completionGlow || el===completionSpeed) applyCompletionEffectSettings();
      if(el===scanAngle) applyScanAngle();
      updatePercentages(); 
  }));
  
  scanAngle.addEventListener('change', saveData);

  animationStyleSelect.addEventListener('change', (e) => {
    populatePresetSelector(e.target.value);
    loadPreset(e.target.value, 0);
    saveData();
  });
  animationPresetSelect.addEventListener('change', (e) => {
    loadPreset(animationStyleSelect.value, e.target.value);
    saveData();
  });

  uiStyleSelect.addEventListener('change', () => {
      applyMaterialStyle();
      saveData();
  });

  [completionCheckedColor, completionUncheckedColor, completionInProgressColor].forEach(el => {
      const eventType = el.type === 'color' ? 'input' : 'change';
      el.addEventListener(eventType, () => {
          applyCompletionEffectSettings();
          saveData();
      });
  });
  completionResetBtn.addEventListener('click', () => {
      resetCompletionEffectSettings();
      saveData();
  });


  document.querySelectorAll('select:not(#animationStyleSelect, #animationPresetSelect, #shapeSelect, #bubbleOutline, #colorMode, #windPattern, #uiStyleSelect)').forEach(el=> el.addEventListener('change', ()=>{ 
      if(el===ambianceSelect) applyAmbianceSettings();
      if(el===backgroundType || el===colorWallpaperType) updateWallpaperUI();
      if(el===wallpaperFit){ const data = localStorage.getItem('mysparklist.wallpaperDataUrl'); if(data){ applyImageWallpaper(data, wallpaperFit.value); } } 
      if(el===clockPosition || el===clockDetail) applyClockSettings();
      saveData(); 
  }));

  [wallpaperColor1, wallpaperColor2, wallpaperColor3, orbsColor, matrixColor].forEach(el => el.addEventListener('input', ()=>{ if (el.id.startsWith('wallpaper')) applyColorWallpaper(); saveData(); }));
  [gradientAngle, gradientSpread].forEach(el => el.addEventListener('input', () => { if (el === gradientAngle && !gradientSpinToggle.checked) { gradientAnimationAngle = parseFloat(gradientAngle.value); } applyColorWallpaper(); updatePercentages(); saveData(); }));
  gradientSpinToggle.addEventListener('change', ()=>{ if(gradientSpinToggle.checked) { gradientAnimationAngle = parseFloat(gradientAngle.value); } else { gradientAngle.value = Math.round(gradientAnimationAngle); updatePercentages(); } gradientSpinControls.style.display = gradientSpinToggle.checked ? 'flex' : 'none'; saveData(); });
  enableClock.addEventListener('change', ()=>{ applyClockSettings(); saveData(); });
  [enableNaturalSlide, enableAmbiance, containParticles, enableCustomBackground, enableScanLine, document.getElementById('keepMenuExpanded')].forEach(el => {
    if (!el) return;
    el.addEventListener('change', ()=>{ 
      if (el.id === 'keepMenuExpanded' && !el.checked) {
        document.querySelectorAll('.menu-panel details').forEach(d => d.open = false);
      }
      if (el === enableAmbiance) applyAmbianceSettings(); 
      if (el === enableCustomBackground) syncCustomBackgroundVisibility();
      if (el === enableScanLine) syncScanAngleVisibility();
      saveData(); 
    })
  });
  simpleModeToggle.addEventListener('change', () => { const hasLaunched = localStorage.getItem('mysparklist.hasLaunchedBefore') === 'true'; updateSectionVisibility(hasLaunched); applySimplifiedMode(simpleModeToggle.checked); saveData(); });
  uiStyleResetBtn.addEventListener('click', ()=>{ resetUiStyleToDefault(); saveData(); });
  resetAnimBtn.addEventListener('click', ()=>{ resetAnimationToDefault(); saveData(); });
  panicResetBtn.addEventListener('click', panicReset);
  exportStateBtn.addEventListener('click', exportState);
  savePatternBtn.addEventListener('click', saveCurrentPattern);

  function renderWorkflowStages() {
    const currentList = lists[activeListIndex];
    if (currentList && currentList.type === 'Workflow') {
        secWorkflowStages.style.display = 'block';
        workflowStagesList.innerHTML = '';
        currentList.stages.forEach((stage, index) => {
            const stageEl = document.createElement('div');
            stageEl.className = 'row';
            stageEl.innerHTML = `
                <span style="flex-grow: 1; text-align: left;">${stage}</span>
                <button class="edit-stage-btn" data-index="${index}">Edit</button>
                <button class="delete-stage-btn" data-index="${index}" style="background: var(--danger);">Delete</button>
            `;
            workflowStagesList.appendChild(stageEl);
        });
    } else {
        secWorkflowStages.style.display = 'none';
    }
  }

  workflowStagesList.addEventListener('click', (e) => {
      const currentList = lists[activeListIndex];
      if (e.target.classList.contains('delete-stage-btn')) {
          const index = parseInt(e.target.dataset.index, 10);
          if (currentList.stages.length > 2) {
              currentList.stages.splice(index, 1);
              renderWorkflowStages();
              saveData();
          } else {
              alert('A workflow must have at least two stages.');
          }
      } else if (e.target.classList.contains('edit-stage-btn')) {
          const index = parseInt(e.target.dataset.index, 10);
          const newName = prompt('Enter new stage name:', currentList.stages[index]);
          if (newName && newName.trim()) {
              currentList.stages[index] = newName.trim();
              renderWorkflowStages();
              saveData();
          }
      }
  });

  addStageBtn.addEventListener('click', () => {
      const currentList = lists[activeListIndex];
      const name = newStageName.value.trim();
      if (name) {
          currentList.stages.push(name);
          newStageName.value = '';
          renderWorkflowStages();
          saveData();
      }
  });

  exportPatternsBtn.addEventListener('click', () => {
    if (savedPatterns.length === 0) { alert('There are no saved patterns to export.'); return; }
    const jsonString = JSON.stringify(savedPatterns, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const date = new Date().toISOString().slice(0, 10);
    a.download = `mysparklist-patterns-${date}.json`;
    a.href = url;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });
  importPatternsBtn.addEventListener('click', () => { importFile.click(); });
  importFile.addEventListener('change', (event) => {
    const file = event.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const imported = JSON.parse(e.target.result);
            if (!Array.isArray(imported) || (imported.length > 0 && (!imported[0].name || !imported[0].settings))) { throw new Error('Invalid pattern file format.'); }
            if (imported.length === 0) { alert('The selected file contains no patterns.'); return; }
            if (confirm(`This will add ${imported.length} pattern(s) from the file to your current list. Continue?`)) {
                const newPatterns = imported.map(p => ({ ...p, id: p.id || Date.now() + Math.random() }));
                savedPatterns.push(...newPatterns);
                renderPatternsList(); saveData();
                alert('Patterns imported successfully!');
            }
        } catch (error) { alert('Failed to import patterns. The file may be corrupt or in the wrong format.\n\nError: ' + error.message); } 
        finally { importFile.value = ''; }
    };
    reader.readAsText(file);
  });
  wallpaperFile.addEventListener('change', ()=>{
    const file = wallpaperFile.files && wallpaperFile.files[0]; if(!file) return;
    
    const MAX_SIZE = 5 * 1024 * 1024; // 5 MB
    if (file.size > MAX_SIZE) {
        alert('Image is too large (over 5 MB). Please choose a smaller file.');
        wallpaperFile.value = '';
        return;
    }

    if(!/image\/(jpeg|png|webp)/i.test(file.type)){ alert('Unsupported image type.'); wallpaperFile.value=''; return; }
    const reader = new FileReader();
    reader.onload = (e)=>{ localStorage.setItem('mysparklist.wallpaperDataUrl', e.target.result); updateWallpaper(); saveData(); };
    reader.readAsDataURL(file);
  });
  wallpaperResetBtn.addEventListener('click', ()=>{ localStorage.removeItem('mysparklist.wallpaperDataUrl'); wallpaperFile.value = ''; updateWallpaper(); saveData(); });
  function syncAnimationSettingsUI() {
      const style = animationStyleSelect.value;
      const isBoomerang = style === 'boomerang';
      const isLightning = style === 'lightning';
      shapeSelectRow.style.display = (isBoomerang || isLightning) ? 'none' : 'flex';
      bubbleOutlineRow.style.display = style === 'bubbles' ? 'flex' : 'none';
      
      if (style === 'splash') { bubbleSpeedLabel.textContent = 'Force'; animIntensityLabel.textContent = 'Density'; emissionScaleLabel.textContent = 'Emission Scale'; bubbleSizeLabel.textContent = 'Size'; }
      else if (style === 'energy') { bubbleSpeedLabel.textContent = 'Velocity'; animIntensityLabel.textContent = 'Density'; emissionScaleLabel.textContent = 'Emission Scale'; bubbleSizeLabel.textContent = 'Size'; }
      else if (isBoomerang) { bubbleSpeedLabel.textContent = 'Throw Speed'; animIntensityLabel.textContent = 'Count'; emissionScaleLabel.textContent = 'Emission Scale'; bubbleSizeLabel.textContent = 'Size'; }
      else if (isLightning) { bubbleSpeedLabel.textContent = 'Strike Speed'; animIntensityLabel.textContent = 'Bolt Count'; emissionScaleLabel.textContent = 'Branch Spread'; bubbleSizeLabel.textContent = 'Bolt Thickness'; }
      else { bubbleSpeedLabel.textContent = 'Pop'; animIntensityLabel.textContent = 'Density'; emissionScaleLabel.textContent = 'Emission Scale'; bubbleSizeLabel.textContent = 'Size'; }
  }

  /* ---------- List Creation Prompt Logic ---------- */
  function showListCreationPrompt(isFirstLaunch, callback) {
    listCreationCallback = callback;

    if (isFirstLaunch) {
        welcomeTitle.textContent = "Welcome to MySparkList!";
        welcomeSubText.textContent = "What kind of list are you creating today?";
        closePromptBtn.style.display = 'none';
    } else {
        welcomeTitle.textContent = "Create a New List";
        welcomeSubText.textContent = "Select a type for your new list.";
        closePromptBtn.style.display = 'block';
    }
    
    listTypeStep.style.display = 'block';
    listNameStep.style.display = 'none';
    welcomeOverlay.classList.add('visible');
    document.addEventListener('keydown', handlePromptEscape);
  }

  function hideListCreationPrompt() {
      welcomeOverlay.classList.remove('visible');
      document.removeEventListener('keydown', handlePromptEscape);
  }

  function handlePromptEscape(e) {
    if (e.key === 'Escape') {
      hideListCreationPrompt();
    }
  }

  closePromptBtn.onclick = hideListCreationPrompt;

  listTypeOptions.forEach(option => {
    option.addEventListener('click', () => {
      temp_listType = option.dataset.type;
      newListNameInput.value = temp_listType;
      listTypeStep.style.display = 'none';
      listNameStep.style.display = 'block';
      newListNameInput.focus();
      newListNameInput.select();
    });
  });

  backToListTypeBtn.addEventListener('click', () => {
    listNameStep.style.display = 'none';
    listTypeStep.style.display = 'block';
  });

  function handleCreateList() {
      const name = newListNameInput.value.trim();
      if (name && temp_listType) {
          const newListData = { name, type: temp_listType, items: [] };
          if (temp_listType === 'Workflow') {
              newListData.stages = ['Pending', 'In Progress', 'Complete'];
          }
          if (listCreationCallback) {
              listCreationCallback(newListData);
          }
          hideListCreationPrompt();
          listCreationCallback = null;
          temp_listType = '';
      }
  }

  createListBtn.addEventListener('click', handleCreateList);
  newListNameInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        handleCreateList();
    }
  });

  /* ---------- Welcome Back Logic ---------- */
  resumeBtn.addEventListener('click', () => {
      welcomeBackOverlay.classList.remove('visible');
      saveData();
  });

  createNewBtn.addEventListener('click', () => {
      welcomeBackOverlay.classList.remove('visible');
      addTabBtn.click();
      saveData();
  });

  startFreshBtn.addEventListener('click', () => {
      panicReset(); // The confirmation is inside panicReset
  });

  hideWelcomeBack.addEventListener('change', saveData);

  /* ---------- Multi-list & UI Logic ---------- */
    const placeholders = {
        "General Tasks": "Add a task...",
        "Milestones": "Add a milestone...",
        "Educational": "Add a learning goal...",
        "Call Behaviors": "Add a checkpoint...",
        "Workflow": "Add a workflow step..."
    };

    function updateUIForActiveList() {
        if (lists.length === 0) {
            showListCreationPrompt(true, (newListData) => {
                lists.push(newListData);
                activeListIndex = 0;
                updateUIForActiveList();
                saveData();
            });
            document.getElementById('app').style.display = 'none';
            return;
        }

        document.getElementById('app').style.display = 'flex';

        if (activeListIndex >= lists.length) {
            activeListIndex = lists.length - 1;
        }
        if (activeListIndex < 0) {
            activeListIndex = 0;
        }

        const currentList = lists[activeListIndex];
        if (!currentList) return;

        input.placeholder = placeholders[currentList.type] || "Add an item...";

        clearControlsContainer.innerHTML = '';
        const listType = currentList.type;
        const isStandardList = ['General Tasks', 'Milestones', 'Educational'].includes(listType);

        if (isStandardList) {
            const clearChecksBtn = document.createElement('button');
            clearChecksBtn.id = 'clearChecksBtn';
            clearChecksBtn.className = 'ctrl clear-checks-btn';
            clearChecksBtn.innerHTML = '<strong>Clear</strong>';
            clearChecksBtn.onclick = () => animateAndClearChecks();
            clearControlsContainer.appendChild(clearChecksBtn);

            const clearListBtn = document.createElement('button');
            clearListBtn.id = 'clearBtn';
            clearListBtn.className = 'ctrl clear-list-btn-red';
            clearListBtn.innerHTML = '✖';
            clearListBtn.onclick = () => animateAndClearList(true);
            clearControlsContainer.appendChild(clearListBtn);

        } else if (listType === 'Call Behaviors') {
            const newCallBtn = document.createElement('button');
            newCallBtn.id = 'clearBtn';
            newCallBtn.className = 'ctrl clear-btn';
            newCallBtn.innerHTML = '<strong>New Call</strong>';
            newCallBtn.onclick = () => animateAndClearList(false);
            clearControlsContainer.appendChild(newCallBtn);
        } else {
            const defaultClearBtn = document.createElement('button');
            defaultClearBtn.id = 'clearBtn';
            defaultClearBtn.className = 'ctrl clear-btn';
            defaultClearBtn.innerHTML = '✖';
            defaultClearBtn.onclick = () => animateAndClearList(true);
            clearControlsContainer.appendChild(defaultClearBtn);
        }

        renderList();
        renderTabs();
        renderWorkflowStages();

        // Show/hide the 'In Progress' color setting
        completionInProgressColorRow.style.display = currentList.type === 'Workflow' ? 'flex' : 'none';
    }

    function animateAndClearChecks() {
        const checkedItems = list.querySelectorAll('.item.done');
        if (checkedItems.length === 0) return;

        checkedItems.forEach(li => {
            li.classList.remove('done', 'pulse', 'scan-effect-done');
            li.classList.add('warn');
            if (enableScanLine.checked) {
                li.classList.add('scan-effect-warn');
            }
        });

        setTimeout(() => {
            lists[activeListIndex].items.forEach(item => {
                if (item.status === 'complete') {
                    item.status = 'pending';
                }
            });
            renderList();
            saveData();
        }, parseInt(completionSpeed.value, 10) + 50);
    }
    
    function animateAndClearList(isFullClear) {
      if(isFullClear && !confirm("Are you sure you want to clear all items from this list?")) {
        return;
      }
        const checkedItems = list.querySelectorAll('.item.done');
        const animationDuration = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--completion-duration'), 10) || 900;
        
        if (checkedItems.length > 0) {
            checkedItems.forEach(li => {
                li.classList.remove('done', 'pulse', 'scan-effect-done');
                li.classList.add('warn');
                if (enableScanLine.checked) {
                    li.classList.add('scan-effect-warn');
                }
            });
        }

        setTimeout(() => {
            const currentListType = lists[activeListIndex]?.type;

            if (isFullClear) {
                 lists[activeListIndex].items = [];
            } else { 
                lists[activeListIndex].items.forEach(item => item.status = 'pending');
            }

            renderList();
            saveData();

            if (currentListType === 'Call Behaviors') {
                seconds=0; counterPaused=false; updateSecondCounter(); stopCounter(); startCounter();
            }
        }, checkedItems.length > 0 ? animationDuration : 0);
    }


  function renderList() {
    list.innerHTML = '';
    const currentList = lists[activeListIndex];
    if (currentList && currentList.items) {
      currentList.items.forEach(item => {
        addItem(item.text, item.status, true);
      });
    }
  }
  
  function triggerTabRename(index) {
    if (index < 0 || index >= lists.length) return;
    const originalName = lists[index].name;
    const newName = prompt(`Rename the list "${originalName}":`, originalName);
    
    if (newName && newName.trim() && newName.trim() !== originalName) {
        lists[index].name = newName.trim();
        renderTabs();
        saveData();
    }
  }

  function renderTabs() {
    tabsContainer.innerHTML = '';
    lists.forEach((listData, index) => {
      const tab = document.createElement('div');
      tab.className = 'tab';
      tab.textContent = listData.name;
      if (index === activeListIndex) {
        tab.classList.add('active');
      }
      tab.dataset.index = index;
      
      if (listData.color) {
          tab.style.backgroundColor = listData.color;
          const useWhiteText = isColorDark(listData.color);
          tab.style.color = useWhiteText ? '#ffffff' : 'var(--text)';
          tab.style.borderColor = listData.color;
          if (index === activeListIndex) {
              tab.style.color = '#ffffff';
          }
      } else if (index === activeListIndex) {
          tab.style.backgroundColor = '';
          tab.style.color = '';
          tab.style.borderColor = '';
      }
      
      tab.addEventListener('click', () => {
          clearTimeout(tabClickTimer);
          tabClickTimer = setTimeout(() => {
            if (activeListIndex !== index) {
              activeListIndex = index;
              updateUIForActiveList();
              saveData();
            }
          }, DBL_CLICK_DELAY);
      });

      tab.addEventListener('dblclick', (e) => {
        clearTimeout(tabClickTimer);
        e.preventDefault();
        contextListIndex = index;
        showContextMenu(e.target);
      });

      tab.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        contextListIndex = index;
        showContextMenu(e.target);
      });

      tabsContainer.appendChild(tab);
    });
    
    updateTabScrollIndicators();
  }

  addTabBtn.addEventListener('click', () => {
    showListCreationPrompt(false, (newListData) => {
        lists.push(newListData);
        activeListIndex = lists.length - 1;
        updateUIForActiveList();
        saveData();
        setTimeout(() => {
            const newTabEl = tabsContainer.querySelector(`.tab:last-child`);
            if (newTabEl) {
                newTabEl.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'end' });
            }
        }, 100);
    });
  });

  /* ---------- Tab Management & Scrolling Logic ---------- */
  function updateTabScrollIndicators() {
    const el = tabsContainer;
    const wrapper = el.parentElement;
    wrapper.classList.remove('fade-left', 'fade-right', 'fade-both');

    const hasOverflow = el.scrollWidth > el.clientWidth;
    if (!hasOverflow) return;

    const isAtStart = el.scrollLeft < 5;
    const isAtEnd = el.scrollLeft >= (el.scrollWidth - el.clientWidth - 5);

    if (!isAtStart && !isAtEnd) {
        wrapper.classList.add('fade-both');
    } else if (!isAtStart) {
        wrapper.classList.add('fade-left');
    } else if (!isAtEnd) {
        wrapper.classList.add('fade-right');
    }
  }

  tabsContainer.addEventListener('scroll', () => {
    hideContextMenu();
    updateTabScrollIndicators();
  });
  
  tabsContainer.addEventListener('wheel', (e) => {
      if (e.deltaY === 0) return;
      e.preventDefault();
      tabsContainer.scrollLeft += e.deltaY;
  }, { passive: false });

  function deleteList(index) {
    if (index < 0 || index >= lists.length) return;
    
    const listNameToDelete = lists[index].name;
    if (confirm(`Are you sure you want to permanently delete the list "${listNameToDelete}"? This action cannot be undone.`)) {
        lists.splice(index, 1);
        
        if (activeListIndex >= index && activeListIndex > 0) {
            activeListIndex--;
        }
        
        updateUIForActiveList();
        saveData();
    }
  }

  function handleContextMenuEscape(e) {
    if (e.key === 'Escape') {
      hideContextMenu();
    }
  }

  function showContextMenu(targetElement) {
    const menu = tabContextMenu;
    const tabRect = targetElement.getBoundingClientRect();
    
    menu.style.visibility = 'hidden';
    menu.style.display = 'flex';
    
    setTimeout(() => {
        const menuHeight = menu.offsetHeight;
        const menuWidth = menu.offsetWidth;
        const screenWidth = window.innerWidth;

        let top = tabRect.top - menuHeight - 8;
        let left = tabRect.left;

        if (top < 10) {
            top = tabRect.bottom + 8;
        }
        if (left < 10) {
            left = 10;
        }
        if (left + menuWidth > screenWidth - 10) {
            left = screenWidth - menuWidth - 10;
        }
        
        menu.style.left = `${left}px`;
        menu.style.top = `${top}px`;
        menu.style.visibility = 'visible';
        menu.classList.add('visible');
        
        document.addEventListener('keydown', handleContextMenuEscape, { once: true });
    }, 0);
  }


  function hideContextMenu() {
    tabContextMenu.classList.remove('visible');
    contextListIndex = -1;
    document.removeEventListener('keydown', handleContextMenuEscape);
  }

  document.addEventListener('click', (e) => {
      if (!tabContextMenu.contains(e.target) && !e.target.closest('.tab')) {
          hideContextMenu();
      }
  });

  ctxRename.addEventListener('click', () => {
    if (contextListIndex !== -1) {
        triggerTabRename(contextListIndex);
    }
    hideContextMenu();
  });

  function resetWorkflowStagesToDefault() {
    const currentList = lists[activeListIndex];
    if (currentList && currentList.type === 'Workflow') {
        if (confirm('Are you sure you want to reset the stages for this list to the default? This will reset tasks in custom stages to the first stage.')) {
            currentList.stages = ['Pending', 'In Progress', 'Complete'];
            
            currentList.items.forEach(item => {
                if (!currentList.stages.includes(item.status)) {
                    item.status = currentList.stages[0]; // Reset to first stage
                }
            });

            renderWorkflowStages();
            renderList(); // Re-render the main list to show status changes
            saveData();
        }
    }
  }
  resetStagesBtn.addEventListener('click', resetWorkflowStagesToDefault);

  ctxSetColor.addEventListener('click', () => {
    ctxColorInput.click();
  });

  ctxColorInput.addEventListener('input', (e) => {
    if (contextListIndex !== -1) {
        lists[contextListIndex].color = e.target.value;
        renderTabs();
        saveData();
    }
  });
  ctxColorInput.addEventListener('change', hideContextMenu);


  ctxDelete.addEventListener('click', () => {
    if (contextListIndex !== -1) {
        deleteList(contextListIndex);
    }
    hideContextMenu();
  });

  shareBtn.addEventListener('click', () => generateShareLink(activeListIndex));
  ctxShare.addEventListener('click', () => {
    if (contextListIndex !== -1) {
        generateShareLink(contextListIndex);
    }
    hideContextMenu();
  });


  /* ---------- Init ---------- */
  resizeCanvas(bubblesCanvas); resizeCanvas(ambianceCanvas);
  loadData(); startCounter(); requestAnimationFrame(mainLoop);
})();
</script>
</body>
</html>
